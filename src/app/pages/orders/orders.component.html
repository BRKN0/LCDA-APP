<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<!-- Indicador de carga -->
<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando pedidos...</p>
</div>

<!-- Filters -->
<div
  *ngIf="userRole == 'admin' || userRole == 'scheduler'"
  class="flex justify-between items-center mb-4 mt-4 ml-2"
>
  <div class="flex space-x-2">
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showPrints"
        (change)="updateFilteredOrders()"
      />
      Impresiones
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showCuts"
        (change)="updateFilteredOrders()"
      />
      Cortes
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showSales"
        (change)="updateFilteredOrders()"
      />
      Ventas
    </label>
    <label>
      <input
        type="checkbox"
        [checked]="vitrineFilterMode !== 'exclude'"
        (change)="toggleVitrineFilter($event)"
      />
      Vitrina
    </label>
    <label>
      <input type="checkbox" 
      [(ngModel)]="showInProgress" 
      (change)="updateFilteredOrders()" />
      En proceso
    </label>
    <label>
      <input type="checkbox" 
      [(ngModel)]="showFinished" 
      (change)="updateFilteredOrders()" />
      Terminado
    </label>
    <label>
      <input type="checkbox" 
      [(ngModel)]="showDelivered" 
      (change)="updateFilteredOrders()" />
      Entregado
    </label>
  </div>
  <div class="flex space-x-2 mr-4">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="toggleAddOrderForm()"
    >
      <svg
        class="w-5 h-5 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12.75 9C12.75 8.58579 12.4142 8.25 12 8.25C11.5858 8.25 11.25 8.58579 11.25 9L11.25 11.25H9C8.58579 11.25 8.25 11.5858 8.25 12C8.25 12.4142 8.58579 12.75 9 12.75H11.25V15C11.25 15.4142 11.5858 15.75 12 15.75C12.4142 15.75 12.75 15.4142 12.75 15L12.75 12.75H15C15.4142 12.75 15.75 12.4142 15.75 12C15.75 11.5858 15.4142 11.25 15 11.25H12.75V9Z"
          fill="#ffffff"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
          fill="#ffffff"
        />
      </svg>
      <span>Añadir</span>
    </button>
    <button class="btn-clear" (click)="clearFilters()">Limpiar</button>
  </div>
</div>

<!-- Search bars -->
<div class="flex items-center justify-center py-4 space-x-4 top-5">
  <!-- Buscar por nombre de cliente -->
  <div class="relative w-full max-w-md">
    <input
      type="text"
      placeholder="Buscar por nombre de cliente..."
      [(ngModel)]="searchByNameQuery"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
      (input)="updateFilteredOrders()"
    />
  </div>
  <!-- Buscar por número de pedido -->
  <div class="relative w-full max-w-md">
    <input
      type="text"
      placeholder="Buscar pedido por número..."
      [(ngModel)]="searchQuery"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
    <button
      class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-700 w-auto"
      (click)="onSearch()"
    >
      Buscar
    </button>
  </div>
</div>
<div class="flex items-center space-x-4">
  <div>
    <label for="startDate" class="mr-2 font-semibold">Desde:</label>
    <input
      type="date"
      id="startDate"
      [(ngModel)]="startDate"
      (ngModelChange)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
    <input
      type="date"
      id="endDate"
      [(ngModel)]="endDate"
      (ngModelChange)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label class="font-semibold mr-2">Agendado por:</label>
    <select
      [(ngModel)]="selectedScheduler"
      (change)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option value="">-- Todos --</option>
      <option *ngFor="let u of getUniqueSchedulers()" [value]="u">
        {{ u }}
      </option>
    </select>
  </div>
</div>

<!-- Orders Table -->
<div *ngIf="!loading" class="mt-4">
  <table class="table-std">
    <thead>
      <ng-container
        *ngIf="
          userRole === 'admin' || userRole === 'scheduler';
          else notAdminHeader
        "
      >
        <tr>
          <th class="table-column-std">Código</th>
          <th class="table-column-std">Tipo</th>
          <th class="table-column-std">Cliente</th>
          <th class="table-column-std">Atención</th>
          <th class="table-column-std">Estado de pago</th>
          <th class="table-column-std">Estado de trabajo</th>
          <th class="table-column-std">Fecha</th>
          <th class="table-column-std">Fecha de Entrega</th>
          <th class="table-column-std">Días Restantes</th>
          <th class="table-column-std">Total</th>
          <th class="table-column-std">Confirmación</th>
          <th class="table-column-std">Acción</th>
        </tr>
      </ng-container>
      <ng-template #notAdminHeader>
        <tr>
          <th class="table-column-std">Código</th>
          <th class="table-column-std">Tipo</th>
          <th class="table-column-std">Cliente</th>
          <th class="table-column-std">Estado de trabajo</th>
          <th class="table-column-std">Fecha</th>
          <th class="table-column-std">Fecha de Entrega</th>
          <th class="table-column-std">Días Restantes</th>
          <th class="table-column-std">Acción</th>
          <th class="table-column-std">Confirmación de Orden</th>
        </tr>
      </ng-template>
    </thead>

    <tbody>
      <ng-container
        *ngIf="
          userRole === 'admin' || userRole === 'scheduler';
          else notAdminBody
        "
      >
        <tr *ngFor="let order of paginatedOrders">
          <td>{{ order.code }}</td>
          <td>
            <span>
              {{
                order.secondary_process
                  ? (
                      order.order_type === 'laser'
                        ? 'Corte / Impresión'
                        : order.order_type === 'print'
                        ? 'Impresión / Corte'
                        : 'Ventas'
                    )
                  : (
                      order.order_type === 'print'
                        ? 'Impresiones'
                        : order.order_type === 'laser'
                        ? 'Cortes'
                        : order.order_type === 'sales'
                        ? 'Ventas'
                        : 'Desconocido'
                    )
              }}
            </span>

            <!-- Badge Vitrina -->
            <span
              *ngIf="order.order_type === 'sales' && order.is_vitrine"
              class="px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"
            >
              Vitrina
            </span>
          </td>
          <td>{{ order.name }}</td>
          <td>
            {{ order.scheduler }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_payment_status === 'upToDate',
              'text-red-600': order.order_payment_status === 'overdue'
            }"
          >
            {{
              order.order_payment_status === "upToDate"
                ? "Al Día"
                : order.order_payment_status === "overdue"
                ? "En Mora"
                : "Desconocido"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'delivered',
              'text-blue-600': order.order_completion_status === 'inProgress',
              'text-purple-400': order.order_completion_status === 'finished'
            }"
          >
            <select
              class="border rounded p-1"
              [(ngModel)]="order.order_completion_status"
              (change)="toggleOrderCompletionStatus(order)"
            >
              <option value="finished">Terminado</option>
              <option value="delivered">Entregado</option>
              <option value="inProgress">En proceso</option>
            </select>
          </td>
          <td>
            <div>
              {{ order.created_at | date : "dd-MM-yyyy" }}
            </div>
            <small *ngIf="order.created_time">
              {{ order.created_time.slice(0, 5) }}
            </small>
          </td>
          <td>
            {{
              order.delivery_date
                ? (order.delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </td>
          <td [ngClass]="getDaysRemainingClass(order)">
            {{ getDaysRemainingLabel(order) }}
          </td>
          <td>{{ order.total  | number:'1.2-2'}}</td>
          <td
            [ngClass]="{
              'text-green-600': order.order_confirmed_status === 'confirmed',
              'text-orange-400': order.order_confirmed_status === 'notConfirmed'
            }"
          >
            {{
              order.order_confirmed_status === "confirmed"
                ? "Confirmado"
                : order.order_confirmed_status === "notConfirmed"
                ? "En espera"
                : "Desconocido"
            }}
          </td>
          <td>
            <button class="btn-details" (click)="selectOrder(order)">
              Detalles
            </button>
            <button class="btn-edit" (click)="editOrder(order)">Editar</button>
            <button
              *ngIf="userRole == 'admin' || userRole === 'scheduler'"
              class="btn-delete"
              (click)="deleteOrder(order)"
            >
              Eliminar
            </button>
          </td>
        </tr>
      </ng-container>

      <ng-template #notAdminBody>
        <tr *ngFor="let order of paginatedOrders">
          <td>{{ order.code }}</td>
          <td>
            {{
              order.order_type === "print"
                ? "Impresiones"
                : order.order_type === "laser"
                ? "Cortes"
                : order.order_type === "sales"
                ? "Ventas"
                : "Desconocido"
            }}
          </td>
          <td>{{ order.name }}</td>

          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'delivered',
              'text-blue-600': order.order_completion_status === 'inProgress',
              'text-purple-400': order.order_completion_status === 'finished'
            }"
          >
            <select
              class="border rounded p-1"
              [(ngModel)]="order.order_completion_status"
              (change)="toggleOrderCompletionStatus(order)"
              [disabled]="!!(
                order.secondary_process &&
                !order.secondary_completed &&
                order.order_completion_status === 'inProgress'
              )"
              title="Este pedido tiene un proceso secundario pendiente."
            >
              <option value="finished">Terminado</option>
              <option value="delivered">Entregado</option>
              <option value="inProgress">En proceso</option>
            </select>
          </td>
          <td>{{ order.created_at | date : "dd-MM-yyyy" }}</td>
          <td>
            {{
              order.delivery_date
                ? (order.delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </td>
          <td
            [ngClass]="{
              'text-red-500': isDeliveryOverdue(order),
              'text-yellow-500': isDeliveryLastDay(order),
              'text-green-500': hasMultipleDeliveryDays(order)
            }"
          >
            {{ getFormattedDeliveryTime(order) }}
          </td>
          <td>
            <button class="btn-details" (click)="selectOrder(order)">
              Detalles
            </button>
            <button class="btn-edit" (click)="editOrder(order)">Editar</button>
            <button
              *ngIf="userRole == 'admin' || userRole === 'scheduler'"
              class="btn-delete"
              (click)="deleteOrder(order)"
            >
              Eliminar
            </button>
          </td>
          <td>
            <label>
              <input
                type="checkbox"
                [checked]="order.order_confirmed_status === 'confirmed'"
                (change)="toggleOrderConfirmedStatus(order)"
              />
            </label>
          </td>
        </tr>
      </ng-template>
    </tbody>
  </table>
</div>

<!-- Mensaje de no resultados para búsqueda por nombre -->
<div *ngIf="noResultsFound" class="p-4 text-center text-gray-600">
  <p>No hay coincidencias con la búsqueda.</p>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedOrder()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      ⇐
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedOrder()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700">
      Página {{ currentPage }} de {{ totalPages }}
    </span>
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedOrder()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedOrder()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      ⇒
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedOrder()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Show details of the selected order -->
<div
  *ngIf="
    selectedOrderDetails && selectedOrderDetails.length > 0 && !loadingDetails
  "
  class="modal-overlay"
>
  <div class="modal-content">
    <h2 class="text-xl font-bold">Detalles de Pedido</h2>
    <!-- Printable Invoice Layout -->
    <div class="p-4 border border-gray-300 bg-white invoice-details">
      <div class="flex justify-between mb-4">
        <div>
          <h3 class="font-semibold text-lg">
            Pedido N°: {{ selectedOrderDetails[0].code }}
          </h3>
          <p>
            <strong>Fecha:</strong>
            {{ selectedOrderDetails[0].created_at | date : "dd-MM-yyyy" }}
            {{ selectedOrderDetails[0].created_time?.slice(0, 5) }}
          </p>
          <p>
            <strong>Fecha de Entrega:</strong>
            {{
              selectedOrderDetails[0].delivery_date
                ? (selectedOrderDetails[0].delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Estado de trabajo:</strong>
            {{
              selectedOrderDetails[0].order_completion_status === "finished"
                ? "Completado"
                : selectedOrderDetails[0].order_completion_status ===
                  "delivered"
                ? "Entregado"
                : selectedOrderDetails[0].order_completion_status ===
                  "inProgress"
                ? "En proceso"
                : "Desconocido"
            }}
          </p>
          <div
            *ngIf="selectedOrderDetails[0]?.secondary_process"
            class="mt-2 text-sm"
          >
            <span class="font-semibold text-gray-700">
              Proceso secundario:
            </span>

            <span
              [ngClass]="{
                'text-green-600 font-semibold': selectedOrderDetails[0].secondary_completed,
                'text-orange-500 font-semibold': !selectedOrderDetails[0].secondary_completed
              }"
            >
              {{
                selectedOrderDetails[0].secondary_completed
                  ? 'Completado'
                  : 'Pendiente'
              }}
            </span>
          </div>
          <!-- Botón para marcar proceso secundario como terminado -->
          <div
            *ngIf="
              selectedOrderDetails[0]?.secondary_process &&
              !selectedOrderDetails[0]?.secondary_completed &&
              (
                (userRole === 'cuts_employee' &&
                  selectedOrderDetails[0].secondary_process === 'laser') ||
                (userRole === 'prints_employee' &&
                  selectedOrderDetails[0].secondary_process === 'print')
              )
            "
            class="mt-3"
          >
            <button
              class="btn-success text-xs px-3 py-1"
              (click)="markSecondaryCompleted(selectedOrderDetails[0])"
            >
              Marcar proceso secundario como terminado
            </button>
          </div>
          <p>
            <strong>Confirmación del pedido:</strong>
            {{
              selectedOrderDetails[0].order_confirmed_status === "confirmed"
                ? "Confirmado"
                : selectedOrderDetails[0].order_confirmed_status ===
                  "notConfirmed"
                ? "Por Confirmar"
                : "Desconocido"
            }}
          </p>
          <p>
            <strong>Estado de entrega:</strong>
            {{
              selectedOrderDetails[0].order_completion_status === "finished"
                ? "Completado"
                : selectedOrderDetails[0].order_delivery_status === "onTime"
                ? "A tiempo"
                : selectedOrderDetails[0].order_delivery_status === "late"
                ? "Tarde"
                : selectedOrderDetails[0].order_delivery_status ===
                  "toBeDelivered"
                ? "En espera"
                : "No especificado"
            }}
          </p>
          <p *ngIf="userRole === 'admin'">
            <strong>Estado de pago:</strong>
            {{
              selectedOrderDetails[0].order_payment_status === "overdue"
                ? "En Mora"
                : selectedOrderDetails[0].order_payment_status === "upToDate"
                ? "Al Día"
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Tipo:</strong>
            {{
              selectedOrderDetails[0].order_type === "laser"
                ? "Corte Laser"
                : selectedOrderDetails[0].order_type === "print"
                ? "Impresión"
                : selectedOrderDetails[0].order_type === "sales"
                ? "Ventas"
                : "Otro"
            }}
          </p>
          <p>
            <strong>Tipo de cliente:</strong>
            {{
              selectedOrderDetails[0].client_type === "final"
                ? "Final"
                : selectedOrderDetails[0].client_type === "intermediary"
                ? "Intermediario"
                : "Desconocido"
            }}
          </p>
        </div>
        <div class="text-right">
          <p>
            <strong>De:</strong>
            {{ selectedOrderDetails[0].name }}
          </p>
        </div>
      </div>

      <!-- Itemized Invoice List -->
      <div class="my-6">
        <ul class="list-none">
          <li>
            <p>
              <strong>Descripción:</strong>
              {{ selectedOrderDetails[0].description }}
            </p>
            <p class="text-red-600">
              <strong>Notas:</strong> {{ selectedOrderDetails[0].notes }}
            </p>
            <div *ngIf="selectedOrderDetails[0]?.order_type !== 'sales'"></div>
            <p *ngIf="selectedOrderDetails[0].iva">
              <strong>IVA:</strong> {{ selectedOrderDetails[0].iva }}
            </p>
          </li>
        </ul>
      </div>

      <!-- Specific details for sales -->
      <div
        *ngIf="
          selectedOrderDetails &&
          selectedOrderDetails[0]?.order_type &&
          selectedOrderDetails[0].order_type === 'sales'
        "
        class="my-6"
      ></div>

      <!-- Totals Section -->
      <ng-container *ngIf="userRole === 'admin'">
        <div class="border-t pt-4 mt-4">
          <div class="flex justify-between">
            <p><strong>Subtotal</strong></p>
            <p>{{ selectedOrderDetails[0].subtotal  | number:'1.2-2'}}</p>
          </div>
          <div class="flex justify-between" *ngIf="selectedOrderDetails[0].iva">
            <p><strong>IVA</strong></p>
            <p>{{ selectedOrderDetails[0].iva }}</p>
          </div>
          <div
            *ngIf="selectedOrderDetails[0]?.extra_charges?.length"
            class="flex flex-col gap-1 my-2"
          >
            <p class="font-semibold text-blue-600 mb-1">Cargos Extras</p>
            <div
              *ngFor="let charge of selectedOrderDetails[0].extra_charges"
              class="flex justify-between"
            >
              <span>{{ charge.description }}</span>
              <span>${{ charge.amount  | number:'1.2-2'}}</span>
            </div>
          </div>
          <div class="flex justify-between">
            <p><strong>Total</strong></p>
            <p class="font-bold">{{ selectedOrderDetails[0].total  | number:'1.2-2'}}</p>
          </div>
        </div>
      </ng-container>
      <div
        *ngIf="selectedOrderDetails[0]?.file_path &&
          (
            userRole === 'admin' ||
            userRole === 'scheduler' ||
            (
              !selectedOrderDetails[0]?.secondary_process &&
              (
                (userRole === 'prints_employee' && selectedOrderDetails[0].order_type === 'print') ||
                (userRole === 'cuts_employee' && selectedOrderDetails[0].order_type === 'laser')
              )
            ) ||
            (
              selectedOrderDetails[0]?.secondary_process &&
              (
                (userRole === 'prints_employee' && selectedOrderDetails[0].order_type === 'print') ||
                (userRole === 'cuts_employee' && selectedOrderDetails[0].order_type === 'laser')
              )
            )
          )"
        class="border-t pt-4 mt-4"
      >
        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-5 h-5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13"
            />
          </svg>
          Adjuntos
        </h3>
        <div
          class="border rounded p-3 flex items-center justify-between bg-gray-50"
        >
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold text-gray-600"
              >Referencia / Diseño</span
            >
          </div>

          <button
            class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
            (click)="downloadFile(selectedOrderDetails[0].file_path)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"
              />
            </svg>
            <span class="text-white hover:text-blue-800"> Descargar</span>
          </button>
        </div>
      </div>
      <div
        *ngIf="
          selectedOrderDetails[0]?.second_file &&
          selectedOrderDetails[0]?.secondary_process &&
          (
            userRole === 'admin' ||
            userRole === 'scheduler' ||
            (userRole === 'cuts_employee' &&
              selectedOrderDetails[0].secondary_process === 'laser') ||
            (userRole === 'prints_employee' &&
              selectedOrderDetails[0].secondary_process === 'print')
          )
        "
        class="border-t pt-4 mt-4"
      >
        <div
          class="border rounded p-3 flex items-center justify-between bg-gray-50"
        >
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold text-gray-600">
              {{ selectedOrderDetails[0].secondary_process === 'laser'
                  ? 'Archivo de Corte'
                  : 'Archivo de Impresión'
              }}
            </span>
          </div>

          <button
            class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
            (click)="downloadFile(selectedOrderDetails[0].second_file)"
          >
            <!-- icon -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"
              />
            </svg>
            <span class="text-white hover:text-blue-800"> Descargar</span>
          </button>
        </div>
      </div>
      <ng-container *ngIf="userRole === 'admin' || userRole === 'scheduler'">
        <div *ngIf="selectedOrderDetails[0]?.invoice_file" class="mt-4">
          <div
            class="border rounded p-3 flex items-center justify-between bg-gray-50"
          >
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold text-gray-600"
                >Factura / Recibo</span
              >
            </div>

            <button
              class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
              (click)="downloadFile(selectedOrderDetails[0].invoice_file)"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"
                />
              </svg>
              <span class="text-white hover:text-blue-800"> Descargar</span>
            </button>
          </div>
        </div>
      </ng-container>

      <div class="flex justify-end mt-4">
        <button
          type="button"
          class="btn-danger"
          (click)="selectedOrderDetails = null"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Form to add orders -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content">
    <h3 class="text-lg font-bold mb-4">Pedido</h3>

    <form (ngSubmit)="addOrder(newOrder)">
      <!-- Campos comunes -->
      <ng-container *ngIf="userRole === 'admin' || userRole === 'scheduler' || !isEditing">
        <div class="mb-4">
          <label class="block modal-input-item">Tipo de Pedido<span class="text-red-500">*</span></label>
          <select
            [(ngModel)]="newOrder.order_type"
            name="order_type"
            class="form-select mt-1 block w-full"
            required
          >
            <option value="print">Impresiones</option>
            <option value="laser">Cortes</option>
            <option value="sales">Ventas</option>
          </select>
        </div>
        <div
          class="mb-4"
          *ngIf="newOrder.order_type === 'sales'"
        >
          <label class="flex items-center gap-2">
            <input
              type="checkbox"
              [(ngModel)]="newOrder.is_vitrine"
              name="is_vitrine"
            />
            Vitrina
          </label>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">
            Proceso Secundario
          </label>

          <select
            [(ngModel)]="newOrder.secondary_process"
            name="secondary_process"
            class="form-select mt-1 block w-full"
          >
            <option [ngValue]="null">-- Ninguno --</option>

            <option
              *ngIf="newOrder.order_type !== 'laser'"
              value="laser"
            >
              Corte
            </option>

            <option
              *ngIf="newOrder.order_type !== 'print'"
              value="print"
            >
              Impresión
            </option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item"
            >Cliente<span class="text-red-500">*</span></label
          >
          <select
            [(ngModel)]="newOrder.id_client"
            name="id_client"
            class="form-select mt-1 block w-full"
            required
          >
            <option value="" disabled selected>Seleccione un cliente</option>
            <option *ngFor="let client of clients" [value]="client.id_client">
              {{ client.name }}
            </option>
          </select>
          <button
            *ngIf="!isEditing"
            type="button"
            class="btn-primary mt-2"
            (click)="openAddClientModal()"
          >
            Añadir nuevo cliente
          </button>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">Tipo de Cliente</label>
          <select
            [(ngModel)]="newOrder.client_type"
            name="clie_type"
            class="form-select mt-1 block w-full"
            required
          >
            <option value="intermediary">Intermediario</option>
            <option value="final">Final</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">Descripción</label>
          <textarea
            [(ngModel)]="newOrder.description"
            name="description"
            class="form-textarea mt-1 block w-full"
          ></textarea>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">Notas</label>
          <input
            [(ngModel)]="newOrder.notes"
            name="notes"
            class="form-input mt-1 block w-full"
            required
          />
        </div>
        <div class="mb-4">
          <label class="block modal-input-item"
            >Fecha de Entrega<span class="text-red-500">*</span></label
          >
          <input
            type="date"
            [(ngModel)]="newOrder.delivery_date"
            name="delivery_date"
            class="form-input mt-1 block w-full"
            required
          />
          <label class="flex items-center gap-2 mt-2">
            <input
              type="checkbox"
              [(ngModel)]="newOrder.is_immediate"
              name="is_immediate"
            />
            Trabajo inmediato
          </label>
        </div>
        <!-- Valor Total del Pedido (ingreso manual) -->
        <div class="mb-4 border-t pt-4">
          <label class="block modal-input-item"
            >Valor Total del Pedido<span class="text-red-500">*</span></label
          >
          <input
            type="number"
            [(ngModel)]="newOrder.unitary_value"
            name="unitary_value"
            class="form-input mt-1 block w-full"
            placeholder="Ej: 50000"
            min="0"
            step="100"
            required
            (change)="updateOrderTotalWithExtras()"
          />
          <label class="flex items-center gap-2">
            <input
              type="checkbox"
              name="requires_e_invoice"
              [(ngModel)]="newOrder.requires_e_invoice"
            />
            Requiere factura electrónica
          </label>
        </div>
        <div class="mb-4 border-t pt-4">
          <h4 class="font-semibold text-blue-600">Cargos Extras</h4>
          <div class="flex gap-2 mb-2">
            <!-- Tipo de cargo -->
            <select
              [(ngModel)]="extraChargeType"
              name="extraChargeType"
              class="form-select w-1/6"
            >
              <option value="fixed">Valor Fijo ($)</option>
              <option value="percentage">Porcentaje (%)</option>
            </select>

            <!-- Descripción -->
            <input
              type="text"
              [(ngModel)]="extraChargeDescription"
              placeholder="Descripción"
              class="form-input w-2/5"
              name="extraChargeDescription"
            />

            <!-- Valor -->
            <input
              type="number"
              [(ngModel)]="extraChargeAmount"
              [placeholder]="
                extraChargeType === 'percentage' ? 'Ej. 5 (%)' : 'Ej. 5000 ($)'
              "
              class="form-input w-1/4"
              name="extraChargeAmount"
              [max]="extraChargeType === 'percentage' ? 100 : null"
              min="0"
            />

            <button
              type="button"
              class="btn-primary"
              (click)="addExtraCharge()"
            >
              Añadir
            </button>
          </div>

          <!-- Lista de cargos agregados -->
          <ul>
            <li
              *ngFor="let charge of newOrder.extra_charges; let i = index"
              class="flex items-center gap-2"
            >
              <span>
                {{ charge.description }}:
                <span *ngIf="charge.type === 'percentage'"
                  >{{ charge.amount | number : "1.0-0" }} (calculado)</span
                >
                <span *ngIf="charge.type !== 'percentage'">{{
                  charge.amount
                }}</span>
              </span>
              <button
                type="button"
                class="btn-danger btn-xs"
                (click)="removeExtraCharge(i)"
              >
                Eliminar
              </button>
            </li>
          </ul>
        </div>
        <!-- SECCIÓN DE PAGO -->
        <ng-container *ngIf="!isEditing">
          <div class="mb-4 border-t pt-4">
            <h4 class="font-semibold text-green-600">Pago del Pedido</h4>

            <label class="block modal-input-item">Tipo de pago</label>
            <select
              [(ngModel)]="initialPaymentType"
              name="initialPaymentType"
              class="form-select mt-1 block w-full"
            >
              <option value="none">No paga ahora</option>
              <option value="full">Pago total</option>
              <option value="partial">Abono</option>
            </select>

            <div *ngIf="initialPaymentType !== 'none'" class="mt-3">
              <label class="block modal-input-item">Monto pagado</label>
              <input
                type="number"
                [(ngModel)]="initialPaymentAmount"
                name="initialPaymentAmount"
                class="form-input mt-1 block w-full"
                min="0"
              />

              <label class="block modal-input-item mt-2">Método de pago</label>
              <select
                [(ngModel)]="initialPaymentMethod"
                name="initialPaymentMethod"
                class="form-select mt-1 block w-full"
              >
                <option value="" disabled selected>Seleccione un método</option>
                <option value="cash">Efectivo</option>
                <option value="nequi">Nequi</option>
                <option value="bancolombia">Bancolombia</option>
                <option value="Davivienda">Davivienda</option>
                <option value="other">Otro</option>
              </select>
            </div>
          </div>
        </ng-container>
        <!-- Tiempo de Corte (solo para laser) -->
        <div *ngIf="newOrder.order_type === 'laser'" class="mb-4 border-t pt-4">
          <h4 class="font-semibold text-yellow-600">Datos de Corte</h4>

          <label class="block mt-2 modal-input-item"
            >Tiempo de Corte (minutos)<span class="text-red-500">*</span></label
          >
          <input
            type="number"
            [(ngModel)]="tempCutTime"
            name="cutting_time"
            class="form-input mt-1 block w-full"
            placeholder="Ej: 30"
            min="0"
          />
        </div>
      </ng-container>
      <div
        class="bg-gray-50 p-4 rounded-md border border-gray-200 mt-4 space-y-4"
      >
        <h3 class="font-semibold text-gray-800 text-sm">Adjuntos</h3>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Archivo de Referencia / Diseño</label
          >
          <div class="flex items-center gap-2">
            <input
              type="file"
              (change)="onFileSelected($event, 'main')"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />

            <button
              *ngIf="newOrder.file_path"
              type="button"
              (click)="downloadFile(newOrder.file_path)"
              class="text-blue-600 hover:text-blue-800 text-sm font-bold flex items-center gap-1"
              title="Ver archivo actual"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                />
              </svg>
              Ver
            </button>
          </div>
          <p *ngIf="uploadedFileName" class="text-green-600 text-xs mt-1">
            Nuevo: {{ uploadedFileName }}
          </p>
        </div>

        <!-- Archivo proceso secundario -->
        <div *ngIf="newOrder.secondary_process !== null" class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Archivo de Proceso Secundario
            ({{ newOrder.secondary_process === 'laser' ? 'Corte' : 'Impresión' }})
          </label>

          <div class="flex items-center gap-2">
            <input
              type="file"
              (change)="onFileSelected($event, 'secondary')"
              class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100"
            />

            <button
              *ngIf="newOrder.second_file"
              type="button"
              (click)="downloadFile(newOrder.second_file)"
              class="text-blue-600 hover:text-blue-800 text-sm font-bold flex items-center gap-1"
              title="Ver archivo actual"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                />
              </svg>
              Ver
            </button>
          </div>

          <p *ngIf="selectedSecondaryFile" class="text-green-600 text-xs mt-1">
            Nuevo: {{ selectedSecondaryFile.name }}
          </p>
        </div>

        <ng-container *ngIf="userRole === 'admin' || userRole === 'scheduler'">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Factura de Pedido (PDF)</label
            >
            <div class="flex items-center gap-2">
              <input
                type="file"
                (change)="onInvoiceFileSelected($event)"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
              />

              <button
                *ngIf="newOrder.invoice_file"
                type="button"
                (click)="downloadFile(newOrder.invoice_file)"
                class="text-green-600 hover:text-green-800 text-sm font-bold flex items-center gap-1"
                title="Ver factura actual"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-5 h-5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                  />
                </svg>
                Ver
              </button>
            </div>
            <p *ngIf="selectedInvoiceFile" class="text-green-600 text-xs mt-1">
              Nuevo: {{ selectedInvoiceFile.name }}
            </p>
          </div>
        </ng-container>
      </div>

      <div class="flex justify-end mt-4">
        <button type="button" class="btn-danger" (click)="toggleAddOrderForm()">
          Cancelar
        </button>
        <button
          *ngIf="userRole == 'admin' || userRole == 'scheduler'"
          type="submit"
          class="btn-success ml-2"
        >
          Guardar Pedido
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para añadir cliente -->
<div *ngIf="showAddClientModal" class="modal-overlay">
  <div class="modal-content w-1/2">
    <h2 class="text-xl font-bold mb-4">Añadir Nuevo Cliente</h2>
    <form (ngSubmit)="saveNewClient()">
      <div class="mb-4">
        <label class="block text-gray-700">Nombre</label>
        <input
          [(ngModel)]="newClient.name"
          name="name"
          class="form-input"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Correo Electrónico</label>
        <input
          type="email"
          [(ngModel)]="newClient.email"
          name="email"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Tipo de Documento</label>
        <select
          [(ngModel)]="newClient.document_type"
          name="document_type"
          class="form-select"
        >
          <option value="NIT">NIT</option>
          <option value="Registro civil">Registro civil</option>
          <option value="Tarjeta de identidad">Tarjeta de identidad</option>
          <option value="Cédula de ciudadanía">Cédula de ciudadanía</option>
          <option value="Tarjeta de extranjería">Tarjeta de extranjería</option>
          <option value="Cédula de extranjería">Cédula de extranjería</option>
          <option value="Pasaporte">Pasaporte</option>
          <option value="Documento de identificación extranjero">
            Documento de identificación extranjero
          </option>
          <option value="NIT de otro país">NIT de otro país</option>
          <option value="NUIP">NUIP</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Identificación/Documento</label>
        <input
          [(ngModel)]="newClient.document_number"
          name="document_number"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Teléfono</label>
        <input
          type="number"
          [(ngModel)]="newClient.cellphone"
          name="cellphone"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Dirección</label>
        <input
          type="text"
          [(ngModel)]="newClient.address"
          name="address"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Estado</label>
        <select
          [(ngModel)]="newClient.status"
          name="status"
          class="form-select mt-1 block w-full"
        >
          <option value="upToDate">Al Día</option>
          <option value="overdue">En Mora</option>
        </select>
      </div>
      <div class="flex justify-end">
        <button
          type="button"
          class="btn-danger"
          (click)="closeAddClientModal()"
        >
          Cancelar
        </button>
        <button
          *ngIf="userRole == 'admin' || userRole == 'scheduler'"
          type="submit"
          class="btn-success px-4 py-2 rounded-md"
        >
          Guardar Cliente
        </button>
      </div>
    </form>
  </div>
</div>
<!-- Notificación temporal -->
<div
  *ngIf="notificationMessage"
  class="fixed top-4 right-4 bg-green-500 text-white p-2 rounded shadow-md z-50"
>
  {{ notificationMessage }}
</div>
