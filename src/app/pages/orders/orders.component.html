<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<!-- Indicador de carga -->
<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando pedidos...</p>
</div>

<!-- Filters -->
<div
  *ngIf="userRole == 'admin' || userRole == 'scheduler'"
  class="flex justify-between items-center mb-4 mt-4 ml-2"
>
  <div class="flex space-x-2">
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showPrints"
        (change)="updateFilteredOrders()"
      />
      Impresiones
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showCuts"
        (change)="updateFilteredOrders()"
      />
      Cortes
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showSales"
        (change)="updateFilteredOrders()"
      />
      Ventas
    </label>
  </div>
  <div class="flex space-x-2 mr-4">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="toggleAddOrderForm()"
    >
      <svg
        class="w-5 h-5 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12.75 9C12.75 8.58579 12.4142 8.25 12 8.25C11.5858 8.25 11.25 8.58579 11.25 9L11.25 11.25H9C8.58579 11.25 8.25 11.5858 8.25 12C8.25 12.4142 8.58579 12.75 9 12.75H11.25V15C11.25 15.4142 11.5858 15.75 12 15.75C12.4142 15.75 12.75 15.4142 12.75 15L12.75 12.75H15C15.4142 12.75 15.75 12.4142 15.75 12C15.75 11.5858 15.4142 11.25 15 11.25H12.75V9Z"
          fill="#ffffff"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
          fill="#ffffff"
        />
      </svg>
      <span>Añadir</span>
    </button>
    <!--
    <button
      class="btn-details inline-flex items-center space-x-2"
      (click)="openCalculator()"
    >
      <svg
        class="w-8 h-8 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g
          id="SVGRepo_tracerCarrier"
          stroke-linecap="round"
          stroke-linejoin="round"
        ></g>
        <g id="SVGRepo_iconCarrier">
          <path
            d="M14 7C14 6.44771 14.4477 6 15 6H16V5C16 4.44772 16.4477 4 17 4C17.5523 4 18 4.44772 18 5V6H19C19.5523 6 20 6.44771 20 7C20 7.55229 19.5523 8 19 8H18V9C18 9.55228 17.5523 10 17 10C16.4477 10 16 9.55228 16 9V8H15C14.4477 8 14 7.55229 14 7Z"
            fill="#ffffff"
          ></path>
          <path
            d="M14 15C14 14.4477 14.4477 14 15 14H19C19.5523 14 20 14.4477 20 15C20 15.5523 19.5523 16 19 16H15C14.4477 16 14 15.5523 14 15Z"
            fill="#ffffff"
          ></path>
          <path
            d="M15 18C14.4477 18 14 18.4477 14 19C14 19.5523 14.4477 20 15 20H19C19.5523 20 20 19.5523 20 19C20 18.4477 19.5523 18 19 18H15Z"
            fill="#ffffff"
          ></path>
          <path
            d="M5 6C4.44772 6 4 6.44771 4 7C4 7.55229 4.44772 8 5 8H9C9.55228 8 10 7.55229 10 7C10 6.44771 9.55228 6 9 6H5Z"
            fill="#ffffff"
          ></path>
          <path
            d="M5.92512 14.5109C5.5346 14.1204 4.90143 14.1204 4.51091 14.5109C4.12039 14.9014 4.12039 15.5346 4.51091 15.9251L5.5858 17L4.50337 18.0824C4.11284 18.4729 4.11284 19.1061 4.50337 19.4966C4.89389 19.8872 5.52705 19.8872 5.91758 19.4966L7.00002 18.4142L8.08944 19.5036C8.47996 19.8941 9.11313 19.8941 9.50365 19.5036C9.89418 19.1131 9.89418 18.4799 9.50365 18.0894L8.41423 17L9.50194 15.9123C9.89246 15.5218 9.89246 14.8886 9.50194 14.4981C9.11141 14.1075 8.47825 14.1075 8.08772 14.4981L7.00002 15.5858L5.92512 14.5109Z"
            fill="#ffffff"
          ></path>
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M20 1C21.6569 1 23 2.34315 23 4V20C23 21.6569 21.6569 23 20 23H4C2.34315 23 1 21.6569 1 20V4C1 2.34315 2.34315 1 4 1H20ZM20 3C20.5523 3 21 3.44772 21 4V11H13V3H20ZM21 13V20C21 20.5523 20.5523 21 20 21H13V13H21ZM4 3H11V11H3V4C3 3.44772 3.44772 3 4 3ZM3 20V13H11V21H4C3.44772 21 3 20.5523 3 20Z"
            fill="#ffffff"
          ></path>
        </g>
      </svg>
      <span>Calculadora</span>
    </button>
    -->
    <button class="btn-clear" (click)="clearFilters()">Limpiar</button>
  </div>
</div>

<!-- Search bars -->
<div class="flex items-center justify-center py-4 space-x-4 top-5">
  <!-- Buscar por nombre de cliente -->
  <div class="relative w-full max-w-md">
    <input
      type="text"
      placeholder="Buscar por nombre de cliente..."
      [(ngModel)]="searchByNameQuery"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
      (input)="updateFilteredOrders()"
    />
  </div>
  <!-- Buscar por número de pedido -->
  <div class="relative w-full max-w-md">
    <input
      type="text"
      placeholder="Buscar pedido por número..."
      [(ngModel)]="searchQuery"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
    <button
      class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-700 w-auto"
      (click)="onSearch()"
    >
      Buscar
    </button>
  </div>
</div>
<div class="flex items-center space-x-4">
  <div>
    <label for="startDate" class="mr-2 font-semibold">Desde:</label>
    <input
      type="date"
      id="startDate"
      [(ngModel)]="startDate"
      (ngModelChange)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
    <input
      type="date"
      id="endDate"
      [(ngModel)]="endDate"
      (ngModelChange)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label class="font-semibold mr-2">Agendado por:</label>
    <select
      [(ngModel)]="selectedScheduler"
      (change)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option value="">-- Todos --</option>
      <option *ngFor="let u of getUniqueSchedulers()" [value]="u">
        {{ u }}
      </option>
    </select>
  </div>
</div>

<!-- Orders Table -->
<div *ngIf="!loading" class="mt-4">
  <table class="table-std">
    <thead>
      <ng-container
        *ngIf="
          userRole === 'admin' || userRole === 'scheduler';
          else notAdminHeader
        "
      >
        <tr>
          <th class="table-column-std">Código</th>
          <th class="table-column-std">Tipo</th>
          <th class="table-column-std">Cliente</th>
          <th class="table-column-std">Atención</th>
          <th class="table-column-std">Estado de pago</th>
          <th class="table-column-std">Estado de trabajo</th>
          <th class="table-column-std">Estado Stock</th>
          <th class="table-column-std">Fecha</th>
          <th class="table-column-std">Fecha de Entrega</th>
          <th class="table-column-std">Días Restantes</th>
          <th class="table-column-std">Total</th>
          <th class="table-column-std">Confirmación</th>
          <th class="table-column-std">Acción</th>
        </tr>
      </ng-container>
      <ng-template #notAdminHeader>
        <tr>
          <th class="table-column-std">Código</th>
          <th class="table-column-std">Tipo</th>
          <th class="table-column-std">Cliente</th>
          <th class="table-column-std">Estado de trabajo</th>
          <th class="table-column-std">Fecha</th>
          <th class="table-column-std">Fecha de Entrega</th>
          <th class="table-column-std">Días Restantes</th>
          <th class="table-column-std">Acción</th>
          <th class="table-column-std">Confirmación de Orden</th>
        </tr>
      </ng-template>
    </thead>

    <tbody>
      <ng-container
        *ngIf="
          userRole === 'admin' || userRole === 'scheduler';
          else notAdminBody
        "
      >
        <tr *ngFor="let order of paginatedOrders">
          <td>{{ order.code }}</td>
          <td>
            {{
              order.order_type === "print"
                ? "Impresiones"
                : order.order_type === "laser"
                ? "Cortes"
                : order.order_type === "sales"
                ? "Ventas"
                : "Desconocido"
            }}
          </td>
          <td>{{ order.name }}</td>
          <td>
            {{ order.scheduler }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_payment_status === 'upToDate',
              'text-red-600': order.order_payment_status === 'overdue'
            }"
          >
            {{
              order.order_payment_status === "upToDate"
                ? "Al Día"
                : order.order_payment_status === "overdue"
                ? "En Mora"
                : "Desconocido"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-red-600': order.order_completion_status === 'standby',
              'text-orange-400': order.order_completion_status === 'inProgress'
            }"
          >
            <select
              class="border rounded p-1"
              [(ngModel)]="order.order_completion_status"
              (change)="toggleOrderCompletionStatus(order)"
            >
              <option value="finished">Terminado</option>
              <option value="standby">En espera</option>
              <option value="inProgress">En progreso</option>
            </select>
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.stock_status === 'fulfilled',
              'text-orange-600': order.stock_status === 'partially_fulfilled',
              'text-red-600': order.stock_status === 'pending_stock'
            }"
          >
            <span
              *ngIf="!order.stock_status || order.stock_status === 'fulfilled'"
            >
              Completo
            </span>
            <span *ngIf="order.stock_status === 'partially_fulfilled'">
              Parcial
              <span class="text-xs block"
                >({{ order.pending_quantity || 0 }} pend.)</span
              >
            </span>
            <span *ngIf="order.stock_status === 'pending_stock'">
              Pendiente
              <span class="text-xs block"
                >({{ order.pending_quantity || 0 }} pend.)</span
              >
            </span>
            <!--
            <button
              *ngIf="
                order.stock_status === 'pending_stock' ||
                order.stock_status === 'partially_fulfilled'
              "
              class="btn-success mt-2 text-xs px-2 py-1"
              (click)="completeStockForOrder(order)"
            >
              Completar Stock
            </button>
            -->
          </td>

          <td>
            <div>
              {{ order.created_at | date:'dd-MM-yyyy' }}
            </div>
            <small *ngIf="order.created_time">
              {{ order.created_time.slice(0, 5) }}
            </small>
          </td>
          <td>
            {{
              order.delivery_date
                ? (order.delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-blue-600':
                order.order_completion_status !== 'finished' &&
                getRemainingDeliveryDays(order) > 0,
              'text-red-600':
                order.order_completion_status !== 'finished' &&
                getRemainingDeliveryDays(order) <= 0
            }"
          >
            {{
              order.order_completion_status === "finished"
                ? "Completo"
                : getRemainingDeliveryDays(order) > 0
                ? getRemainingDeliveryDays(order) + " días"
                : "Vencido"
            }}
          </td>
          <td>{{ order.total }}</td>
          <td
            [ngClass]="{
              'text-green-600': order.order_confirmed_status === 'confirmed',
              'text-orange-400': order.order_confirmed_status === 'notConfirmed'
            }"
          >
            {{
              order.order_confirmed_status === "confirmed"
                ? "Confirmado"
                : order.order_confirmed_status === "notConfirmed"
                ? "En espera"
                : "Desconocido"
            }}
          </td>
          <td>
            <button class="btn-details" (click)="selectOrder(order)">
              Detalles
            </button>
            <button class="btn-edit" (click)="editOrder(order)">Editar</button>
            <button
              *ngIf="userRole == 'admin'"
              class="btn-delete"
              (click)="deleteOrder(order)"
            >
              Eliminar
            </button>
          </td>
        </tr>
      </ng-container>

      <ng-template #notAdminBody>
        <tr *ngFor="let order of paginatedOrders">
          <td>{{ order.code }}</td>
          <td>
            {{
              order.order_type === "print"
                ? "Impresiones"
                : order.order_type === "laser"
                ? "Cortes"
                : order.order_type === "sales"
                ? "Ventas"
                : "Desconocido"
            }}
          </td>
          <td>{{ order.name }}</td>

          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-red-600': order.order_completion_status === 'standby',
              'text-orange-400': order.order_completion_status === 'inProgress'
            }"
          >
            <select
              class="border rounded p-1"
              [(ngModel)]="order.order_completion_status"
              (change)="toggleOrderCompletionStatus(order)"
            >
              <option value="finished">Terminado</option>
              <option value="standby">En espera</option>
              <option value="inProgress">En progreso</option>
            </select>
          </td>
          <td>{{ order.created_at | date : "dd-MM-yyyy" }}</td>
          <td>
            {{
              order.delivery_date
                ? (order.delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </td>
          <td
            [ngClass]="{
              'text-red-500': isDeliveryOverdue(order),
              'text-yellow-500': isDeliveryLastDay(order),
              'text-green-500': hasMultipleDeliveryDays(order)
            }"
          >
            {{ getFormattedDeliveryTime(order) }}
          </td>
          <td>
            <button class="btn-details" (click)="selectOrder(order)">
              Detalles
            </button>
            <button class="btn-edit" (click)="editOrder(order)">Editar</button>
            <button
              *ngIf="userRole == 'admin'"
              class="btn-delete"
              (click)="deleteOrder(order)"
            >
              Eliminar
            </button>
          </td>
          <td>
            <label>
              <input
                type="checkbox"
                [checked]="order.order_confirmed_status === 'confirmed'"
                (change)="toggleOrderConfirmedStatus(order)"
              />
            </label>
          </td>
        </tr>
      </ng-template>
    </tbody>
  </table>
</div>

<!-- Mensaje de no resultados para búsqueda por nombre -->
<div *ngIf="noResultsFound" class="p-4 text-center text-gray-600">
  <p>No hay coincidencias con la búsqueda.</p>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedOrder()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      ⇐
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedOrder()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700">
      Página {{ currentPage }} de {{ totalPages }}
    </span>
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedOrder()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedOrder()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      ⇒
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedOrder()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Show details of the selected order -->
<div
  *ngIf="
    selectedOrderDetails && selectedOrderDetails.length > 0 && !loadingDetails
  "
  class="modal-overlay"
>
  <div class="modal-content">
    <h2 class="text-xl font-bold">Detalles de Pedido</h2>
    <!-- Printable Invoice Layout -->
    <div class="p-4 border border-gray-300 bg-white invoice-details">
      <div class="flex justify-between mb-4">
        <div>
          <h3 class="font-semibold text-lg">
            Pedido N°: {{ selectedOrderDetails[0].code }}
          </h3>
          <p>
            <strong>Fecha:</strong>
            {{ selectedOrderDetails[0].created_at | date : "dd-MM-yyyy" }}
            {{ selectedOrderDetails[0].created_time?.slice(0, 5) }}
          </p>
          <p>
            <strong>Fecha de Entrega:</strong>
            {{
              selectedOrderDetails[0].delivery_date
                ? (selectedOrderDetails[0].delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Estado de trabajo:</strong>
            {{
              selectedOrderDetails[0].order_completion_status === "finished"
                ? "Completado"
                : selectedOrderDetails[0].order_completion_status === "standby"
                ? "En espera"
                : selectedOrderDetails[0].order_completion_status ===
                  "inProgress"
                ? "En progreso"
                : "Desconocido"
            }}
          </p>
          <p>
            <strong>Confirmación del pedido:</strong>
            {{
              selectedOrderDetails[0].order_confirmed_status === "confirmed"
                ? "Confirmado"
                : selectedOrderDetails[0].order_confirmed_status ===
                  "notConfirmed"
                ? "Por Confirmar"
                : "Desconocido"
            }}
          </p>
          <p>
            <strong>Estado de entrega:</strong>
            {{
              selectedOrderDetails[0].order_completion_status === "finished"
                ? "Completado"
                : selectedOrderDetails[0].order_delivery_status === "onTime"
                ? "A tiempo"
                : selectedOrderDetails[0].order_delivery_status === "late"
                ? "Tarde"
                : selectedOrderDetails[0].order_delivery_status ===
                  "toBeDelivered"
                ? "En espera"
                : "No especificado"
            }}
          </p>
          <p *ngIf="userRole === 'admin'">
            <strong>Estado de pago:</strong>
            {{
              selectedOrderDetails[0].order_payment_status === "overdue"
                ? "En Mora"
                : selectedOrderDetails[0].order_payment_status === "upToDate"
                ? "Al Día"
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Tipo:</strong>
            {{
              selectedOrderDetails[0].order_type === "laser"
                ? "Corte Laser"
                : selectedOrderDetails[0].order_type === "print"
                ? "Impresión"
                : selectedOrderDetails[0].order_type === "sales"
                ? "Ventas"
                : "Otro"
            }}
          </p>
          <p>
            <strong>Tipo de cliente:</strong>
            {{
              selectedOrderDetails[0].client_type === "final"
                ? "Final"
                : selectedOrderDetails[0].client_type === "intermediary"
                ? "Intermediario"
                : "Desconocido"
            }}
          </p>
        </div>
        <div class="text-right">
          <p>
            <strong>De:</strong>
            {{ selectedOrderDetails[0].name }}
          </p>
        </div>
      </div>

      <!-- Itemized Invoice List -->
      <div class="my-6">
        <ul class="list-none">
          <li>
            <p>
              <strong>Descripción:</strong>
              {{ selectedOrderDetails[0].description }}
            </p>
            <p class="text-red-600">
              <strong>Notas:</strong> {{ selectedOrderDetails[0].notes }}
            </p>
            <div *ngIf="selectedOrderDetails[0]?.order_type !== 'sales'"></div>
            <p *ngIf="selectedOrderDetails[0].iva">
              <strong>IVA:</strong> {{ selectedOrderDetails[0].iva }}
            </p>
          </li>
        </ul>
      </div>
      <!-- Specific details for cuts -->
      <div *ngIf="selectedOrderDetails[0].order_type === 'laser'" class="my-6">
        <!--
        <h4 class="font-semibold text-purple-700">Detalles de Corte</h4>
        -->

        <!-- Tabla de materiales de corte
        <ng-container *ngIf="selectedOrderTypeDetail?.length; else noCuts">
          -->
          <!--
          <table class="min-w-full text-sm border mt-3">
            -->
            <!--
            <thead class="bg-gray-200">
              -->
              <!--
              <tr>
                -->
                <!--
                <th class="border px-2 py-1">Material</th>
                <th class="border px-2 py-1">Color</th>
                <th class="border px-2 py-1">Cantidad</th>
                <th class="border px-2 py-1">Tiempo (min)</th>
                <th class="border px-2 py-1">Dimensiones</th>
                -->
                <!--
              </tr>
              -->
              <!--
            </thead>
            -->
            <!--
            <tbody>
              -->
              <!--
              <tr *ngFor="let c of selectedOrderTypeDetail">
                -->
                <!--
                <td class="border px-2 py-1">
                  <strong>{{ c.category }}</strong
                  ><br />
                  <span class="text-xs text-gray-600">{{
                    c.material_type
                  }}</span>
                </td>
                -->
                <!--
                <td class="border px-2 py-1">{{ c.color || "Vacío" }}</td>
                <td class="border px-2 py-1">{{ c.quantity }}</td>
                <td class="border px-2 py-1">{{ c.cutting_time }}</td>
                <td class="border px-2 py-1">
                  <span *ngIf="c.height && c.width">
                    {{ c.height }} x {{ c.width }} m
                  </span>
                  <span *ngIf="!c.height && !c.width">-</span>
                </td>
                -->
                <!--
              </tr>
              -->
              <!--
            </tbody>
            -->
            <!--
          </table>
          -->
          <!--
        </ng-container>
        -->

        <!--
        <ng-template #noCuts>
          <p class="text-gray-500">
            Este pedido no tiene materiales de corte registrados.
          </p>
        </ng-template>
        -->
      </div>

      <!-- Specific details for prints -->
      <div *ngIf="selectedOrderDetails[0].order_type === 'print'" class="my-6">
        <!--
        <h4 class="font-semibold text-green-700">Detalles de Impresión</h4>
        -->
        <!-- Tabla de materiales de impresión
        <ng-container *ngIf="selectedOrderTypeDetail?.length; else noPrints">
          -->
          <!--
          <table class="min-w-full text-sm border mt-3">
            -->
            <!--
            <thead class="bg-gray-200">
              <tr>
                <th class="border px-2 py-1">Material</th>
                <th class="border px-2 py-1">Color</th>
                <th class="border px-2 py-1">Cantidad</th>
                <th class="border px-2 py-1">Procesos</th>
              </tr>
            </thead>
            -->
            <!--
            <tbody>
              <tr *ngFor="let p of selectedOrderTypeDetail">
                <td class="border px-2 py-1">
                  <strong>{{ p.category }}</strong
                  ><br />
                  <span class="text-xs text-gray-600">{{
                    p.material_type
                  }}</span>
                </td>
                <td class="border px-2 py-1">{{ p.color || "(Vacío)" }}</td>
                <td class="border px-2 py-1">{{ p.quantity }}</td>
                <td class="border px-2 py-1">
                  <span *ngIf="p.laminating"> Lam</span>
                  <span *ngIf="p.printing"> Impr</span>
                  <span *ngIf="p.die_cutting"> Troq</span>
                  <span *ngIf="p.assembly"> Arma</span>
                  <span
                    *ngIf="
                      !p.laminating &&
                      !p.printing &&
                      !p.die_cutting &&
                      !p.assembly
                    "
                    >-</span
                  >
                </td>
              </tr>
            </tbody>
          </table>
          -->
          <!--
        </ng-container>
        -->

        <!--
        <ng-template #noPrints>
          <p class="text-gray-500">
            Este pedido no tiene materiales de impresión registrados.
          </p>
        </ng-template>
        -->
      </div>
      <!-- Specific details for sales -->
      <div
        *ngIf="
          selectedOrderDetails &&
          selectedOrderDetails[0]?.order_type &&
          selectedOrderDetails[0].order_type === 'sales'
        "
        class="my-6"
      >
      <!--
        <h4 class="font-semibold text-green-700">Detalles de venta</h4>
        -->
        <!--
        <ng-container *ngIf="selectedOrderTypeDetail?.length; else noSales">
        -->
          <!--
          <ul class="list-none">
            -->
            <!--
            <li
              *ngFor="let s of selectedOrderTypeDetail"
              class="mb-4 pb-4 border-b"
            >
            -->
              <!--
              <p>
                <strong>Tipo de ítem:</strong>
                {{
                  s.item_type === "material"
                    ? "Material"
                    : s.item_type === "product"
                    ? "Producto"
                    : "Desconocido"
                }}
              </p>
              -->

              <!-- Si es MATERIAL
              <ng-container *ngIf="s.item_type === 'material'; else productTpl">
                -->
                <!--
                <p *ngIf="s.category">
                  <strong>Categoría:</strong> {{ s.category }}
                </p>
                <p *ngIf="s.material_type">
                  <strong>Tipo de material:</strong> {{ s.material_type }}
                </p>
                <p *ngIf="s.caliber">
                  <strong>Calibre:</strong> {{ s.caliber }}
                </p>
                <p *ngIf="s.color"><strong>Color:</strong> {{ s.color }}</p>
                -->
                <!-- Si no tienes snapshots, al menos muestra el ID
                <p
                  *ngIf="
                    !s.category && !s.material_type && !s.caliber && !s.color
                  "
                >
                  <strong>Material ID:</strong> {{ s.material_id }}
                </p>
                -->
                <!--
              </ng-container>
              -->

              <!-- Si es PRODUCTO
              <ng-template #productTpl>
                 -->
                <!--
                <p>
                  <strong>Producto:</strong>
                  {{
                    s.product_name_snapshot || getProductNameById(s.product_id)
                  }}
                </p>
                 -->
                <!--
              </ng-template>
               -->

              <!-- Económicos
              <p><strong>Cantidad:</strong> {{ s.quantity }}</p>
               -->
              <!--
              <p>
                <strong>Precio unitario:</strong>
                {{ s.unit_price | number : "1.0-2" }}
              </p>
               -->
              <!--
            </li>
             -->
            <!--
          </ul>
           -->
          <!--
        </ng-container>
         -->

         <!--
        <ng-template #noSales>
          <p class="text-gray-500">
            Este pedido no tiene líneas de venta registradas.
          </p>
        </ng-template>
         -->
      </div>

      <!-- Totals Section -->
      <ng-container *ngIf="userRole === 'admin'">
        <div class="border-t pt-4 mt-4">
          <div class="flex justify-between">
            <p><strong>Subtotal</strong></p>
            <p>{{ selectedOrderDetails[0].subtotal }}</p>
          </div>
          <div class="flex justify-between" *ngIf="selectedOrderDetails[0].iva">
            <p><strong>IVA</strong></p>
            <p>{{ selectedOrderDetails[0].iva }}</p>
          </div>
          <div
            *ngIf="selectedOrderDetails[0]?.extra_charges?.length"
            class="flex flex-col gap-1 my-2"
          >
            <p class="font-semibold text-blue-600 mb-1">Cargos Extras</p>
            <div
              *ngFor="let charge of selectedOrderDetails[0].extra_charges"
              class="flex justify-between"
            >
              <span>{{ charge.description }}</span>
              <span>${{ charge.amount }}</span>
            </div>
          </div>
          <div class="flex justify-between">
            <p><strong>Total</strong></p>
            <p class="font-bold">{{ selectedOrderDetails[0].total }}</p>
          </div>
        </div>
      </ng-container>
      <div *ngIf="selectedOrderDetails[0]?.file_path" class="mt-4">
        <p class="font-semibold">Archivo adjunto:</p>
        <button
          class="btn-secondary mt-2"
          (click)="downloadFile(selectedOrderDetails[0].file_path)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"
            />
          </svg>
          <span class="text-blue-400 hover:text-blue-800">
            Descargar Archivo</span
          >
        </button>
      </div>

      <div class="flex justify-end mt-4">
        <button
          type="button"
          class="btn-danger"
          (click)="selectedOrderDetails = null"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Form to add orders -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content">
    <h3 class="text-lg font-bold mb-4">Pedido</h3>

    <form (ngSubmit)="addOrder(newOrder)">
      <!-- Campos comunes -->
      <ng-container *ngIf="userRole === 'admin' || !isEditing">
        <div class="mb-4">
          <label class="block modal-input-item">Tipo de Pedido</label>
          <select
            [(ngModel)]="newOrder.order_type"
            name="order_type"
            class="form-select mt-1 block w-full"
            required
          >
            <option value="print">Impresiones</option>
            <option value="laser">Cortes</option>
            <option value="sales">Ventas</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item"
            >Cliente<span class="text-red-500">*</span></label
          >
          <select
            [(ngModel)]="newOrder.id_client"
            name="id_client"
            class="form-select mt-1 block w-full"
            required
          >
            <option value="" disabled selected>Seleccione un cliente</option>
            <option *ngFor="let client of clients" [value]="client.id_client">
              {{ client.name }}
            </option>
          </select>
          <button
            *ngIf="!isEditing"
            type="button"
            class="btn-primary mt-2"
            (click)="openAddClientModal()"
          >
            Añadir nuevo cliente
          </button>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">Tipo de Cliente</label>
          <select
            [(ngModel)]="newOrder.client_type"
            name="clie_type"
            class="form-select mt-1 block w-full"
            required
          >
            <option value="intermediary">Intermediario</option>
            <option value="final">Final</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">Descripción</label>
          <textarea
            [(ngModel)]="newOrder.description"
            name="description"
            class="form-textarea mt-1 block w-full"
          ></textarea>
        </div>
        <div class="mb-4">
          <label class="block modal-input-item">Notas</label>
          <input
            [(ngModel)]="newOrder.notes"
            name="notes"
            class="form-input mt-1 block w-full"
            required
          />
        </div>
        <div class="mb-4">
          <label class="block modal-input-item"
            >Fecha de Entrega<span class="text-red-500">*</span></label
          >
          <input
            type="date"
            [(ngModel)]="newOrder.delivery_date"
            name="delivery_date"
            class="form-input mt-1 block w-full"
            required
          />
        </div>
        <!-- ✅ NUEVO: Valor Total del Pedido (ingreso manual) -->
        <div class="mb-4 border-t pt-4">
          <label class="block modal-input-item"
            >Valor Total del Pedido<span class="text-red-500">*</span></label
          >
          <input
            type="number"
            [(ngModel)]="newOrder.unitary_value"
            name="unitary_value"
            class="form-input mt-1 block w-full"
            placeholder="Ej: 50000"
            min="0"
            step="100"
            required
            (change)="updateOrderTotalWithExtras()"
          />
        </div>
        <div class="mb-4 border-t pt-4">
          <h4 class="font-semibold text-blue-600">Cargos Extras</h4>
          <div class="flex gap-2 mb-2">
            <!-- Tipo de cargo -->
            <select
              [(ngModel)]="extraChargeType"
              name="extraChargeType"
              class="form-select w-1/6"
            >
              <option value="fixed">Valor Fijo ($)</option>
              <option value="percentage">Porcentaje (%)</option>
            </select>

            <!-- Descripción -->
            <input
              type="text"
              [(ngModel)]="extraChargeDescription"
              placeholder="Descripción"
              class="form-input w-2/5"
              name="extraChargeDescription"
            />

            <!-- Valor -->
            <input
              type="number"
              [(ngModel)]="extraChargeAmount"
              [placeholder]="
                extraChargeType === 'percentage' ? 'Ej. 5 (%)' : 'Ej. 5000 ($)'
              "
              class="form-input w-1/4"
              name="extraChargeAmount"
              [max]="extraChargeType === 'percentage' ? 100 : null"
              min="0"
            />

            <button
              type="button"
              class="btn-primary"
              (click)="addExtraCharge()"
            >
              Añadir
            </button>
          </div>

          <!-- Lista de cargos agregados -->
          <ul>
            <li
              *ngFor="let charge of newOrder.extra_charges; let i = index"
              class="flex items-center gap-2"
            >
              <span>
                {{ charge.description }}:
                <span *ngIf="charge.type === 'percentage'"
                  >{{ charge.amount | number : "1.0-0" }} (calculado)</span
                >
                <span *ngIf="charge.type !== 'percentage'">{{
                  charge.amount
                }}</span>
              </span>
              <button
                type="button"
                class="btn-danger btn-xs"
                (click)="removeExtraCharge(i)"
              >
                Eliminar
              </button>
            </li>
          </ul>
        </div>
         <!-- ✅ NUEVO: Tiempo de Corte (solo para laser) -->
        <div *ngIf="newOrder.order_type === 'laser'" class="mb-4 border-t pt-4">
          <h4 class="font-semibold text-yellow-600">Datos de Corte</h4>

          <label class="block mt-2 modal-input-item"
            >Tiempo de Corte (minutos)<span class="text-red-500">*</span></label
          >
          <input
            type="number"
            [(ngModel)]="tempCutTime"
            name="cutting_time"
            class="form-input mt-1 block w-full"
            placeholder="Ej: 30"
            min="0"
          />
        </div>
        <!-- DESCUENTOS -->
        <div class="mb-4 border-t pt-4">
          <!--
          <h4 class="font-semibold text-green-600">Descuento</h4>
           -->

          <!-- Formulario para agregar descuento (solo si no hay uno aplicado)
          <div *ngIf="!hasDiscountApplied" class="flex gap-2 mb-2">
            -->
            <!-- Tipo de descuento
            <select
              [(ngModel)]="discountType"
              name="discountType"
              class="form-select w-1/6"
            >
              <option value="fixed">Valor Fijo ($)</option>
              <option value="percentage">Porcentaje (%)</option>
            </select>
            -->
            <!-- Valor del descuento
            <input
              type="number"
              [(ngModel)]="discount"
              [placeholder]="
                discountType === 'percentage' ? 'Ej. 10 (%)' : 'Ej. 10000 ($)'
              "
              class="form-input w-1/3"
              name="discount"
              [max]="discountType === 'percentage' ? 100 : null"
              min="0"
            />
            -->

            <!-- Botón para agregar
            <button type="button" class="btn-primary" (click)="applyDiscount()">
              Añadir
            </button>
            -->
          <!--
          </div>
           -->

          <!-- Descuento aplicado (con botón eliminar)
          <div
            *ngIf="hasDiscountApplied"
            class="p-3 bg-green-50 rounded border border-green-200"
          >
          -->
            <!--
            <div class="flex items-center justify-between">
              -->
              <!--
              <div>
                -->
                <!--
                <p class="text-sm font-semibold text-green-800">
                  Descuento aplicado:
                </p>
                <p class="text-sm text-green-700">
                  <span *ngIf="newOrder.discount_type === 'percentage'">
                    {{ newOrder.discount }}% = ${{
                      totalBeforeDiscount - +(newOrder.total ?? 0)
                        | number : "1.0-0"
                    }}
                  </span>
                  <span *ngIf="newOrder.discount_type === 'fixed'">
                    Valor fijo: ${{ newOrder.discount ?? 0 | number : "1.0-0" }}
                  </span>
                </p>
                -->
                <!--
              </div>
              -->
              <!--
              <button
                type="button"
                class="btn-danger btn-xs"
                (click)="clearDiscount()"
              >
                Eliminar
              </button>
              -->
            <!--
            </div>
            -->
          <!--
          </div>
          -->
        </div>
      </ng-container>

      <!-- Sección de Datos Específicos para Prints -->
       <!--
      <div *ngIf="newOrder.order_type === 'print'" class="mb-4 border-t pt-4">
        -->
        <!--
        <h4 class="font-semibold text-blue-600">Datos de Impresión</h4>
        -->

        <!-- Selección de Material
        <div class="grid grid-cols-2 gap-4 mt-4">
        -->
          <!-- Categoría
          <div>
            <label class="block modal-input-item">Categoría</label>
            <select
              [(ngModel)]="selectedCategory"
              name="printCategory"
              class="form-select mt-1 block w-full"
              (change)="
                selectedType = '';
                selectedCaliber = '';
                selectedColor = '';
                onPrintMaterialChange()
              "
            >
              <option value="">-- Seleccionar --</option>
              <option *ngFor="let c of getCategories()" [value]="c">
                {{ c }}
              </option>
            </select>
          </div>
          -->

          <!-- Tipo
          <div>
            <label class="block modal-input-item">Tipo</label>
            <select
              [(ngModel)]="selectedType"
              name="printType"
              class="form-select mt-1 block w-full"
              (change)="
                selectedCaliber = '';
                selectedColor = '';
                onPrintMaterialChange()
              "
            >
              <option value="">-- Seleccionar --</option>
              <option *ngFor="let t of getTypes()" [value]="t">{{ t }}</option>
            </select>
          </div>
          -->

          <!-- Calibre
          <div>
            <label class="block modal-input-item">Calibre</label>
            <select
              [(ngModel)]="selectedCaliber"
              name="printCaliber"
              class="form-select mt-1 block w-full"
              (change)="selectedColor = ''; onPrintMaterialChange()"
            >
              <option value="">-- Seleccionar --</option>
              <option *ngFor="let cal of getCalibers()" [value]="cal">
                {{ cal }}
              </option>
            </select>
          </div>
          -->

          <!-- Color
          <div>
            <label class="block modal-input-item">Color</label>
            <select
              [(ngModel)]="selectedColor"
              name="printColor"
              class="form-select mt-1 block w-full"
              (change)="onPrintMaterialChange()"
            >
              <option value="">-- Seleccionar --</option>
              <option *ngFor="let col of getColors()" [value]="col">
                {{ col }}
              </option>
            </select>
          </div>
          -->
        <!--
        </div>
        -->

        <!-- Info de stock del material seleccionado
        <div
          class="text-sm text-gray-600 mt-2"
          *ngIf="getSelectedMaterial() as sm"
        >
          Stock disponible: <strong>{{ sm.material_quantity }}</strong>
        </div>
        -->

        <!-- Valor Unitario del Material
        <div class="mt-4">
          <label class="block modal-input-item"
            >Valor Unitario del Material</label
          >
          <input
            type="number"
            [(ngModel)]="tempPrintUnitaryValue"
            name="printUnitaryValue"
            class="form-input mt-1 block w-full"
            min="0"
            placeholder="Ingrese el valor unitario"
          />
        </div>
        -->

        <!-- Cantidad
        <div class="mt-4">
          <label class="block modal-input-item">Cantidad</label>
          <input
            type="number"
            [(ngModel)]="tempPrintQuantity"
            name="printQuantity"
            class="form-input mt-1 block w-full"
            min="1"
            placeholder="Ingrese la cantidad"
          />
        </div>
        -->

        <!--
        <div>
          <label class="block modal-input-item">Ancho de Rollo</label>
          <input
            type="number"
            [(ngModel)]="tempPrintRollWidth"
            class="w-full border px-2 py-1"
            placeholder="0"
          />
        </div>

        <div>
          <label class="block modal-input-item">Medida (Measurement)</label>
          <input
            type="number"
            [(ngModel)]="tempPrintMeasurement"
            class="w-full border px-2 py-1"
            placeholder="0"
          />
        </div>
        -->

        <!-- Checkboxes de Procesos
        <div class="mt-4">
          <label class="block modal-input-item mb-2">Procesos</label>
          <div class="grid grid-cols-2 gap-4">
            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="tempPrintLaminating"
                name="printLaminating"
                class="mr-2"
              />
              <span>Laminado</span>
            </label>

            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="tempPrintPrinting"
                name="printPrinting"
                class="mr-2"
              />
              <span>Impresión</span>
            </label>

            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="tempPrintDieCutting"
                name="printDieCutting"
                class="mr-2"
              />
              <span>Troquelado</span>
            </label>

            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="tempPrintAssembly"
                name="printAssembly"
                class="mr-2"
              />
              <span>Armado</span>
            </label>
          </div>
        </div>
        -->

        <!-- Botón Añadir Material
        <button type="button" class="btn-add mt-4" (click)="addPrintItem()">
          Añadir Material
        </button>
        -->
        <!--
      </div>
      -->



      <!-- Tabla de materiales añadidos para prints -->
       <!--
      <div
        *ngIf="printsItems.length > 0 && newOrder.order_type === 'print'"
        class="mt-6 mb-4"
      >
      -->
        <!--
        <h4 class="font-semibold text-gray-700">Materiales del Pedido</h4>
        -->
        <!--
        <table class="min-w-full text-sm border mt-2">
          -->
          <!--
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-2 py-1">Material</th>
              <th class="border px-2 py-1">Cantidad</th>
              <th class="border px-2 py-1">Procesos</th>
              <th class="border px-2 py-1">Valor</th>
              <th class="border px-2 py-1">Acción</th>
            </tr>
          </thead>
          -->
          <!--
          <tbody>
            <tr *ngFor="let item of printsItems; let i = index">
              <td class="border px-2 py-1">
                {{ item.material.type }}<br />
                <span class="text-xs text-gray-500">
                  {{ item.material.caliber || "" }} -
                  {{ item.material.color || "" }}
                </span>
              </td>
              <td class="border px-2 py-1">{{ item.quantity }}</td>
              <td class="border px-2 py-1">{{ item.processes }}</td>
              <td class="border px-2 py-1">
                ${{ item.processed_unit_value | number : "1.0-0" }}
              </td>
              <td class="border px-2 py-1 text-center">
                <button
                  type="button"
                  class="text-red-600 font-bold"
                  (click)="removePrintItem(i)"
                >
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
          -->
          <!--
        </table>
        -->
        <!--
      </div>
      -->
      <!-- Campos específicos para Cortes -->
      <!-- removed userRole !='admin' requirement, otherwise admin can't select material-->
       <!--
      <div *ngIf="newOrder.order_type === 'laser'" class="mb-4 border-t pt-4">
        -->
        <!--
        <h4 class="font-semibold text-orange-600">Datos de Corte</h4>
        -->
        <!--
        <div class="px-4">
          -->
          <!-- Selección de Material -->
           <!--
          <div class="grid grid-cols-2 gap-4 mt-4">
            -->
            <!-- Categoría
            <div>
              <label class="block modal-input-item">Categoría</label>
              <select
                [(ngModel)]="selectedCategory"
                name="cutCategory"
                class="form-select mt-1 block w-full"
                (change)="
                  selectedType = ''; selectedCaliber = ''; selectedColor = ''
                "
              >
                <option value="">-- Seleccionar --</option>
                <option *ngFor="let cat of getUniqueCategories()" [value]="cat">
                  {{ cat }}
                </option>
              </select>
            </div>
            -->

            <!-- Tipo
            <div>
              <label class="block modal-input-item">Tipo</label>
              <select
                [(ngModel)]="selectedType"
                name="cutType"
                class="form-select mt-1 block w-full"
                (change)="selectedCaliber = ''; selectedColor = ''"
              >
                <option value="">-- Seleccionar --</option>
                <option *ngFor="let t of getFilteredTypes()" [value]="t">
                  {{ t }}
                </option>
              </select>
            </div>
            -->

            <!-- Calibre
            <div>
              <label class="block modal-input-item">Calibre</label>
              <select
                [(ngModel)]="selectedCaliber"
                name="cutCaliber"
                class="form-select mt-1 block w-full"
                (change)="selectedColor = ''"
              >
                <option value="">-- Seleccionar --</option>
                <option *ngFor="let c of getFilteredCalibers()" [value]="c">
                  {{ c }}
                </option>
              </select>
            </div>
            -->

            <!-- Color
            <div>
              <label class="block modal-input-item">Color</label>
              <select
                [(ngModel)]="selectedColor"
                name="cutColor"
                class="form-select mt-1 block w-full"
              >
                <option value="">-- Seleccionar --</option>
                <option *ngFor="let col of getFilteredColors()" [value]="col">
                  {{ col }}
                </option>
              </select>
            </div>
            -->
            <!--
          </div>
          -->

          <!-- Stock Disponible
          <div
            *ngIf="getSelectedMaterial() as sm"
            class="text-sm text-gray-600 mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md"
          >
            Stock disponible: <strong>{{ sm.material_quantity }}</strong>
          </div>
          -->

          <!--
          <div class="mt-4">
            <label class="block modal-input-item"
              >Valor Unitario del Material</label
            >
            <input
              type="number"
              [(ngModel)]="tempCutUnitaryValue"
              name="cutUnitaryValue"
              class="form-input mt-1 block w-full"
              min="0"
              placeholder="Ingrese el valor unitario"
            />
          </div>
          -->

          <!-- Cantidad y Tiempo de Corte
          <div class="grid grid-cols-2 gap-4 mt-4">
            -->
            <!--
            <div>
              <label class="block modal-input-item">Cantidad</label>
              <input
                type="number"
                [(ngModel)]="tempCutQuantity"
                name="cutQty"
                class="form-input mt-1 block w-full"
                min="1"
                placeholder="1"
              />
            </div>
            -->
            <!--
            <div>
              -->
              <!--
              <label class="block modal-input-item"
                >Tiempo de corte (min)</label
              >
              -->
              <!-- En el metodo que me arrojo la ia menciona en name cutting_time entonces
               comprobar con cual de los 2 funciona
              <input
                type="number"
                [(ngModel)]="tempCutTime"
                name="cutTime"
                class="form-input mt-1 block w-full"
                min="0"
                step="0.1"
                placeholder="0"
              />
              -->
              <!--
            </div>
            -->
            <!--
          </div>
          -->

          <!-- Medidas (Alto y Ancho)
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block modal-input-item">Alto (m)</label>
              <input
                type="number"
                [(ngModel)]="tempCutHeight"
                name="cutHeight"
                class="form-input mt-1 block w-full"
                min="0"
                step="0.01"
                placeholder="0"
              />
            </div>

            <div>
              <label class="block modal-input-item">Ancho (m)</label>
              <input
                type="number"
                [(ngModel)]="tempCutWidth"
                name="cutWidth"
                class="form-input mt-1 block w-full"
                min="0"
                step="0.01"
                placeholder="0"
              />
            </div>
          </div>
          -->

          <!-- Botón Añadir Material
          <div class="flex justify-center mt-6">
            <button type="button" (click)="addCutItem()" class="btn-add">
              Añadir Material
            </button>
          </div>
          -->

          <!-- Tabla de Materiales Agregados para CUTS
          <div *ngIf="newOrder.order_type === 'laser'" class="mt-6 mb-4">
            -->
            <!--
            <h4 class="font-semibold text-gray-700 mb-2">
              Materiales del Pedido
            </h4>
            -->

            <!-- Mensaje si está cargando
            <div
              *ngIf="cutsItems.length === 0 && isEditing"
              class="text-gray-500 text-sm mb-2"
            >
              Cargando materiales...
            </div>
            -->

            <!-- Mensaje si no hay items y NO está editando
            <div
              *ngIf="cutsItems.length === 0 && !isEditing"
              class="text-gray-500 text-sm mb-2"
            >
              No hay materiales agregados. Usa el formulario arriba para
              agregar.
            </div>
            -->

            <!-- Tabla de materiales
            <table
              *ngIf="cutsItems.length > 0"
              class="min-w-full text-sm border mt-2"
            >
            -->
              <!--
              <thead class="bg-gray-200">
                -->
                <!--
                <tr>
                  -->
                  <!--
                  <th class="border px-2 py-1">Material</th>
                  <th class="border px-2 py-1">Cant.</th>
                  <th class="border px-2 py-1">Tiempo (min)</th>
                  <th class="border px-2 py-1">Precio Total</th>
                  <th class="border px-2 py-1">Acción</th>
                  -->
                  <!--
                </tr>
                -->
                <!--
              </thead>
              -->
              <!--
              <tbody>
                -->
                <!--
                <tr *ngFor="let item of cutsItems; let i = index">
                  -->
                  <!--
                  <td class="border px-2 py-1">
                    {{ item.material.category }} - {{ item.material.type }}
                    <br />
                    <span class="text-xs text-gray-500">
                      {{ item.material.caliber
                      }}<span *ngIf="item.material.color">
                        - {{ item.material.color }}</span
                      >
                    </span>
                  </td>
                  -->
                  <!--
                  <td class="border px-2 py-1">{{ item.quantity }}</td>
                  -->
                  <!--
                  <td class="border px-2 py-1">{{ item.cutTime }}</td>
                  -->
                  <!--
                  <td class="border px-2 py-1">
                    {{ item.subtotal | number : "1.0-0" }}
                  </td>
                  -->
                  <!--
                  <td class="border px-2 py-1 text-center">
                    <button
                      type="button"
                      class="text-red-600 font-bold"
                      (click)="removeCutItem(i)"
                    >
                      Eliminar
                    </button>
                  </td>
                  -->
                  <!--
                </tr>
                -->
                <!--
              </tbody>
              -->
              <!--
            </table>
            -->
            <!--
          </div>
          -->
          <!--
        </div>
        -->
        <!--
      </div>
      -->
      <!-- Sección de Datos Específicos para Sales -->
      <div *ngIf="newOrder.order_type === 'sales'" class="mb-4 border-t pt-4">
        <!--
        <h4 class="font-semibold text-green-700">Datos de Venta</h4>
        -->

        <!-- ¿Qué vas a vender?
        <label class="block mt-2 modal-input-item">¿Qué vas a vender?</label>
        -->
        <!--
        <select
          [(ngModel)]="saleMode"
          name="saleMode"
          class="form-select mt-1 block w-full"
        >
          <option value="none">-- Seleccionar --</option>
          <option value="material">Material</option>
          <option value="product">Producto</option>
        </select>
        -->

        <!-- VENTA: MATERIAL  -->
         <!--
        <div *ngIf="saleMode === 'material'">
          -->
          <!-- Encadenado: CATEGORÍA
          <label class="block mt-2 modal-input-item">Categoría</label>
          -->
          <!--
          <select
            [(ngModel)]="selectedCategory"
            name="sale_category"
            class="form-select mt-1 block w-full"
            (change)="
              selectedType = ''; selectedCaliber = ''; selectedColor = ''
            "
          >
            <option value="">-- Seleccionar --</option>
            <option *ngFor="let c of getUniqueCategories()" [value]="c">
              {{ c }}
            </option>
          </select>
          -->

          <!-- Encadenado: TIPO
          <label class="block mt-2 modal-input-item">Tipo</label>
          -->
          <!--
          <select
            [(ngModel)]="selectedType"
            name="sale_type"
            class="form-select mt-1 block w-full"
            (change)="selectedCaliber = ''; selectedColor = ''"
          >
            <option value="">-- Seleccionar --</option>
            <option *ngFor="let t of getFilteredTypes()" [value]="t">
              {{ t }}
            </option>
          </select>
          -->

          <!-- Encadenado: CALIBRE
          <label class="block mt-2 modal-input-item">Calibre</label>
          -->
          <!--
          <select
            [(ngModel)]="selectedCaliber"
            name="sale_caliber"
            class="form-select mt-1 block w-full"
            (change)="selectedColor = ''"
          >
            <option value="">-- Seleccionar --</option>
            <option *ngFor="let cal of getFilteredCalibers()" [value]="cal">
              {{ cal }}
            </option>
          </select>
          -->

          <!-- Encadenado: COLOR
          <label class="block mt-2 modal-input-item">Color</label>
          -->
          <!--
          <select
            [(ngModel)]="selectedColor"
            name="sale_color"
            class="form-select mt-1 block w-full"
          >
            <option value="">-- Seleccionar --</option>
            <option *ngFor="let col of getFilteredColors()" [value]="col">
              {{ col }}
            </option>
          </select>
          -->

          <!-- Info de stock del material seleccionado
          <div
            class="text-sm text-gray-600 mt-2"
            *ngIf="getSelectedMaterial() as sm"
          >
            Stock disponible: <strong>{{ sm.material_quantity }}</strong>
          </div>
          -->

          <!-- Datos económicos de la línea de venta
          <label class="block mt-2 modal-input-item">Cantidad a vender</label>
          -->
          <!--
          <input
            [(ngModel)]="saleMaterialQuantity"
            type="number"
            min="1"
            name="sale_material_qty"
            class="form-input mt-1 block w-full"
          />
          -->
          <!--
          <label class="block mt-2 modal-input-item">Precio unitario</label>
          -->
          <!--
          <input
            [(ngModel)]="saleMaterialUnitPrice"
            type="number"
            min="0"
            name="sale_material_unit_price"
            class="form-input mt-1 block w-full"
            placeholder="Ej: 12000"
          />
          -->
          <!--
        </div>
        -->
        <!-- VENTA DE PRODUCTO
        <div
          *ngIf="newOrder.order_type === 'sales' && saleMode === 'product'"
          class="mb-4 border-t pt-4"
        >
         -->
          <!--
          <h4 class="font-semibold text-emerald-600">
            Datos de Venta: Producto
          </h4>
          -->

          <!-- Producto
          <label class="block mt-2 modal-input-item">Producto</label>
          -->
          <!--
          <select
            [(ngModel)]="selectedProductId"
            name="selectedProductId"
            class="form-select mt-1 block w-full"
            (change)="onProductChange()"
          >
            <option value="">-- Seleccionar --</option>
            <option *ngFor="let p of allProducts" [value]="p.id">
              {{ p.name }} — Stock: {{ p.stock }} — ${{ p.price }}
            </option>
          </select>
          -->

          <!-- Cantidad
          <label class="block mt-2 modal-input-item">Cantidad a vender</label>
          -->
          <!--
          <input
            [(ngModel)]="saleMaterialQuantity"
            type="number"
            min="1"
            step="1"
            name="saleProductQty"
            class="form-input mt-1 block w-full"
          />
          -->

          <!-- P. Unitario
          <label class="block mt-2 modal-input-item">Precio unitario</label>
          -->
          <!--
          <input
            [(ngModel)]="saleMaterialUnitPrice"
            type="number"
            min="0"
            step="0.01"
            inputmode="decimal"
            name="saleProductUnitPrice"
            class="form-input mt-1 block w-full"
            placeholder="Autollenado al elegir producto (editable)"
          />
          -->
          <!--
        </div>
         -->

         <!--
        <button
          type="button"
          (click)="addSaleItem()"
          class="mt-3 bg-green-600 text-white px-3 py-1 rounded"
        >
          Agregar ítem
        </button>
         -->

        <!--  LÍNEAS AGREGADAS  -->
          <!--
        <div *ngIf="salesItems.length > 0" class="mt-4">
           -->
          <!--
          <h4 class="font-semibold text-gray-700 mb-2">Items agregados</h4>
           -->
          <!--
          <table class="min-w-full text-sm border">
             -->
            <!--
            <thead class="bg-gray-200">
              <tr>
                <th class="border px-2 py-1">Detalle</th>
                <th class="border px-2 py-1">Cant</th>
                <th class="border px-2 py-1">Unit</th>
                <th class="border px-2 py-1">Subtotal</th>
                <th class="border px-2 py-1"></th>
              </tr>
            </thead>
             -->
            <!--
            <tbody>
              <tr *ngFor="let item of salesItems; let i = index">
                <td class="border px-2 py-1">
                  <ng-container *ngIf="item.mode === 'material'">
                    {{ item.material.category }} / {{ item.material.type }} /
                    {{ item.material.caliber }} /
                    {{ item.material.color }}
                  </ng-container>
                  <ng-container *ngIf="item.mode === 'product'">
                    {{ item.product.name }}
                  </ng-container>
                </td>

                <td class="border px-2 py-1">{{ item.quantity }}</td>
                <td class="border px-2 py-1">
                  {{ item.unit_price | number : "1.0-0" }}
                </td>
                <td class="border px-2 py-1">
                  {{ item.subtotal | number : "1.0-0" }}
                </td>

                <td class="border px-2 py-1 text-center">
                  <button
                    type="button"
                    (click)="removeSaleItem(i)"
                    class="text-red-600 font-bold"
                  >
                    X
                  </button>
                </td>
              </tr>
            </tbody>
             -->
            <!--
          </table>
           -->
          <!--
        </div>
         -->
      </div>
      <!-- Archivo adjunto -->
      <div class="mb-4">
        <label class="block modal-input-item">Archivo adjunto</label>
        <input type="file" (change)="onFileSelected($event)" />

        <p *ngIf="uploadedFileName" class="text-green-600 text-sm mt-1">
          Archivo subido: {{ uploadedFileName }}
        </p>
      </div>
      <div class="flex justify-end mt-4">
        <button type="button" class="btn-danger" (click)="toggleAddOrderForm()">
          Cancelar
        </button>
        <button type="submit" class="btn-success ml-2">Guardar Pedido</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para añadir cliente -->
<div *ngIf="showAddClientModal" class="modal-overlay">
  <div class="modal-content w-1/2">
    <h2 class="text-xl font-bold mb-4">Añadir Nuevo Cliente</h2>
    <form (ngSubmit)="saveNewClient()">
      <div class="mb-4">
        <label class="block text-gray-700">Nombre</label>
        <input
          [(ngModel)]="newClient.name"
          name="name"
          class="form-input"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Correo Electrónico</label>
        <input
          type="email"
          [(ngModel)]="newClient.email"
          name="email"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Tipo de Documento</label>
        <select
          [(ngModel)]="newClient.document_type"
          name="document_type"
          class="form-select"
        >
          <option value="NIT">NIT</option>
          <option value="Registro civil">Registro civil</option>
          <option value="Tarjeta de identidad">Tarjeta de identidad</option>
          <option value="Cédula de ciudadanía">Cédula de ciudadanía</option>
          <option value="Tarjeta de extranjería">Tarjeta de extranjería</option>
          <option value="Cédula de extranjería">
            Cédula de extranjería
          </option>
          <option value="Pasaporte">Pasaporte</option>
          <option value="Documento de identificación extranjero">
            Documento de identificación extranjero
          </option>
          <option value="NIT de otro país">NIT de otro país</option>
          <option value="NUIP">NUIP</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Identificación/Documento</label>
        <input
          [(ngModel)]="newClient.document_number"
          name="document_number"
          class="form-input"
        />
      </div>
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Empresa</label>
        <input
          [(ngModel)]="newClient.company_name"
          name="company_name"
          class="form-input"
        />
      </div>
      -->
      <div class="mb-4">
        <label class="block text-gray-700">Teléfono</label>
        <input
          type="number"
          [(ngModel)]="newClient.cellphone"
          name="cellphone"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Dirección</label>
        <input
          type="text"
          [(ngModel)]="newClient.address"
          name="address"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Estado</label>
        <select
          [(ngModel)]="newClient.status"
          name="status"
          class="form-select mt-1 block w-full"
        >
          <option value="upToDate">Al Día</option>
          <option value="overdue">En Mora</option>
        </select>
      </div>
      <div class="flex justify-end">
        <button
          type="button"
          class="btn-danger"
          (click)="closeAddClientModal()"
        >
          Cancelar
        </button>
        <button type="submit" class="btn-success px-4 py-2 rounded-md">
          Guardar Cliente
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Calculadora -->
 <!--
<div
  *ngIf="showCalculator"
  class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50"
>
-->
  <!--
  <div
    class="bg-white w-[500px] max-w-[90vw] rounded-lg shadow-lg p-6 max-h-[90vh] overflow-y-auto"
  >
  -->
    <!--
    <h3 class="text-lg font-bold mb-4">Calculadora</h3>
     -->

    <!-- calculator type
    <div class="mb-4">
      <label class="block text-gray-700">¿Qué desea calcular?</label>
      <select
        [(ngModel)]="calculationType"
        (change)="resetForm()"
        class="form-select mt-1 block w-full"
      >
        <option [ngValue]="null">Seleccione una opción</option>
        <option value="prints">Impresiones</option>
        <option value="cuts">Cortes</option>
      </select>
    </div>
     -->

    <!-- Tipo de cliente
    <div class="mb-4" *ngIf="calculationType">
      <label class="block text-gray-700">Tipo de Cliente</label>
      <select
        [(ngModel)]="clientType"
        (change)="setValoresPorCliente()"
        class="form-select mt-1 block w-full"
      >
        <option [ngValue]="null">Seleccione un tipo</option>
        <option value="intermediary">Intermediario</option>
        <option value="final">Final</option>
      </select>
    </div>
    -->

    <!-- Calculadora de impresiones
    <div *ngIf="calculationType === 'prints'">
      -->
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Ancho del rollo (m)</label>
        <input
          type="number"
          [(ngModel)]="rollWidth"
          name="rollWidth"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      -->
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Medición (m)</label>
        <input
          type="number"
          [(ngModel)]="measurement"
          name="measurement"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      -->
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Valor del material</label>
        <input
          type="number"
          [(ngModel)]="materialValue"
          name="materialValue"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      -->
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Número de productos</label>
        <input
          type="number"
          [(ngModel)]="productNumber"
          name="productNumber"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      -->
      <!--
      <div class="mb-4">
        -->
        <!--
        <label class="block text-gray-700">Opciones</label>
        -->
        <!--
        <div class="flex gap-4 mt-2">
          -->
          <!--
          <label
            ><input
              type="checkbox"
              [(ngModel)]="lamination"
              name="lamination"
              (change)="calculatePrice()"
            />
            Laminado</label
          >
          -->
          <!--
          <label
            ><input
              type="checkbox"
              [(ngModel)]="pPrint"
              name="pPrint"
              (change)="calculatePrice()"
            />
            Impresión</label
          >
          -->
          <!--
          <label
            ><input
              type="checkbox"
              [(ngModel)]="stamping"
              name="stamping"
              (change)="calculatePrice()"
            />
            Troquelado</label
          >
          -->
          <!--
          <label
            ><input
              type="checkbox"
              [(ngModel)]="assemble"
              name="assemble"
              (change)="calculatePrice()"
            />
            Ensamblado</label
          >
          -->
          <!--
        </div>
        -->
        <!--
      </div>
      -->
      <!--
    </div>
    -->

    <!-- Calculadora de cortes
    <div *ngIf="calculationType === 'cuts'">
      -->
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Valor del material</label>
        <input
          type="number"
          [(ngModel)]="materialValue"
          name="materialValue"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      -->
      <!--
      <div class="mb-4">
        <label class="block text-gray-700">Tiempo de uso (min)</label>
        <input
          type="number"
          [(ngModel)]="usageTime"
          name="usageTime"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      -->
      <!--
    </div>
    -->

    <!-- Resultado
    <div class="mb-4" *ngIf="calculatorResult > 0">
      <p class="font-bold">Resultado: {{ calculatorResult }} COP</p>
    </div>
    -->

    <!--
    <div class="flex justify-end mt-4">
      -->
      <!--
      <button type="button" class="btn-danger" (click)="closeCalculator()">
        Cerrar
      </button>
      -->
      <!--
    </div>
    -->
    <!--
  </div>
  -->
  <!--
</div>
-->

<!--
<div *ngIf="showStockWarningModal" class="modal-overlay top">
  <div class="modal-content modal-h250 top">
    <h3 class="text-lg font-bold mb-4">Stock insuficiente</h3>

    <p class="mb-6">{{ stockWarningMessage }}</p>

    <div class="flex justify-end">
      <button class="btn-primary" (click)="closeStockModal()">Cerrar</button>
    </div>
  </div>
</div>
 -->

<!-- Notificación temporal -->
<div
  *ngIf="notificationMessage"
  class="fixed top-4 right-4 bg-green-500 text-white p-2 rounded shadow-md z-50"
>
  {{ notificationMessage }}
</div>
