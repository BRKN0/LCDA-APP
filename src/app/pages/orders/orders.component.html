<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<!-- Indicador de carga -->
<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando pedidos...</p>
</div>

<!-- Filters -->
<div
  *ngIf="userRole == 'admin'"
  class="flex justify-between items-center mb-4 mt-4 ml-2"
>
  <div class="flex space-x-2">
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showPrints"
        (change)="updateFilteredOrders()"
      />
      Impresiones
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showCuts"
        (change)="updateFilteredOrders()"
      />
      Cortes
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showSales"
        (change)="updateFilteredOrders()"
      />
      Ventas
    </label>
  </div>
  <div class="flex space-x-2 mr-4">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="toggleAddOrderForm()"
    >
      <svg
        class="w-5 h-5 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12.75 9C12.75 8.58579 12.4142 8.25 12 8.25C11.5858 8.25 11.25 8.58579 11.25 9L11.25 11.25H9C8.58579 11.25 8.25 11.5858 8.25 12C8.25 12.4142 8.58579 12.75 9 12.75H11.25V15C11.25 15.4142 11.5858 15.75 12 15.75C12.4142 15.75 12.75 15.4142 12.75 15L12.75 12.75H15C15.4142 12.75 15.75 12.4142 15.75 12C15.75 11.5858 15.4142 11.25 15 11.25H12.75V9Z"
          fill="#ffffff"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
          fill="#ffffff"
        />
      </svg>
      <span>Añadir</span>
    </button>
    <button
      class="btn-details inline-flex items-center space-x-2"
      (click)="openCalculator()"
    >
      <svg
        class="w-8 h-8 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g
          id="SVGRepo_tracerCarrier"
          stroke-linecap="round"
          stroke-linejoin="round"
        ></g>
        <g id="SVGRepo_iconCarrier">
          <path
            d="M14 7C14 6.44771 14.4477 6 15 6H16V5C16 4.44772 16.4477 4 17 4C17.5523 4 18 4.44772 18 5V6H19C19.5523 6 20 6.44771 20 7C20 7.55229 19.5523 8 19 8H18V9C18 9.55228 17.5523 10 17 10C16.4477 10 16 9.55228 16 9V8H15C14.4477 8 14 7.55229 14 7Z"
            fill="#ffffff"
          ></path>
          <path
            d="M14 15C14 14.4477 14.4477 14 15 14H19C19.5523 14 20 14.4477 20 15C20 15.5523 19.5523 16 19 16H15C14.4477 16 14 15.5523 14 15Z"
            fill="#ffffff"
          ></path>
          <path
            d="M15 18C14.4477 18 14 18.4477 14 19C14 19.5523 14.4477 20 15 20H19C19.5523 20 20 19.5523 20 19C20 18.4477 19.5523 18 19 18H15Z"
            fill="#ffffff"
          ></path>
          <path
            d="M5 6C4.44772 6 4 6.44771 4 7C4 7.55229 4.44772 8 5 8H9C9.55228 8 10 7.55229 10 7C10 6.44771 9.55228 6 9 6H5Z"
            fill="#ffffff"
          ></path>
          <path
            d="M5.92512 14.5109C5.5346 14.1204 4.90143 14.1204 4.51091 14.5109C4.12039 14.9014 4.12039 15.5346 4.51091 15.9251L5.5858 17L4.50337 18.0824C4.11284 18.4729 4.11284 19.1061 4.50337 19.4966C4.89389 19.8872 5.52705 19.8872 5.91758 19.4966L7.00002 18.4142L8.08944 19.5036C8.47996 19.8941 9.11313 19.8941 9.50365 19.5036C9.89418 19.1131 9.89418 18.4799 9.50365 18.0894L8.41423 17L9.50194 15.9123C9.89246 15.5218 9.89246 14.8886 9.50194 14.4981C9.11141 14.1075 8.47825 14.1075 8.08772 14.4981L7.00002 15.5858L5.92512 14.5109Z"
            fill="#ffffff"
          ></path>
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M20 1C21.6569 1 23 2.34315 23 4V20C23 21.6569 21.6569 23 20 23H4C2.34315 23 1 21.6569 1 20V4C1 2.34315 2.34315 1 4 1H20ZM20 3C20.5523 3 21 3.44772 21 4V11H13V3H20ZM21 13V20C21 20.5523 20.5523 21 20 21H13V13H21ZM4 3H11V11H3V4C3 3.44772 3.44772 3 4 3ZM3 20V13H11V21H4C3.44772 21 3 20.5523 3 20Z"
            fill="#ffffff"
          ></path>
        </g>
      </svg>
      <span>Calculadora</span>
    </button>
  </div>
</div>

<!-- Search bars -->
<div class="flex items-center justify-center py-4 space-x-4 top-5">
  <!-- Buscar por nombre de cliente -->
  <div class="relative w-full max-w-md">
    <input
      type="text"
      placeholder="Buscar por nombre de cliente..."
      [(ngModel)]="searchByNameQuery"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
      (input)="updateFilteredOrders()"
    />
  </div>
  <!-- Buscar por número de pedido -->
  <div class="relative w-full max-w-md">
    <input
      type="text"
      placeholder="Buscar pedido por número..."
      [(ngModel)]="searchQuery"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
    <button
      class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-700 w-auto"
      (click)="onSearch()"
    >
      Buscar
    </button>
  </div>
</div>
<div class="flex items-center space-x-4">
  <div>
    <label for="startDate" class="mr-2 font-semibold">Desde:</label>
    <input
      type="date"
      id="startDate"
      [(ngModel)]="startDate"
      (ngModelChange)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
    <input
      type="date"
      id="endDate"
      [(ngModel)]="endDate"
      (ngModelChange)="updateFilteredOrders()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
</div>

<!-- Orders Table -->
<div *ngIf="!loading" class="mt-4">
  <table class="table-std">
    <thead>
      <ng-container *ngIf="userRole === 'admin'; else notAdminHeader">
        <tr>
          <th class="table-column-std">Código</th>
          <th class="table-column-std">Tipo</th>
          <th class="table-column-std">Cliente</th>
          <th class="table-column-std">Tipo de cliente</th>
          <th class="table-column-std">Estado de pago</th>
          <th class="table-column-std">Estado de trabajo</th>
          <th class="table-column-std">Fecha</th>
          <th class="table-column-std">Fecha de Entrega</th>
          <th class="table-column-std">Días Restantes</th>
          <th class="table-column-std">Total</th>
          <th class="table-column-std">Confirmación</th>
          <th class="table-column-std">Acción</th>
        </tr>
      </ng-container>
      <ng-template #notAdminHeader>
        <tr>
          <th class="table-column-std">Código</th>
          <th class="table-column-std">Tipo</th>
          <th class="table-column-std">Cliente</th>
          <th class="table-column-std">Estado de pago</th>
          <th class="table-column-std">Estado de trabajo</th>
          <th class="table-column-std">Fecha</th>
          <th class="table-column-std">Fecha de Entrega</th>
          <th class="table-column-std">Días Restantes</th>
          <th class="table-column-std">Acción</th>
          <th class="table-column-std">Confirmación de Orden</th>
        </tr>
      </ng-template>
    </thead>

    <tbody>
      <ng-container *ngIf="userRole === 'admin'; else notAdminBody">
        <tr *ngFor="let order of paginatedOrders">
          <td>{{ order.code }}</td>
          <td>
            {{
              order.order_type === "print"
                ? "Impresiones"
                : order.order_type === "laser"
                ? "Cortes"
                : order.order_type === "sales"
                ? "Ventas"
                : "Desconocido"
            }}
          </td>
          <td>{{ order.name }}</td>
          <td>
            {{
              order.client_type === "finall"
                ? "Final"
                : order.client_type === "intermediary"
                ? "Intermediario"
                : "Desconocido"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_payment_status === 'upToDate',
              'text-red-600': order.order_payment_status === 'overdue'
            }"
          >
            {{
              order.order_payment_status === "upToDate"
                ? "Al Día"
                : order.order_payment_status === "overdue"
                ? "En Mora"
                : "Desconocido"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-red-600': order.order_completion_status === 'standby',
              'text-orange-400': order.order_completion_status === 'inProgress'
            }"
          >
            <select
              class="border rounded p-1"
              [(ngModel)]="order.order_completion_status"
              (change)="toggleOrderCompletionStatus(order)"
            >
              <option value="finished">Terminado</option>
              <option value="standby">En espera</option>
              <option value="inProgress">En progreso</option>
            </select>
          </td>
          <td>{{ order.created_at | date : "dd-MM-yyyy" }}</td>
          <td>
            {{
              order.delivery_date
                ? (order.delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-blue-600':
                order.order_completion_status !== 'finished' &&
                getRemainingDeliveryDays(order) > 0,
              'text-red-600':
                order.order_completion_status !== 'finished' &&
                getRemainingDeliveryDays(order) <= 0
            }"
          >
            {{
              order.order_completion_status === "finished"
                ? "Completo"
                : getRemainingDeliveryDays(order) > 0
                ? getRemainingDeliveryDays(order) + " días"
                : "Vencido"
            }}
          </td>
          <td>{{ order.total }}</td>
          <td
            [ngClass]="{
              'text-green-600': order.order_confirmed_status === 'confirmed',
              'text-orange-400': order.order_confirmed_status === 'notConfirmed'
            }"
          >
            {{
              order.order_confirmed_status === "confirmed"
                ? "Confirmado"
                : order.order_confirmed_status === "notConfirmed"
                ? "En espera"
                : "Desconocido"
            }}
          </td>
          <td>
            <button class="btn-details" (click)="selectOrder(order)">
              Detalles
            </button>
            <button class="btn-edit" (click)="editOrder(order)">Editar</button>
            <button
              *ngIf="userRole == 'admin'"
              class="btn-delete"
              (click)="deleteOrder(order)"
            >
              Eliminar
            </button>
          </td>
        </tr>
      </ng-container>

      <ng-template #notAdminBody>
        <tr *ngFor="let order of paginatedOrders">
          <td>{{ order.code }}</td>
          <td>
            {{
              order.order_type === "print"
                ? "Impresiones"
                : order.order_type === "laser"
                ? "Cortes"
                : order.order_type === "sales"
                ? "Ventas"
                : "Desconocido"
            }}
          </td>
          <td>{{ order.name }}</td>
          <td
            [ngClass]="{
              'text-green-600': order.order_payment_status === 'upToDate',
              'text-red-600': order.order_payment_status === 'overdue'
            }"
          >
            {{
              order.order_payment_status === "upToDate"
                ? "Al Día"
                : order.order_payment_status === "overdue"
                ? "En Mora"
                : "Desconocido"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-red-600': order.order_completion_status === 'standby',
              'text-orange-400': order.order_completion_status === 'inProgress'
            }"
          >
            <select
              class="border rounded p-1"
              [(ngModel)]="order.order_completion_status"
              (change)="toggleOrderCompletionStatus(order)"
            >
              <option value="finished">Terminado</option>
              <option value="standby">En espera</option>
              <option value="inProgress">En progreso</option>
            </select>
          </td>
          <td>{{ order.created_at | date : "dd-MM-yyyy" }}</td>
          <td>
            {{
              order.delivery_date
                ? (order.delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </td>
          <td
            [ngClass]="{
              'text-green-600': order.order_completion_status === 'finished',
              'text-blue-600':
                order.order_completion_status !== 'finished' &&
                getRemainingDeliveryDays(order) > 0,
              'text-red-600':
                order.order_completion_status !== 'finished' &&
                getRemainingDeliveryDays(order) <= 0
            }"
          >
            {{
              order.order_completion_status === "finished"
                ? "Completo"
                : getRemainingDeliveryDays(order) > 0
                ? getRemainingDeliveryDays(order) + " días"
                : "Vencido"
            }}
          </td>
          <td>
            <button class="btn-details" (click)="selectOrder(order)">
              Detalles
            </button>
            <button class="btn-edit" (click)="editOrder(order)">Editar</button>
            <button
              *ngIf="userRole == 'admin'"
              class="btn-delete"
              (click)="deleteOrder(order)"
            >
              Eliminar
            </button>
          </td>
          <td>
            <label>
              <input
                type="checkbox"
                [checked]="order.order_confirmed_status === 'confirmed'"
                (change)="toggleOrderConfirmedStatus(order)"
              />
            </label>
          </td>
        </tr>
      </ng-template>
    </tbody>
  </table>
</div>

<!-- Mensaje de no resultados para búsqueda por nombre -->
<div *ngIf="noResultsFound" class="p-4 text-center text-gray-600">
  <p>No hay coincidencias con la búsqueda.</p>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedOrder()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      ⇐
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedOrder()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700">
      Página {{ currentPage }} de {{ totalPages }}
    </span>
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedOrder()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedOrder()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      ⇒
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedOrder()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Show details of the selected order -->
<div
  *ngIf="
    selectedOrderDetails && selectedOrderDetails.length > 0 && !loadingDetails
  "
  class="modal-overlay"
>
  <div class="modal-content">
    <h2 class="text-xl font-bold">Detalles de Pedido</h2>
    <!-- Printable Invoice Layout -->
    <div class="p-4 border border-gray-300 bg-white invoice-details">
      <div class="flex justify-between mb-4">
        <div>
          <h3 class="font-semibold text-lg">
            Pedido N°: {{ selectedOrderDetails[0].code }}
          </h3>
          <p>
            <strong>Fecha:</strong>
            {{ selectedOrderDetails[0].created_at | date : "dd-MM-yyyy" }}
          </p>
          <p>
            <strong>Fecha de Entrega:</strong>
            {{
              selectedOrderDetails[0].delivery_date
                ? (selectedOrderDetails[0].delivery_date | date : "dd-MM-yyyy")
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Estado de trabajo:</strong>
            {{
              selectedOrderDetails[0].order_completion_status === "finished"
                ? "Completado"
                : selectedOrderDetails[0].order_completion_status === "standby"
                ? "En espera"
                : selectedOrderDetails[0].order_completion_status ===
                  "inProgress"
                ? "En progreso"
                : "Desconocido"
            }}
          </p>
          <p>
            <strong>Confirmación del pedido:</strong>
            {{
              selectedOrderDetails[0].order_confirmed_status === "confirmed"
                ? "Confirmado"
                : selectedOrderDetails[0].order_confirmed_status ===
                  "notConfirmed"
                ? "Por Confirmar"
                : "Desconocido"
            }}
          </p>
          <p>
            <strong>Estado de entrega:</strong>
            {{
              selectedOrderDetails[0].order_delivery_status === "onTime"
                ? "A tiempo"
                : selectedOrderDetails[0].order_delivery_status === "late"
                ? "Tarde"
                : selectedOrderDetails[0].order_delivery_status ===
                  "toBeDelivered"
                ? "En espera"
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Estado de pago:</strong>
            {{
              selectedOrderDetails[0].order_payment_status === "overdue"
                ? "En Mora"
                : selectedOrderDetails[0].order_payment_status === "upToDate"
                ? "Al Día"
                : "No especificado"
            }}
          </p>
          <p>
            <strong>Tipo:</strong>
            {{
              selectedOrderDetails[0].order_type === "laser"
                ? "Corte Laser"
                : selectedOrderDetails[0].order_type === "print"
                ? "Impresión"
                : selectedOrderDetails[0].order_type === "sales"
                ? "Ventas"
                : "Otro"
            }}
          </p>
        </div>
        <div class="text-right">
          <p>
            <strong>De:</strong>
            {{ selectedOrderDetails[0].name }}
          </p>
        </div>
      </div>

      <!-- Itemized Invoice List -->
      <div class="my-6">
        <ul class="list-none">
          <li>
            <p>
              <strong>Descripción:</strong>
              {{ selectedOrderDetails[0].description }}
            </p>
            <p class="text-red-600"><strong>Notas:</strong> {{ selectedOrderDetails[0].notes }}</p>
            <p>
              <strong>Cantidad:</strong>
              {{ selectedOrderDetails[0].order_quantity }}
            </p>
            <p>
              <strong>Valor Unitario:</strong>
              {{ selectedOrderDetails[0].unitary_value }}
            </p>
            <p *ngIf="selectedOrderDetails[0].iva">
              <strong>IVA:</strong> {{ selectedOrderDetails[0].iva }}
            </p>
          </li>
        </ul>
      </div>
      <!-- Specific details for cuts -->
      <div *ngIf="selectedOrderDetails[0].order_type === 'laser'" class="my-6">
        <ul class="list-none">
          <li>
            <p>
              <strong>Categoría:</strong> {{ selectedOrderTypeDetail[0].category }}
            </p>
            <p>
              <strong>Tipo de Material:</strong>
              {{ selectedOrderTypeDetail[0].material_type }}
            </p>
            <p>
              <strong>Calibre:</strong> {{ selectedOrderTypeDetail[0].caliber }}
            </p>
            <p>
              <strong>Color:</strong> {{ selectedOrderTypeDetail[0].color }}
            </p>
            <p>
              <strong>Cantidad Usada:</strong>
              {{ selectedOrderTypeDetail[0].quantity }}
            </p>
            <p>
              <strong>Dimensiones:</strong>
              {{ selectedOrderTypeDetail[0].height }} X
              {{ selectedOrderTypeDetail[0].width }}
            </p>
            <p>
              <strong>Tiempo de corte:</strong>
              {{ selectedOrderTypeDetail[0].cutting_time }} mins
            </p>
          </li>
        </ul>
      </div>
      <!-- Specific details for prints -->
      <div *ngIf="selectedOrderDetails[0].order_type === 'print'" class="my-6">
        <ul class="list-none">
          <li>
            <p>
              <strong>Material:</strong>
              {{ selectedOrderTypeDetail[0].material }}
            </p>
            <p>
              <strong>Tipo de Material:</strong>
              {{ selectedOrderTypeDetail[0].material_type }}
            </p>
            <p>
              <strong>P. Laminado:</strong>
              {{ selectedOrderTypeDetail[0].laminating ? "Si" : "-" }}
              <strong>P. Impresión:</strong>
              {{ selectedOrderTypeDetail[0].printing ? "Si" : "-" }}
              <strong>P. Troquelado:</strong>
              {{ selectedOrderTypeDetail[0].die_cutting ? "Si" : "-" }}
              <strong>P. Armado:</strong>
              {{ selectedOrderTypeDetail[0].assembly ? "Si" : "-" }}
            </p>
            <p>
              <strong>Número de producto:</strong>
              {{ selectedOrderTypeDetail[0].product_number }}
            </p>
            <p>
              <strong>Cantidad Usada:</strong>
              {{ selectedOrderTypeDetail[0].quantity }}
            </p>
            <p>
              <strong>Producto Dañado:</strong>
              {{ selectedOrderTypeDetail[0].damaged_material }}
            </p>
          </li>
        </ul>
      </div>
      <!-- Totals Section -->
      <div class="border-t pt-4 mt-4">
        <div class="flex justify-between">
          <p><strong>Subtotal:</strong></p>
          <p>{{ selectedOrderDetails[0].subtotal }}</p>
        </div>
        <div class="flex justify-between">
          <p *ngIf="selectedOrderDetails[0].iva"><strong>IVA:</strong></p>
          <p>{{ selectedOrderDetails[0].iva }}</p>
        </div>
        <div class="flex justify-between">
          <p><strong>Total:</strong></p>
          <p class="font-bold">{{ selectedOrderDetails[0].total }}</p>
        </div>
      </div>
      <div class="flex justify-end mt-4">
      <button
        type="button"
        class="btn-danger"
        (click)="selectedOrderDetails = null"
      >
        Cerrar
      </button>
      </div>
    </div>
  </div>
</div>

<!-- Form to add orders -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content">
    <h3 class="text-lg font-bold mb-4">Pedido</h3>

    <form (ngSubmit)="addOrder(newOrder)">
      <!-- Campos comunes -->
      <div class="mb-4">
        <label class="block modal-input-item">Tipo de Pedido</label>
        <select
          [(ngModel)]="newOrder.order_type"
          name="order_type"
          class="form-select mt-1 block w-full"
          required
        >
          <option value="print">Impresiones</option>
          <option value="laser">Cortes</option>
          <option value="sales">Ventas</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block modal-input-item"
          >Cliente<span class="text-red-500">*</span></label
        >
        <select
          [(ngModel)]="newOrder.id_client"
          name="id_client"
          class="form-select mt-1 block w-full"
          required
        >
          <option value="" disabled selected>Seleccione un cliente</option>
          <option *ngFor="let client of clients" [value]="client.id_client">
            {{ client.name }}
          </option>
        </select>
        <button
          *ngIf="!isEditing"
          type="button"
          class="btn-primary mt-2"
          (click)="openAddClientModal()"
        >
          Añadir nuevo cliente
        </button>
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Tipo de Cliente</label>
        <select
          [(ngModel)]="newOrder.client_type"
          name="clie_type"
          class="form-select mt-1 block w-full"
          required
        >
          <option value="intermediary">Intermediario</option>
          <option value="finall">Final</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Descripción</label>
        <textarea
          [(ngModel)]="newOrder.description"
          name="description"
          class="form-textarea mt-1 block w-full"
        ></textarea>
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Cantidad</label>
        <input
          type="number"
          [(ngModel)]="newOrder.order_quantity"
          name="order_quantity"
          class="form-input mt-1 block w-full"
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Notas</label>
        <input
          [(ngModel)]="newOrder.notes"
          name="notes"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Fecha de Entrega<span class="text-red-500">*</span></label>
        <input
          type="date"
          [(ngModel)]="newOrder.delivery_date"
          name="delivery_date"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Total</label>
        <input
          type="number"
          [(ngModel)]="newOrder.total"
          name="total"
          class="form-input mt-1 block w-full"
          required
        />
      </div>

      <!-- Campos específicos para Impresiones -->
      <div
        *ngIf="newOrder.order_type === 'print' && userRole != 'admin'"
        class="mb-4 border-t pt-4"
      >
        <h4 class="font-semibold text-red-600">Datos de Impresión</h4>
        <label class="block mt-2 modal-input-item">Material</label>
        <input
          [(ngModel)]="newPrint.material"
          name="material"
          class="form-input mt-1 block w-full"
        />

        <label class="block mt-2 modal-input-item">Tipo de Material</label>
        <input
          [(ngModel)]="newPrint.material_type"
          name="material_type"
          class="form-input mt-1 block w-full"
        />

        <label class="block mt-2 modal-input-item">Número de producto</label>
        <input
          [(ngModel)]="newPrint.product_number"
          name="product_number"
          class="form-input mt-1 block w-full"
        />

        <label class="block modal-input-item">Ancho del rollo (m)</label>
        <input
          type="number"
          [(ngModel)]="rollWidth"
          name="rollWidth"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />

        <label class="block modal-input-item">Medición (m)</label>
        <input
          type="number"
          [(ngModel)]="measurement"
          name="measurement"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />

        <label class="block mt-2 modal-input-item">Material dañado</label>
        <input
          [(ngModel)]="newPrint.damaged_material"
          name="damaged_material"
          class="form-input mt-1 block w-full"
        />

        <!-- Checkboxes -->
        <div class="flex gap-4 mt-2">
          <label
            ><input
              type="checkbox"
              [(ngModel)]="newPrint.laminating"
              name="laminating"
            />
            Laminado</label
          >
          <label
            ><input
              type="checkbox"
              [(ngModel)]="newPrint.die_cutting"
              name="die_cutting"
            />
            Troquelado</label
          >
          <label
            ><input
              type="checkbox"
              [(ngModel)]="newPrint.assembly"
              name="assembly"
            />
            Ensamblado</label
          >
          <label
            ><input
              type="checkbox"
              [(ngModel)]="newPrint.printing"
              name="printing"
            />
            Impresión</label
          >
        </div>
      </div>

      <!-- Campos específicos para Cortes -->
      <div
        *ngIf="newOrder.order_type === 'laser' && userRole != 'admin'"
        class="mb-4 border-t pt-4"
      >
        <h4 class="font-semibold text-red-600">Datos de Corte</h4>
        <!-- Encadenado: CATEGORÍA -->
        <label class="block mt-2 modal-input-item">Categoría</label>
        <select [(ngModel)]="selectedCategory" name="category" class="form-select mt-1 block w-full" (change)="selectedType = ''; selectedCaliber = ''; selectedColor = ''">
          <option *ngFor="let c of getUniqueCategories()" [value]="c">{{ c }}</option>
        </select>

        <!-- Encadenado: TIPO -->
        <label class="block mt-2 modal-input-item">Tipo</label>
        <select [(ngModel)]="selectedType" name="type" class="form-select mt-1 block w-full" (change)="selectedCaliber = ''; selectedColor = ''">
          <option *ngFor="let t of getFilteredTypes()" [value]="t">{{ t }}</option>
        </select>

        <!-- Encadenado: CALIBRE -->
        <label class="block mt-2 modal-input-item">Calibre</label>
        <select [(ngModel)]="selectedCaliber" name="caliber" class="form-select mt-1 block w-full" (change)="selectedColor = ''">
          <option *ngFor="let cal of getFilteredCalibers()" [value]="cal">{{ cal }}</option>
        </select>

        <!-- Encadenado: COLOR -->
        <label class="block mt-2 modal-input-item">Color</label>
        <select [(ngModel)]="selectedColor" name="color" class="form-select mt-1 block w-full">
          <option *ngFor="let col of getFilteredColors()" [value]="col">{{ col }}</option>
        </select>


        <label class="block mt-2 modal-input-item">Alto</label>
        <input
          [(ngModel)]="newCut.height"
          name="height"
          class="form-input mt-1 block w-full"
        />

        <label class="block mt-2 modal-input-item">Ancho</label>
        <input
          [(ngModel)]="newCut.width"
          name="width"
          class="form-input mt-1 block w-full"
        />
        <label class="block mt-2 modal-input-item">Cantidad</label>
        <input
          [(ngModel)]="newCut.quantity"
          name="quantity"
          class="form-input mt-1 block w-full"
        />
        <label class="block mt-2 modal-input-item">Tiempo de corte</label>
        <input
          [(ngModel)]="newCut.cutting_time"
          name="cutting_time"
          class="form-input mt-1 block w-full"
        />
      </div>

      <div class="flex justify-end mt-4">
        <button type="button" class="btn-danger" (click)="toggleAddOrderForm()">
          Cancelar
        </button>
        <button type="submit" class="btn-success ml-2">Guardar Pedido</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para añadir cliente -->
<div *ngIf="showAddClientModal" class="modal-overlay">
  <div class="modal-content w-1/2">
    <h2 class="text-xl font-bold mb-4">Añadir Nuevo Cliente</h2>
    <form (ngSubmit)="saveNewClient()">
      <div class="mb-4">
        <label class="block text-gray-700">Nombre</label>
        <input
          [(ngModel)]="newClient.name"
          name="name"
          class="form-input"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Correo Electrónico</label>
        <input
          type="email"
          [(ngModel)]="newClient.email"
          name="email"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Tipo de Documento</label>
        <select
          [(ngModel)]="newClient.document_type"
          name="document_type"
          class="form-select"
        >
          <option value="NIT">NIT</option>
          <option value="civil registry">Registro civil</option>
          <option value="identity card">Tarjeta de identidad</option>
          <option value="citizenship card">Cédula de ciudadanía</option>
          <option value="alien card">Tarjeta de extranjería</option>
          <option value="foreigner's identity card">
            Cédula de extranjería
          </option>
          <option value="passport">Pasaporte</option>
          <option value="foreign identification document">
            Documento de identificación extranjero
          </option>
          <option value="NIT from another country">NIT de otro país</option>
          <option value="NUIP">NUIP</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Identificación/Documento</label>
        <input
          [(ngModel)]="newClient.document_number"
          name="document_number"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Empresa</label>
        <input
          [(ngModel)]="newClient.company_name"
          name="company_name"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Teléfono</label>
        <input
          type="number"
          [(ngModel)]="newClient.cellphone"
          name="cellphone"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Dirección</label>
        <input
          type="text"
          [(ngModel)]="newClient.address"
          name="address"
          class="form-input"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Estado</label>
        <select
          [(ngModel)]="newClient.status"
          name="status"
          class="form-select mt-1 block w-full"
        >
          <option value="upToDate">Al Día</option>
          <option value="overdue">En Mora</option>
        </select>
      </div>
      <div class="flex justify-end">
        <button
          type="button"
          class="btn-danger"
          (click)="closeAddClientModal()"
        >
          Cancelar
        </button>
        <button type="submit" class="btn-success px-4 py-2 rounded-md">
          Guardar Cliente
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Calculadora -->
<div
  *ngIf="showCalculator"
  class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50"
>
  <div
    class="bg-white w-[500px] max-w-[90vw] rounded-lg shadow-lg p-6 max-h-[90vh] overflow-y-auto"
  >
    <h3 class="text-lg font-bold mb-4">Calculadora</h3>

    <!-- calculator type -->
    <div class="mb-4">
      <label class="block text-gray-700">¿Qué desea calcular?</label>
      <select
        [(ngModel)]="calculationType"
        (change)="resetForm()"
        class="form-select mt-1 block w-full"
      >
        <option [ngValue]="null">Seleccione una opción</option>
        <option value="prints">Impresiones</option>
        <option value="cuts">Cortes</option>
        <option value="sales">Ventas</option>
      </select>
    </div>

    <!-- Tipo de cliente -->
    <div class="mb-4" *ngIf="calculationType">
      <label class="block text-gray-700">Tipo de Cliente</label>
      <select
        [(ngModel)]="clientType"
        (change)="setValoresPorCliente()"
        class="form-select mt-1 block w-full"
      >
        <option [ngValue]="null">Seleccione un tipo</option>
        <option value="intermediary">Intermediario</option>
        <option value="final">Final</option>
      </select>
    </div>

    <!-- Calculadora de impresiones -->
    <div *ngIf="calculationType === 'prints'">
      <div class="mb-4">
        <label class="block text-gray-700">Ancho del rollo (m)</label>
        <input
          type="number"
          [(ngModel)]="rollWidth"
          name="rollWidth"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Medición (m)</label>
        <input
          type="number"
          [(ngModel)]="measurement"
          name="measurement"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Número de productos</label>
        <input
          type="number"
          [(ngModel)]="productNumber"
          name="productNumber"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Opciones</label>
        <div class="flex gap-4 mt-2">
          <label
            ><input
              type="checkbox"
              [(ngModel)]="lamination"
              name="lamination"
              (change)="calculatePrice()"
            />
            Laminado</label
          >
          <label
            ><input
              type="checkbox"
              [(ngModel)]="pPrint"
              name="pPrint"
              (change)="calculatePrice()"
            />
            Impresión</label
          >
          <label
            ><input
              type="checkbox"
              [(ngModel)]="stamping"
              name="stamping"
              (change)="calculatePrice()"
            />
            Troquelado</label
          >
          <label
            ><input
              type="checkbox"
              [(ngModel)]="assemble"
              name="assemble"
              (change)="calculatePrice()"
            />
            Ensamblado</label
          >
        </div>
      </div>
    </div>

    <!-- Calculadora de cortes -->
    <div *ngIf="calculationType === 'cuts'">
      <div class="mb-4">
        <label class="block text-gray-700">Valor del material</label>
        <input
          type="number"
          [(ngModel)]="materialValue"
          name="materialValue"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Tiempo de uso (min)</label>
        <input
          type="number"
          [(ngModel)]="usageTime"
          name="usageTime"
          class="form-input mt-1 block w-full"
          (change)="calculatePrice()"
        />
      </div>
    </div>

    <!-- Resultado -->
    <div class="mb-4" *ngIf="calculatorResult > 0">
      <p class="font-bold">Resultado: {{ calculatorResult }} COP</p>
    </div>

    <div class="flex justify-end mt-4">
      <button type="button" class="btn-danger" (click)="closeCalculator()">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Notificación temporal -->
<div
  *ngIf="notificationMessage"
  class="fixed top-4 right-4 bg-green-500 text-white p-2 rounded shadow-md z-50"
>
  {{ notificationMessage }}
</div>
