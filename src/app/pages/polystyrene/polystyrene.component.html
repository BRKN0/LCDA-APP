<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<!-- Indicador de carga -->
<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando datos de poliestireno...</p>
</div>

<!-- Filtros y acciones -->
<div *ngIf="!loading" class="flex justify-end items-center mb-4 mt-4 ml-2">
  <button class="btn-add inline-flex items-center space-x-2" (click)="addPolystyrene()">
    <svg
      class="w-5 h-5 inline-block align-middle mt-[3px]"
      viewBox="0 0 24 24"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M12.75 9C12.75 8.58579 12.4142 8.25 12 8.25C11.5858 8.25 11.25 8.58579 11.25 9L11.25 11.25H9C8.58579 11.25 8.25 11.5858 8.25 12C8.25 12.4142 8.58579 12.75 9 12.75H11.25V15C11.25 15.4142 11.5858 15.75 12 15.75C12.4142 15.75 12.75 15.4142 12.75 15L12.75 12.75H15C15.4142 12.75 15.75 12.4142 15.75 12C15.75 11.5858 15.4142 11.25 15 11.25H12.75V9Z"
        fill="#ffffff"
      />
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
        fill="#ffffff"
      />
    </svg>
    <span>Añadir</span>
  </button>
  <button class="btn-details inline-flex items-center space-x-2" (click)="openCalculatorModal()">
    <svg class="w-8 h-8 inline-block align-middle mt-[3px]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
      <g
        id="SVGRepo_tracerCarrier"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></g>
      <g id="SVGRepo_iconCarrier">
        <path
          d="M14 7C14 6.44771 14.4477 6 15 6H16V5C16 4.44772 16.4477 4 17 4C17.5523 4 18 4.44772 18 5V6H19C19.5523 6 20 6.44771 20 7C20 7.55229 19.5523 8 19 8H18V9C18 9.55228 17.5523 10 17 10C16.4477 10 16 9.55228 16 9V8H15C14.4477 8 14 7.55229 14 7Z"
          fill="#ffffff"
        ></path>
        <path
          d="M14 15C14 14.4477 14.4477 14 15 14H19C19.5523 14 20 14.4477 20 15C20 15.5523 19.5523 16 19 16H15C14.4477 16 14 15.5523 14 15Z"
          fill="#ffffff"
        ></path>
        <path
          d="M15 18C14.4477 18 14 18.4477 14 19C14 19.5523 14.4477 20 15 20H19C19.5523 20 20 19.5523 20 19C20 18.4477 19.5523 18 19 18H15Z"
          fill="#ffffff"
        ></path>
        <path
          d="M5 6C4.44772 6 4 6.44771 4 7C4 7.55229 4.44772 8 5 8H9C9.55228 8 10 7.55229 10 7C10 6.44771 9.55228 6 9 6H5Z"
          fill="#ffffff"
        ></path>
        <path
          d="M5.92512 14.5109C5.5346 14.1204 4.90143 14.1204 4.51091 14.5109C4.12039 14.9014 4.12039 15.5346 4.51091 15.9251L5.5858 17L4.50337 18.0824C4.11284 18.4729 4.11284 19.1061 4.50337 19.4966C4.89389 19.8872 5.52705 19.8872 5.91758 19.4966L7.00002 18.4142L8.08944 19.5036C8.47996 19.8941 9.11313 19.8941 9.50365 19.5036C9.89418 19.1131 9.89418 18.4799 9.50365 18.0894L8.41423 17L9.50194 15.9123C9.89246 15.5218 9.89246 14.8886 9.50194 14.4981C9.11141 14.1075 8.47825 14.1075 8.08772 14.4981L7.00002 15.5858L5.92512 14.5109Z"
          fill="#ffffff"
        ></path>
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M20 1C21.6569 1 23 2.34315 23 4V20C23 21.6569 21.6569 23 20 23H4C2.34315 23 1 21.6569 1 20V4C1 2.34315 2.34315 1 4 1H20ZM20 3C20.5523 3 21 3.44772 21 4V11H13V3H20ZM21 13V20C21 20.5523 20.5523 21 20 21H13V13H21ZM4 3H11V11H3V4C3 3.44772 3.44772 3 4 3ZM3 20V13H11V21H4C3.44772 21 3 20.5523 3 20Z"
          fill="#ffffff"
        ></path>
      </g>
    </svg>
    <span>Calculadora</span>
  </button>
  <button
    class="btn-clear inline-flex items-center space-x-2 "
    (click)="clearFilters()"
  >
    Limpiar filtros
  </button>
</div>
<div class="flex items-center justify-center py-4 space-x-4 top-5">
  <div class="relative w-full max-w-md">
    <input
      type="text"
      [(ngModel)]="searchCaliber"
      (input)="updateFilteredPolystyrenes()"
      placeholder="Buscar por calibre..."
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
  </div>
</div>
<div class="flex justify-start items-center mb-4 mt-4 ml-2">
  <div class="flex space-x-2">
    <label for="format" class="font-semibold">Formato:</label>
    <select
      id="format"
      [(ngModel)]="selectedFormat"
      class="border border-gray-300 rounded-md p-1 h-10"
    >
      <option value="1 Lámina">1 Lámina</option>
      <option value="1/2 (Media Lámina)">1/2 (Media Lámina)</option>
      <option value="1/3 (Tercio de Lámina)">1/3 (Tercio de Lámina)</option>
      <option value="1/4 (Cuarto de Lámina)">1/4 (Cuarto de Lámina)</option>
      <option value="1/8 (Octavo de Lámina)">1/8 (Octavo de Lámina)</option>
      <option value="1/16 (Dieciseisavo de Lámina)">
        1/16 (Dieciseisavo de Lámina)
      </option>
      <option value="1/32 (Treintaydosavo de Lámina)">
        1/32 (Treintaydosavo de Lámina)
      </option>
      <option value="">Personalizado</option>
    </select>

    <select
      [(ngModel)]="searchType"
      (change)="updateFilteredPolystyrenes()"
      class="border p-2 rounded h-10"
    >
      <option value="">-- Todos los tipos --</option>
      <option *ngFor="let type of availableTypes" [value]="type">
        {{
          type === 'original' ? 'Original' :
          type === 'eco' ? 'Eco' :
          type === 'clear' ? 'Transparente' :
          type === 'color' ? 'Color' :
          type
       }}
      </option>
    </select>
  </div>

  <div class="flex items-center space-x-4 ml-auto">
      <div>
        <label class="block font-semibold">Ancho (cm)</label>
        <input
          type="number"
          [(ngModel)]="customWidth"
          (input)="updatePaginatedPolystyrenes()"
          class="border border-gray-300 rounded-md p-2 w-28"
          placeholder="Ej. 50"
          [disabled]="selectedFormat.trim() !== ''"
        />
      </div>
      <div>
        <label class="block font-semibold">Alto (cm)</label>
        <input
          type="number"
          [(ngModel)]="customHeight"
          (input)="updatePaginatedPolystyrenes()"
          class="border border-gray-300 rounded-md p-2 w-28"
          placeholder="Ej. 100"
          [disabled]="selectedFormat.trim() !== ''"
        />
      </div>
    </div>
</div>
<!-- Tabla -->
<div *ngIf="!loading">
  <div *ngIf="paginatedPolystyrenes.length > 0">
    <div class="table-container">
      <table class="table-std">
        <thead>
          <tr>
            <th>Ancho</th>
            <th>Alto</th>
            <th class="table-column-std">Tipo</th>
            <th (click)="toggleSortDirection('caliber')" class="cursor-pointer">
              Calibre <span>{{ getSortIcon("caliber") }}</span>
            </th>
            <th>Costo</th>
            <th>30% Util.</th>
            <th>Margen</th>
            <th>+Margen</th>
            <th>Sin IVA</th>
            <th>IVA</th>
            <th>Con IVA</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of paginatedPolystyrenes">
            <td>{{ item.width }}</td>
            <td>{{ item.height }}</td>
            <td>
              {{
                item.type === 'original'
                  ? 'Original'
                  : item.type === 'eco'
                  ? 'Eco'
                  : item.type === 'clear'
                  ? 'Transparente'
                  : item.type === 'color'
                  ? 'Color'
                  : 'Desconocido'
              }}
            </td>
            <td>{{ item.caliber }}</td>
            <td>{{ item.whole | currency : "COP" }}</td>
            <td>
              {{ calculatePriceForTable(item).basePriceWithProfit | currency : "COP" }}
            </td>

            <td>
              {{ (calculatePriceForTable(item).appliedMargin * 100).toFixed(0) }}%
            </td>

            <td>
              {{ calculatePriceForTable(item).priceWithMargin | currency : "COP" }}
            </td>

            <td [ngClass]="{'text-red-600 font-bold': calculatePriceForTable(item).noCabe}">
              {{
                calculatePriceForTable(item).noCabe
                  ? 'NO CABE'
                  : (calculatePriceForTable(item).finalPriceWithoutIva | currency:'COP')
              }}
            </td>

            <td>
              {{ calculatePriceForTable(item).iva | currency : "COP" }}
            </td>

            <td>
              {{ calculatePriceForTable(item).finalPriceWithIva | currency : "COP" }}
            </td>
            <td>
              <button class="btn-edit" (click)="editPolystyrene(item)">
                Editar
              </button>
              <button class="btn-delete" (click)="deletePolystyrene(item)">
                Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex justify-between items-center mb-4">
      <div class="pagination flex items-center">
        <button
          (click)="currentPage = 1; updatePaginatedPolystyrenes()"
          [disabled]="currentPage === 1"
          class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
        >
          &#8656;
        </button>
        <button
          (click)="currentPage = currentPage - 1; updatePaginatedPolystyrenes()"
          [disabled]="currentPage === 1"
          class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
        >
          &#8592;
        </button>
        <span class="mx-4 text-gray-700"
          >Página {{ currentPage }} de {{ totalPages }}</span
        >
        <button
          (click)="currentPage = currentPage + 1; updatePaginatedPolystyrenes()"
          [disabled]="currentPage === totalPages"
          class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
        >
          &#8594;
        </button>
        <button
          (click)="currentPage = totalPages; updatePaginatedPolystyrenes()"
          [disabled]="currentPage === totalPages"
          class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
        >
          &#8658;
        </button>
      </div>
      <div class="items-per-page flex items-center">
        <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
        <select
          id="itemsPerPage"
          [(ngModel)]="itemsPerPage"
          (change)="currentPage = 1; updatePaginatedPolystyrenes()"
          class="border border-gray-300 rounded-md p-1"
        >
          <option *ngFor="let size of [5, 10, 15, 20]" [value]="size">
            {{ size }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Sin resultados -->
  <div
    *ngIf="paginatedPolystyrenes.length === 0"
    class="p-4 text-center text-gray-600"
  >
    <p>No hay resultados para los filtros aplicados.</p>
  </div>
</div>

<!-- Modal -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content modal-h600">
    <h3 class="text-lg font-bold mb-4">
      {{ isEditing ? "Editar Poliestireno" : "Nuevo Poliestireno" }}
    </h3>
    <form (ngSubmit)="savePolystyrene()">
      <div class="mb-4">
        <label class="block modal-input-item"
        >Ancho (cm)<span class="text-red-500">*</span></label
        >
        <input type="number"
          [(ngModel)]="selectedPolystyrene.width"
          name="width"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item"
        >Alto (cm)<span class="text-red-500">*</span></label
        >
        <input type="number"
          [(ngModel)]="selectedPolystyrene.height"
          name="height"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Tipo</label>
        <select
          [(ngModel)]="selectedPolystyrene.type"
          name="type"
          class="form-select mt-1 block w-full"
          required
        >
          <option value="original">Original</option>
          <option value="eco">Eco</option>
          <option value="clear">Transparente</option>
          <option value="color">Color</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block modal-input-item"
          >Calibre<span class="text-red-500">*</span></label
        >
        <input
          type="text"
          [(ngModel)]="selectedPolystyrene.caliber"
          name="caliber"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item"
          >Precio lámina entera (COP)<span class="text-red-500">*</span></label
        >
        <input
          type="number"
          [(ngModel)]="selectedPolystyrene.whole"
          name="whole"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="flex justify-end mt-4">
        <button type="button" class="btn-danger mr-2" (click)="closeModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-success">
          {{ isEditing ? "Actualizar" : "Guardar" }}
        </button>
      </div>
    </form>
  </div>
</div>

<div *ngIf="showCalculatorModal" class="modal-overlay">
    <div class="modal-content modal-h600">
      <h3 class="text-lg font-bold mb-4">Calculadora de Poliestireno</h3>
      <form (ngSubmit)="calculatePolystyreneValues()">
        <!-- Cliente -->
        <div class="mb-4">
          <label class="block modal-input-item">Cliente (opcional)</label>
          <div class="relative">
            <input
              type="text"
              placeholder="Buscar cliente por nombre..."
              [(ngModel)]="clientSearchQuery"
              (ngModelChange)="searchClients()"
              name="clientSearch"
              class="form-input mt-1 block w-full"
              (focus)="showClientDropdown = true"
              (blur)="hideClientDropdown()"
            />
            <div
              *ngIf="showClientDropdown && filteredClients.length > 0"
              class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto"
            >
              <div
                *ngFor="let client of filteredClients"
                class="p-2 hover:bg-gray-200 cursor-pointer"
                (click)="selectClient(client)"
              >
                {{ client.name }} ({{ client.company_name || 'Sin empresa' }})
              </div>
            </div>
          </div>
        </div>

        <!-- Formulario de medidas -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block modal-input-item">Ancho (cm)</label>
            <input type="number" [(ngModel)]="calculatorForm.width" name="width" required class="form-input w-full" />
          </div>
          <div>
            <label class="block modal-input-item">Alto (cm)</label>
            <input type="number" [(ngModel)]="calculatorForm.height" name="height" required class="form-input w-full" />
          </div>
          <div>
            <label class="block modal-input-item">Calibre</label>
            <input type="text" [(ngModel)]="calculatorForm.caliber" name="caliber" required class="form-input w-full" />
          </div>
          <div>
            <label class="block modal-input-item">Tipo</label>
            <input type="text" [(ngModel)]="calculatorForm.type" name="type" required class="form-input w-full" />
          </div>
          <div>
            <label class="block modal-input-item">Formato</label>
            <select [(ngModel)]="calculatorForm.format" name="format" class="form-select w-full">
              <option *ngFor="let key of (formatFactors | keyvalue)" [value]="key.key">{{ key.key }}</option>
              <option value="">Personalizado</option>
            </select>
          </div>
          <div>
            <label class="block modal-input-item">Precio lámina entera</label>
            <input type="number" [(ngModel)]="calculatorForm.whole" name="whole" required class="form-input w-full" />
          </div>
          <div>
            <label class="block modal-input-item">Utilidad (%)</label>
            <input type="number" [(ngModel)]="calculatorForm.margin" name="margin" required class="form-input w-full" />
          </div>
          <div>
            <label class="block modal-input-item">Descuento (%)</label>
            <input type="number" [(ngModel)]="calculatorForm.discount" name="discount" required class="form-input w-full" />
          </div>
        </div>

        <div class="mt-4">
          <label class="inline-flex items-center">
            <input type="checkbox" [(ngModel)]="calculatorForm.includeIva" name="includeIva" class="form-checkbox" />
            <span class="ml-2">Incluir IVA (19%)</span>
          </label>
        </div>

        <div class="mb-4" *ngIf="selectedClient">
          <button
            type="button"
            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"
            (click)="openClientDefaultsModal()"
          >
            Modificar Utilidad/Descuento Predeterminados
          </button>
        </div>

        <!-- Resultados -->
        <div *ngIf="calculationResult" class="mt-6 space-y-1 text-sm">
          <h4 class="font-semibold text-base">Resultados:</h4>
          <p><strong>Área:</strong> {{ calculationResult.area.toFixed(4) }} m²</p>
          <p><strong>Costo con utilidad:</strong> ${{ calculationResult.basePriceWithProfit.toLocaleString() }}</p>
          <p><strong>Margen aplicado:</strong> {{ (calculationResult.appliedMargin * 100).toFixed(0) }}%</p>
          <p><strong>Precio con margen:</strong> ${{ calculationResult.priceWithMargin.toLocaleString() }}</p>
          <p><strong>Descuento:</strong> ${{ calculationResult.discount.toLocaleString() }}</p>
          <p><strong>Precio sin IVA:</strong> ${{ calculationResult.finalPriceWithoutIva.toLocaleString() }}</p>
          <p *ngIf="calculatorForm.includeIva"><strong>IVA:</strong> ${{ calculationResult.iva.toLocaleString() }}</p>
          <p *ngIf="calculatorForm.includeIva"><strong>Precio con IVA:</strong> ${{ calculationResult.finalPriceWithIva.toLocaleString() }}</p>
        </div>

        <!-- Acciones -->
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" class="btn-danger" (click)="closeCalculatorModal()">Cerrar</button>
          <button type="submit" class="btn-success">Calcular</button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="showClientDefaultsModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-4">
        Modificar Valores Predeterminados de {{ selectedClient?.name }}
      </h3>
      <form (ngSubmit)="saveClientDefaults()">
        <div class="mb-4">
          <label class="block modal-input-item"
            >Utilidad Predeterminada (%)</label
          >
          <input
            type="number"
            step="0.1"
            [(ngModel)]="selectedClient!.default_margin"
            name="defaultMargin"
            class="form-input mt-1 block w-full border border-gray-300 rounded-md"
            placeholder="Ej. 30"
            required
          />
        </div>
        <div class="mb-4">
          <label class="block modal-input-item"
            >Descuento Predeterminado (%)</label
          >
          <input
            type="number"
            step="0.1"
            [(ngModel)]="selectedClient!.default_discount"
            name="defaultDiscount"
            class="form-input mt-1 block w-full border border-gray-300 rounded-md"
            placeholder="Ej. 0"
            required
          />
        </div>
        <div class="flex justify-end">
          <button
            type="button"
            class="btn-danger"
            (click)="closeClientDefaultsModal()"
          >
            Cancelar
          </button>
          <button type="submit" class="btn-success">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
