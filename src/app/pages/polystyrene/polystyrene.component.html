<app-main-banner></app-main-banner>

<!-- Indicador de carga -->
<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando datos de poliestireno...</p>
</div>

<!-- Filtros y acciones -->
<div *ngIf="!loading" class="flex items-center space-x-4 mb-4">
  <label for="format" class="font-semibold">Formato:</label>
  <select
    id="format"
    [(ngModel)]="selectedFormat"
    class="border border-gray-300 rounded-md p-1"
  >
    <option value="1 Lámina">1 Lámina</option>
    <option value="1/2 (Media Lámina)">1/2 (Media Lámina)</option>
    <option value="1/3 (Tercio de Lámina)">1/3 (Tercio de Lámina)</option>
    <option value="1/4 (Cuarto de Lámina)">1/4 (Cuarto de Lámina)</option>
    <option value="1/8 (Octavo de Lámina)">1/8 (Octavo de Lámina)</option>
    <option value="1/16 (Dieciseisavo de Lámina)">1/16 (Dieciseisavo de Lámina)</option>
    <option value="1/32 (Treintaydosavo de Lámina)">1/32 (Treintaydosavo de Lámina)</option>
  </select>

  <select [(ngModel)]="searchType" (change)="updateFilteredPolystyrenes()" class="border p-2 rounded">
    <option value="">-- Todos los tipos --</option>
    <option *ngFor="let type of availableTypes" [value]="type">{{ type }}</option>
  </select>

  <input
    type="text"
    [(ngModel)]="searchCaliber"
    (input)="updateFilteredPolystyrenes()"
    placeholder="Buscar por calibre..."
    class="border border-gray-300 rounded-md p-1"
  />

  <button
    class="bg-red-500 text-white px-6 py-2 rounded-full hover:bg-red-700"
    (click)="addPolystyrene()"
  >
    Añadir Poliestireno
  </button>
</div>

<!-- Tabla -->
<div *ngIf="!loading">
  <div *ngIf="paginatedPolystyrenes.length > 0">
    <div class="table-container">
      <table class="table-std">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Calibre</th>
            <th>Costo</th>
            <th>30% Util.</th>
            <th>Margen</th>
            <th>+Margen</th>
            <th>Sin IVA</th>
            <th>IVA</th>
            <th>Con IVA</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of paginatedPolystyrenes">
            <td>{{ item.type }}</td>
            <td>{{ item.caliber }}</td>
            <td>{{ item.whole | currency:'COP' }}</td>
            <td>{{ calculateBasePriceWith30PercentProfit(item.whole) | currency:'COP' }}</td>
            <td>{{ (getAppliedMargin() * 100).toFixed(0) }}%</td>
            <td>{{ calculateAdjustedPriceWith30PercentProfit(item.whole) | currency:'COP' }}</td>
            <td>{{ calculatePriceWithMargin(calculateAdjustedPriceWith30PercentProfit(item.whole)) | currency:'COP' }}</td>
            <td>{{ calculateIva(calculateFinalPriceWithoutIva(calculatePriceWithMargin(calculateAdjustedPriceWith30PercentProfit(item.whole)))) | currency:'COP' }}</td>
            <td>{{ calculatePriceWithIva(calculateFinalPriceWithoutIva(calculatePriceWithMargin(calculateAdjustedPriceWith30PercentProfit(item.whole))), calculateIva(calculateFinalPriceWithoutIva(calculatePriceWithMargin(calculateAdjustedPriceWith30PercentProfit(item.whole))))) | currency:'COP' }}</td>
            <td>
              <button class="btn-edit" (click)="editPolystyrene(item)">Editar</button>
              <button class="btn-delete" (click)="deletePolystyrene(item)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex justify-between items-center mb-4">
      <div class="pagination flex items-center">
        <button (click)="currentPage = 1; updatePaginatedPolystyrenes()" [disabled]="currentPage === 1" class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8">&#8656;</button>
        <button (click)="currentPage = currentPage - 1; updatePaginatedPolystyrenes()" [disabled]="currentPage === 1" class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7">&#8592;</button>
        <span class="mx-4 text-gray-700">Página {{ currentPage }} de {{ totalPages }}</span>
        <button (click)="currentPage = currentPage + 1; updatePaginatedPolystyrenes()" [disabled]="currentPage === totalPages" class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7">&#8594;</button>
        <button (click)="currentPage = totalPages; updatePaginatedPolystyrenes()" [disabled]="currentPage === totalPages" class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8">&#8658;</button>
      </div>
      <div class="items-per-page flex items-center">
        <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
        <select id="itemsPerPage" [(ngModel)]="itemsPerPage" (change)="currentPage = 1; updatePaginatedPolystyrenes()" class="border border-gray-300 rounded-md p-1">
          <option *ngFor="let size of [5, 10, 15, 20]" [value]="size">{{ size }}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Sin resultados -->
  <div *ngIf="paginatedPolystyrenes.length === 0" class="p-4 text-center text-gray-600">
    <p>No hay resultados para los filtros aplicados.</p>
  </div>
</div>

<!-- Modal -->
<div *ngIf="showModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
  <div class="bg-white w-[500px] max-w-[90vw] rounded-lg shadow-lg p-6 max-h-[90vh] overflow-y-auto">
    <h3 class="text-lg font-bold mb-4">{{ isEditing ? 'Editar Poliestireno' : 'Nuevo Poliestireno' }}</h3>
    <form (ngSubmit)="savePolystyrene()">
      <div class="mb-4">
        <label class="block text-gray-700">Tipo</label>
        <input type="text" [(ngModel)]="selectedPolystyrene.type" name="type" class="form-input mt-1 block w-full" required />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Calibre</label>
        <input type="text" [(ngModel)]="selectedPolystyrene.caliber" name="caliber" class="form-input mt-1 block w-full" required />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Precio lámina entera (COP)</label>
        <input type="number" [(ngModel)]="selectedPolystyrene.whole" name="whole" class="form-input mt-1 block w-full" required />
      </div>
      <div class="flex justify-end mt-4">
        <button type="button" class="btn-danger mr-2" (click)="closeModal()">Cancelar</button>
        <button type="submit" class="btn-success">{{ isEditing ? 'Actualizar' : 'Guardar' }}</button>
      </div>
    </form>
  </div>
</div>