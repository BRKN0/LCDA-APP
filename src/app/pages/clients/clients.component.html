<app-main-banner></app-main-banner>

<!-- Loading Indicator -->
<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando clientes...</p>
</div>

<!-- Search bar and filter by debt -->
<div class="flex items-center justify-center py-4">
  <div class="w-full max-w-md relative">
    <input
      type="text"
      placeholder="Buscar cliente por nombre..."
      [(ngModel)]="searchQuery"
      (ngModelChange)="searchClient()"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
    <button
      class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-700 w-auto"
      (click)="searchClient()"
    >
      Buscar
    </button>
  </div>
</div>

<div class="p-4">
  <label>
    <input type="checkbox" [(ngModel)]="filterDebt" (change)="searchClient()" />
    Mostrar solo clientes con deuda
  </label>
</div>

<!-- No clients found -->
<div *ngIf="noResultsFound" class="p-4 text-center text-red-500">
  <p>No se encontró ningún cliente con ese nombre.</p>
</div>

<div *ngIf="!loading && !noResultsFound">
  <table class="table-auto w-full border-collapse">
    <thead>
      <tr class="bg-gray-100">
        <th class="p-3 border">Nombre</th>
        <th class="p-3 border">NIT / CC</th>
        <th class="p-3 border">Empresa</th>
        <th class="p-3 border">Estado</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let client of filteredClients"
        (click)="toggleDetails(client)"
        [class.border-red-500]="client.status === 'overdue'"
        [class.border-green-500]="client.status === 'upToDate'"
        class="cursor-pointer hover:bg-gray-200 border"
      >
        <td class="p-3 border">{{ client.name }}</td>
        <td class="p-3 border">
          {{ client.nit ?? client.document_number }}
        </td>
        <td class="p-3 border">
          {{ client.company_name ?? "N/A" }}
        </td>
        <td
          class="p-3 border"
          [class.text-green-600]="client.status === 'upToDate'"
          [class.text-red-600]="client.status === 'overdue'"
        >
          {{
            client.status === "upToDate"
              ? "Al Dia"
              : client.status === "overdue"
              ? "En mora"
              : "Otro"
          }}
        </td>
      </tr>
      <tr *ngIf="selectedClient">
        <td colspan="4" class="p-4 bg-gray-50">
          <div class="details">
            <p><strong>Teléfono:</strong> {{ selectedClient.cellphone }}</p>
            <p><strong>Dirección:</strong> {{ selectedClient.address }}</p>
            <p>
              <strong>Deuda:</strong>
              <span
                [class.text-green-600]="selectedClient.debt === 0"
                [class.text-red-600]="selectedClient.debt > 0"
              >
                {{
                  selectedClient.debt > 0
                    ? "$" + selectedClient.debt
                    : "Sin Deuda"
                }}
              </span>
            </p>
            <button
              (click)="toggleOrders(selectedClient)"
              class="mt-4 bg-red-500 text-white p-2 rounded-md"
            >
              Mostrar Pedidos
            </button>
            <table *ngIf="showOrders" class="w-full mt-4 border-collapse">
              <thead>
                <tr class="bg-gray-100">
                  <th class="p-3 border">Código</th>
                  <th class="p-3 border">Tipo</th>
                  <th class="p-3 border">Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let orders of selectedClient.orders">
                  <td class="p-3 border">{{ orders.code }}</td>
                  <td class="p-3 border">
                    {{
                      orders.order_type === "print"
                        ? "Impresiones"
                        : orders.order_type === "laser"
                        ? "Cortes"
                        : orders.order_type === "sales"
                        ? "Ventas"
                        : "Desconocido"
                    }}
                  </td>
                  <td
                    class="p-3 border"
                    [class.text-green-600]="orders.order_status === 'upToDate'"
                    [class.text-red-600]="orders.order_status === 'overdue'"
                  >
                    {{
                      orders.order_status === "upToDate"
                        ? "Al Dia"
                        : orders.order_status === "overdue"
                        ? "En mora"
                        : "Otro"
                    }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
