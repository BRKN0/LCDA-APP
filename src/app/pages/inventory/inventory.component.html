<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando inventario...</p>
</div>

<!-- Filter checkboxes -->
<div *ngIf="!loading" class="flex justify-between items-center mb-4 mt-4">
  <div class="flex space-x-2 ml-2">
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showVinyls"
        (change)="updateFilteredInventory()"
      />
      Vinilos
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showCutVinyls"
        (change)="updateFilteredInventory()"
      />
      Vinilos de corte
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showAcrylic"
        (change)="updateFilteredInventory()"
      />
      Acrilico
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showPolystyrene"
        (change)="updateFilteredInventory()"
      />
      Poliestireno
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showDieCut"
        (change)="updateFilteredInventory()"
      />
      Troquelado
    </label>
    <label>
      <input
        type="checkbox"
        [(ngModel)]="showMDF"
        (change)="updateFilteredInventory()"
      />
      MDF
    </label>
  </div>
  <!-- Action buttons -->
  <div class="flex space-x-2 mr-4">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="addNewItem()"
    >
      <svg
        class="w-5 h-5 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12.75 9C12.75 8.58579 12.4142 8.25 12 8.25C11.5858 8.25 11.25 8.58579 11.25 9L11.25 11.25H9C8.58579 11.25 8.25 11.5858 8.25 12C8.25 12.4142 8.58579 12.75 9 12.75H11.25V15C11.25 15.4142 11.5858 15.75 12 15.75C12.4142 15.75 12.75 15.4142 12.75 15L12.75 12.75H15C15.4142 12.75 15.75 12.4142 15.75 12C15.75 11.5858 15.4142 11.25 15 11.25H12.75V9Z"
          fill="#ffffff"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
          fill="#ffffff"
        />
      </svg>
      <span>Añadir</span>
    </button>

    <button class="btn-details" (click)="generateKardex()">
      Generar Kardex
    </button>
    <button class="btn-details" (click)="openComparisonModal()">
      Comparar Archivos
    </button>
  </div>
</div>

<div
  *ngIf="!loading && filteredInventory.length === 0"
  class="p-4 text-center text-gray-600"
>
  <p>No hay coincidencias con la busqueda.</p>
</div>

<!-- Search bars -->
<div class="flex items-center justify-center py-4">
  <div class="w-full max-w-md relative mr-4">
    <input
      type="text"
      placeholder="Buscar por código..."
      [(ngModel)]="searchCode"
      (ngModelChange)="filterInventory()"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
  </div>
  <div class="w-full max-w-md relative">
    <input
      type="text"
      placeholder="Buscar por tipo..."
      [(ngModel)]="searchType"
      (ngModelChange)="filterInventory()"
      class="w-full py-2 px-4 rounded-full border-2 border-red-500 text-gray-700 focus:outline-none focus:border-red-700"
    />
  </div>
</div>

<!-- Modal para comparación -->
<div *ngIf="showModal && isComparing" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-lg font-bold mb-4">Comparar Inventario</h2>

    <div class="mb-4">
      <label for="file1" class="block modal-input-item">Archivo 1:</label>
      <input
        id="file1"
        type="file"
        accept=".csv"
        class="w-full border border-gray-300 rounded-md p-2"
      />
    </div>
    <div class="mb-4">
      <label for="file2" class="block modal-input-item">Archivo 2:</label>
      <input
        id="file2"
        type="file"
        accept=".csv"
        class="w-full border border-gray-300 rounded-md p-2"
      />
    </div>

    <div class="flex justify-between">
      <button (click)="compareCSV()" class="btn-success">
        Iniciar Comparación
      </button>
      <button (click)="clearComparison()" class="btn-edit">Limpiar</button>
      <button (click)="closeComparisonModal()" class="btn-delete">
        Cerrar
      </button>
    </div>
    <div *ngIf="comparisonResult.length > 0" class="mt-4">
      <h3 class="text-md font-semibold mb-2">Resultados de la Comparación</h3>
      <table class="w-full border-collapse border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="border border-gray-300 px-2 py-1">Producto</th>
            <th class="border border-gray-300 px-2 py-1">Cambio</th>
            <th class="border border-gray-300 px-2 py-1">Detalle</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let result of comparisonResult">
            <td class="border border-gray-300 px-2 py-1">
              {{ result.product }}
            </td>
            <td
              class="border border-gray-300 px-2 py-1"
              [style.color]="getDetailColor(result.change)"
            >
              {{ result.change }}
            </td>
            <td class="border border-gray-300 px-2 py-1">
              {{ result.detail }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para agregar/editar -->
<div *ngIf="showModal && !isComparing" class="modal-overlay">
  <div class="modal-content">
    <h3 class="text-lg font-bold mb-4">
      {{ isEditing ? "Editar Artículo" : "Agregar Artículo" }}
    </h3>
    <form (ngSubmit)="saveItem()">
      <div class="mb-4">
        <label class="block modal-input-item"
          >Categoría<span class="text-red-500">*</span></label
        >
        <input
          type="text"
          [(ngModel)]="selectedItem.category"
          name="category"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Tipo</label>
        <input
          type="text"
          [(ngModel)]="selectedItem.type"
          name="type"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Calibre</label>
        <input
          type="text"
          [(ngModel)]="selectedItem.caliber"
          name="caliber"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Cantidad</label>
        <input
          type="number"
          [(ngModel)]="selectedItem.material_quantity"
          name="quantity"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Color</label>
        <input
          type="text"
          [(ngModel)]="selectedItem.color"
          name="color"
          class="form-input mt-1 block w-full"
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item"
          >Costo/Unidad<span class="text-red-500">*</span></label
        >
        <input
          type="number"
          [(ngModel)]="selectedItem.cost"
          name="cost"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Precio de venta</label>
        <input
          type="number"
          [(ngModel)]="selectedItem.sale_price"
          name="sale_price"
          class="form-input mt-1 block w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label class="block modal-input-item">Estado</label>
        <select
          type="text"
          [(ngModel)]="selectedItem.status"
          name="status"
          class="form-input mt-1 block w-full"
          required
        >
          <option
            *ngFor="let status of materialStatus"
            [value]="status.value"
            [selected]="selectedItem.status === status.value"
          >
            {{ status.label }}
          </option>
        </select>
      </div>
      <div class="flex justify-end">
        <button type="button" class="btn-danger" (click)="closeModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-success">
          {{ isEditing ? "Actualizar Artículo" : "Agregar Artículo" }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Inventory table -->
<div *ngIf="!loading && filteredInventory.length > 0" class="mt-4">
  <table class="table-std">
    <thead>
      <tr>
        <th class="table-column-std">Código</th>
        <th class="table-column-std">Categoría</th>
        <th class="table-column-std">Tipo</th>
        <th class="table-column-std">Calibre</th>
        <th class="table-column-std">Cantidad</th>
        <th class="table-column-std">Color</th>
        <th class="table-column-std">Costo/Unidad</th>
        <th class="table-column-std">Precio de venta</th>
        <th class="table-column-std">Stock</th>
        <th class="table-column-std">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let item of paginatedInventory"
        class="cursor-pointer hover:bg-gray-50"
      >
        <td>{{ item.code }}</td>
        <td>{{ item.category || "Sin Categoria" }}</td>
        <td>{{ item.type || "Sin Tipo" }}</td>
        <td>{{ item.caliber || "Sin Calibre" }}</td>
        <td
          [ngClass]="{
            'text-green-600 font-semibold': item.material_quantity > 10,
            'text-red-600 font-semibold': item.material_quantity <= 10
          }"
        >
          {{ item.material_quantity || 0 }}
        </td>
        <td>{{ item.color || "Sin Color" }}</td>
        <td>{{ item.cost | currency }}</td>
        <td>{{ item.sale_price | currency }}</td>
        <td>{{ getMaterialStatusLabel(item.status) }}</td>
        <td>
          <button
            (click)="editItem(item); $event.stopPropagation()"
            class="btn-edit px-3 py-1 rounded"
          >
            Editar
          </button>
          <button
            (click)="deleteItem(item); $event.stopPropagation()"
            class="btn-delete px-3 py-1 rounded"
          >
            Eliminar
          </button>
        </td>
      </tr>
    </tbody>
  </table>
  <div class="flex justify-between items-center mb-4">
    <!-- Controles de paginación -->
    <div class="pagination flex items-center">
      <button
        (click)="currentPage = 1; updatePaginatedInventory()"
        [disabled]="currentPage === 1"
        class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
      >
        &#8656;
      </button>
      <button
        (click)="currentPage = currentPage - 1; updatePaginatedInventory()"
        [disabled]="currentPage === 1"
        class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
      >
        &#8592;
      </button>
      <span class="mx-4 text-gray-700"
        >Página {{ currentPage }} de {{ totalPages }}</span
      >
      <button
        (click)="currentPage = currentPage + 1; updatePaginatedInventory()"
        [disabled]="currentPage === totalPages"
        class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
      >
        &#8594;
      </button>
      <button
        (click)="currentPage = totalPages; updatePaginatedInventory()"
        [disabled]="currentPage === totalPages"
        class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
      >
        &#8658;
      </button>
    </div>

    <!-- Selector de elementos por página -->
    <div class="items-per-page flex items-center">
      <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
      <select
        id="itemsPerPage"
        [(ngModel)]="itemsPerPage"
        (change)="currentPage = 1; updatePaginatedInventory()"
        class="border border-gray-300 rounded-md p-1"
      >
        <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
          {{ size }}
        </option>
      </select>
    </div>
  </div>
</div>
