<router-outlet></router-outlet>


<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando egresos...</p>
</div>

<!-- FILTROS CON AUTOCOMPLETADO -->
<div class="flex justify-between items-center mb-4 mt-4 ml-2">
  <div class="flex flex-wrap gap-4 items-end mt-4 mb-4">

    <!-- CATEGORÍA PRINCIPAL -->
    <div class="relative">
      <label class="block text-sm font-semibold">Categoría principal</label>
      <input
        type="text"
        [(ngModel)]="filterMainCategorySearch"
        (input)="onFilterMainCategoryInput()"
        (focus)="showFilterMainCategorySuggestions = true; onFilterMainCategoryInput()"
        placeholder="Buscar categoría principal..."
        class="form-input w-48 border border-gray-300 rounded-md p-2"
        autocomplete="off"
      />

      <ul
        *ngIf="showFilterMainCategorySuggestions && filterMainCategorySuggestions.length > 0"
        class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-60 overflow-y-auto mt-1"
      >
        <li
          class="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b font-semibold text-blue-600"
          (click)="selectFilterMainCategory('')"
        >
          ✓ Todas las categorías principales
        </li>
        <li
          *ngFor="let cat of filterMainCategorySuggestions"
          class="p-2 cursor-pointer hover:bg-gray-100 text-sm"
          (click)="selectFilterMainCategory(cat)"
        >
          {{ cat }}
        </li>
      </ul>
    </div>

    <!-- Categoría con Autocompletado -->
    <div class="relative">
      <label class="block text-sm font-semibold">Detalle</label>
      <input
        type="text"
        [(ngModel)]="filterCategorySearch"
        (input)="onFilterCategoryInput()"
        (focus)="showFilterCategorySuggestions = true; onFilterCategoryInput()"
        placeholder="Buscar categoría..."
        class="form-input w-48 border border-gray-300 rounded-md p-2"
        autocomplete="off"
      />
      <ul
        *ngIf="showFilterCategorySuggestions && filterCategorySuggestions.length > 0"
        class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-60 overflow-y-auto mt-1"
      >
        <li
          class="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b font-semibold text-blue-600"
          (click)="selectFilterCategory('')"
        >
          ✓ Todas las categorías
        </li>
        <li
          *ngFor="let cat of filterCategorySuggestions"
          class="p-2 cursor-pointer hover:bg-gray-100 text-sm"
          (click)="selectFilterCategory(cat)"
        >
          {{ getCategoryLabel(cat) }}
        </li>
      </ul>
    </div>

    <!-- Tipo de servicio (solo si filterCategory === 'UTILITIES') -->
    <div *ngIf="filterCategory === 'UTILITIES'" class="relative">
      <label class="block text-sm font-semibold">Tipo de servicio</label>
      <input
        type="text"
        [(ngModel)]="filterServiceTypeSearch"
        (input)="onFilterServiceTypeInput()"
        (focus)="showFilterServiceTypeSuggestions = true; onFilterServiceTypeInput()"
        placeholder="Buscar tipo..."
        class="form-input w-48 border border-gray-300 rounded-md p-2"
        autocomplete="off"
      />
      <ul
        *ngIf="showFilterServiceTypeSuggestions && filterServiceTypeSuggestions.length > 0"
        class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-60 overflow-y-auto mt-1"
      >
        <li
          class="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b font-semibold text-blue-600"
          (click)="selectFilterServiceType('')"
        >
          ✓ Todos los tipos
        </li>
        <li
          *ngFor="let type of filterServiceTypeSuggestions"
          class="p-2 cursor-pointer hover:bg-gray-100 text-sm"
          (click)="selectFilterServiceType(type)"
        >
          {{ type }}
        </li>
      </ul>
    </div>

    <!-- Tercero/Proveedor con Autocompletado -->
    <div class="relative">
      <label class="block text-sm font-semibold">Tercero</label>
      <input
        type="text"
        [(ngModel)]="filterProviderNameSearch"
        (input)="onFilterProviderInput()"
        (focus)="showFilterProviderSuggestions = true; onFilterProviderInput()"
        placeholder="Buscar tercero..."
        class="form-input w-56 border border-gray-300 rounded-md p-2"
        autocomplete="off"
      />
      <ul
        *ngIf="showFilterProviderSuggestions && filterProviderSuggestions.length > 0"
        class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-60 overflow-y-auto mt-1"
      >
        <li
          class="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b font-semibold text-blue-600"
          (click)="selectFilterProvider('')"
        >
          ✓ Todos los terceros
        </li>
        <li
          *ngFor="let name of filterProviderSuggestions"
          class="p-2 cursor-pointer hover:bg-gray-100 text-sm"
          (click)="selectFilterProvider(name)"
        >
          {{ name }}
        </li>
      </ul>
    </div>

    <!-- Solo pendientes -->
    <div class="flex items-center gap-2 mt-6">
      <input
        type="checkbox"
        [(ngModel)]="onlyPending"
        (change)="applyFilters()"
        class="form-checkbox h-4 w-4 text-red-600"
      />
      <span class="text-sm font-semibold">Solo pendientes</span>
    </div>
  </div>

  <!-- Botones (sin cambios) -->
  <div class="flex space-x-2">
    <button class="btn-add inline-flex items-center space-x-2" (click)="addNewExpense()">
      <svg class="w-5 h-5 inline-block"  
        viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M12 5v14M5 12h14" />
      </svg>
      <span>Añadir</span>
    </button>
    <button
      class="btn-primary"
      (click)="openBudgetSummary()">
      Resumen
    </button>
    <button 
      class="btn-details" 
      (click)="generateExpensesKardex()"
    >
      Generar Kardex
    </button>
    <button 
      class="btn-clear" 
      (click)="clearFilters()"
    >
      Limpiar
    </button>
  </div>
</div>


<!-- Filtros de Fecha -->
<div class="flex items-center justify-between space-x-4">
  <div class="flex items-center space-x-4">
    <div>
      <label for="startDate" class="mr-2 font-semibold">Desde:</label>
      <input
        type="date"
        id="startDate"
        [(ngModel)]="startDate"
        (ngModelChange)="applyFilters()"
        class="border border-gray-300 rounded-md p-1"
      />
    </div>
    <div>
      <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
      <input
        type="date"
        id="endDate"
        [(ngModel)]="endDate"
        (ngModelChange)="applyFilters()"
        class="border border-gray-300 rounded-md p-1"
      />
    </div>
  </div>
  <div class="flex items-center space-x-4">
    <div>
      <label for="PaidStartDate" class="mr-2 font-semibold">
        Pago desde:
      </label>
      <input
        type="date"
        id="PaidStartDate"
        [(ngModel)]="PaidStartDate"
        (ngModelChange)="applyFilters()"
        class="border border-gray-300 rounded-md p-1"
      />
    </div>
    <div>
      <label for="PaidEndDate" class="mr-2 font-semibold">
        Pago hasta:
      </label>
      <input
        type="date"
        id="PaidEndDate"
        [(ngModel)]="PaidEndDate"
        (ngModelChange)="applyFilters()"
        class="border border-gray-300 rounded-md p-1"
      />
    </div>
  </div>
</div>

<!-- Resumen de Egresos -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3 mb-3">

  <!-- Total Pagado -->
  <div class="bg-green-50 border border-green-200 rounded-lg p-1">
    <p class="text-xs font-semibold text-green-700">
      Total Salida
    </p>
    <p class="text-lg font-mono font-bold text-green-900 mt-1">
      {{ totalPaid | currency }}
    </p>
    <p class="text-[11px] text-green-700 mt-1">
      Dinero que ya salió de la empresa
    </p>
  </div>

  <!-- Total Pendiente -->
  <div class="bg-red-50 border border-red-200 rounded-lg p-1">
    <p class="text-xs font-semibold text-red-700">
      Total Pendiente
    </p>
    <p class="text-lg font-mono font-bold text-red-900 mt-1">
      {{ totalPending | currency }}
    </p>
    <p class="text-[11px] text-red-700 mt-1">
      Compromisos de pago por cubrir
    </p>
  </div>

  <!-- Total General -->
  <div class="bg-gray-100 border border-gray-300 rounded-lg p-1">
    <p class="text-xs font-semibold text-gray-700">
      Total Egresos
    </p>
    <p class="text-lg font-mono font-bold text-gray-900 mt-1">
      {{ totalExpenses | currency }}
    </p>
    <p class="text-[11px] text-gray-600 mt-1">
      Pagado + Pendiente según filtros
    </p>
  </div>

</div>

<!-- Tabla -->
<div class="mt-4 overflow-x-auto">
  <table class="table-std w-full">
    <thead>
      <tr>
        <th class="table-column-std">Código</th>
        <th class="table-column-std">Fecha</th>
        <th class="table-column-std">Categoría</th>
        <th class="table-column-std">Detalle</th>
        <th class="table-column-std">Tercero</th>
        <th class="table-column-std">Anotación</th>
        <th class="table-column-std">Costo</th>
        <th class="table-column-std">Tipo Pago</th>
        <th class="table-column-std">Estado</th>
        <th class="table-column-std">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let expense of paginatedExpenses" class="hover:bg-gray-50">
        <td class="px-4 py-2 border-b">
          {{ expense.code }}
        </td>
        <td class="px-4 py-2 border-b">
          {{ expense.payment_date | date : "dd-MM-yyyy" }}
        </td>
        <td class="px-4 py-2 border-b font-semibold text-sm">
          {{ expense.mainCategory }}
        </td>
        <td class="px-4 py-2 border-b">
          {{
            expense.category === "UTILITIES" && expense.service_type
              ? getCategoryLabel(expense.category) +
                " - " +
                expense.service_type
              : getCategoryLabel(expense.category)
          }}
        </td>
        <td class="px-4 py-2 border-b text-sm text-gray-600">
          {{ expense.provider_name || "NO APLICA" }}
        </td>
        <td class="px-4 py-2 border-b">{{ expense.description }}</td>
        <td class="px-4 py-2 border-b text-right font-mono">
          {{ expense.cost | currency }}
        </td>
        <td class="px-4 py-2 border-b">
          {{
            expense.type === 'cash' ? 'Efectivo' :
            expense.type === 'nequi' ? 'Nequi' :
            expense.type === 'bancolombia' ? 'Bancolombia' :
            expense.type === 'davivienda' ? 'Davivienda' :
            expense.type === 'transfer' ? 'Transferencia'
            : 'Abono'
          }}
        </td>
        <td class="px-4 py-2 border-b text-center">
        <!-- Si tiene pagos Y está PAGADO completamente -->
        <div *ngIf="expense.payments && expense.payments.length > 0 && expense.payment_status === 'PAID'" class="text-left">
          <div class="flex items-center justify-start gap-2">
            <span class="text-xs font-bold text-green-600">
              Pagado
            </span>
          </div>
        </div>

        <!-- Si tiene pagos PERO aún está PENDIENTE o PARTIAL -->
        <div *ngIf="expense.payments && expense.payments.length > 0 && expense.payment_status !== 'PAID'" class="text-left">
          <div class="flex items-center justify-start gap-2 mb-1">
            <span
              class="text-xs font-bold"
              [ngClass]="{
                'text-orange-500': expense.payment_status === 'PARTIAL',
                'text-red-500': expense.payment_status === 'PENDING'
              }"
            >
              {{ expense.payment_status === 'PARTIAL' ? 'Abono' : 'Pendiente' }}
            </span>
          </div>
          <div class="text-xs text-gray-600">
            Pagado: {{ getTotalPayments(expense) | currency }}
          </div>
          <div class="text-xs text-red-500 font-semibold">
            Falta: {{ getRemainingBalance(expense) | currency }}
          </div>
        </div>

        <!-- Si NO tiene pagos, usar checkbox tradicional -->
        <div *ngIf="!expense.payments || expense.payments.length === 0" class="flex items-center justify-start gap-2">
          <span
            class="text-xs font-bold"
            [ngClass]="{
              'text-green-600': expense.payment_status === 'PAID',
              'text-red-500': expense.payment_status === 'PENDING'
            }"
          >
            {{ expense.payment_status === 'PAID' ? 'Pagado' : 'Pendiente' }}
          </span>
        </div>

        <div
          *ngIf="expense.payment_status === 'PENDING' && expense.payment_due_date"
          class="text-xs text-red-400 mt-1 text-left"
        >
          Vence: {{ expense.payment_due_date | date : 'dd-MM-yyyy' }}
        </div>
      </td>
        <td class="px-4 py-2 border-b">
          <div class="flex gap-2 flex-wrap">
            <button
              class="btn-success inline-flex items-center space-x-1 px-2 py-1 text-xs"
              (click)="openPaymentModal(expense)"
              title="Gestionar Abonos"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span>Abonos</span>
            </button>
            <button
              class="btn-details inline-flex items-center space-x-2 px-2 py-1 text-xs"
              (click)="viewExpenseDetails(expense)"
              title="Ver Detalles y Adjuntos"
            >
              <span>Detalles</span>
            </button>
            <button
              class="btn-edit text-xs px-2 py-1"
              (click)="editExpense(expense)"
            >
              Editar
            </button>
            <button
              class="btn-delete text-xs px-2 py-1"
              [disabled]="deletingExpenseId === expense.id_expenses"
              (click)="deleteExpense(expense); $event.stopPropagation()"
            >
              {{ deletingExpenseId === expense.id_expenses ? 'Eliminando...' : 'Eliminar' }}
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8656;
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700"
      >Página {{ currentPage }} de {{ totalPages }}</span
    >
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8658;
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedExpenses()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Modal para añadir/editar egresos -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content modal-h600">
    <h2 class="text-lg font-bold mb-4">
      {{ isEditing ? "Editar Egreso" : "Añadir Nuevo Egreso" }}
    </h2>

    <!-- Formulario -->
    <form (ngSubmit)="saveExpense()" class="space-y-4">

      <!-- Fecha de Egreso -->
      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700">
          Fecha de Egreso <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          [(ngModel)]="selectedExpense.payment_date"
          name="payment_date"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>

      <!-- CATEGORÍA PRINCIPAL -->
      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2">
          Categoría principal
        </label>

        <select
          name="mainCategory"
          class="w-full input-std"
          [(ngModel)]="selectedExpense.mainCategory"
          (change)="onMainCategoryChange()"
          required
        >
          <option disabled value="">Seleccione una categoría</option>

          <option value="OPERATIVO">OPERATIVO</option>
          <option value="MATERIALES">MATERIALES</option>
          <option value="TITULAR">TITULAR</option>
          <option value="IMPUESTO">IMPUESTO</option>
          <option value="PILA">PILA</option>
          <option value="PRESTACIONES">PRESTACIONES</option>
          <option value="BANCO">BANCO</option>
          <option value="RESERVA">RESERVA</option>
          <option value="INVERSION">INVERSIÓN</option>
        </select>
      </div>

      <!-- NUEVO: Selector de Tipo de Categoría con 3 Botones -->
      <div class="modal-input-item" *ngIf="selectedExpense.mainCategory">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Tipo de subcategoría <span class="text-red-500">*</span>
        </label>
        <div class="flex gap-2 flex-wrap">
          <button
            type="button"
            class="px-4 py-2 rounded border transition-all"
            [class.bg-purple-600]="categoryMode === 'OTHER'"
            [class.text-white]="categoryMode === 'OTHER'"
            [class.border-purple-600]="categoryMode === 'OTHER'"
            [class.bg-white]="categoryMode !== 'OTHER'"
            [class.text-gray-700]="categoryMode !== 'OTHER'"
            [class.border-gray-300]="categoryMode !== 'OTHER'"
            [class.hover:bg-purple-50]="categoryMode !== 'OTHER'"
            (click)="setCategoryMode('OTHER')"
          >
            Otra Categoría
          </button>

          <button
            *ngIf="selectedExpense.mainCategory === 'OPERATIVO'"
            type="button"
            class="px-4 py-2 rounded border transition-all"
            [class.bg-blue-600]="categoryMode === 'UTILITIES'"
            [class.text-white]="categoryMode === 'UTILITIES'"
            [class.border-blue-600]="categoryMode === 'UTILITIES'"
            [class.bg-white]="categoryMode !== 'UTILITIES'"
            [class.text-gray-700]="categoryMode !== 'UTILITIES'"
            [class.border-gray-300]="categoryMode !== 'UTILITIES'"
            [class.hover:bg-blue-50]="categoryMode !== 'UTILITIES'"
            (click)="setCategoryMode('UTILITIES')"
          >
            Servicios Públicos
          </button>

          <button
            *ngIf="selectedExpense.mainCategory === 'MATERIALES'"
            type="button"
            class="px-4 py-2 rounded border transition-all"
            [class.bg-green-600]="categoryMode === 'SUPPLIES'"
            [class.text-white]="categoryMode === 'SUPPLIES'"
            [class.border-green-600]="categoryMode === 'SUPPLIES'"
            [class.bg-white]="categoryMode !== 'SUPPLIES'"
            [class.text-gray-700]="categoryMode !== 'SUPPLIES'"
            [class.border-gray-300]="categoryMode !== 'SUPPLIES'"
            [class.hover:bg-green-50]="categoryMode !== 'SUPPLIES'"
            (click)="setCategoryMode('SUPPLIES')"
          >
           Proveedores / Insumos
          </button>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- OPCIÓN 1: SERVICIOS PÚBLICOS (UTILITIES) -->
      <!-- ============================================ -->
      <div
        *ngIf="categoryMode === 'UTILITIES'"
        class="bg-blue-50 p-4 rounded-md border border-blue-200 space-y-3 mt-2"
      >
        <h3 class="font-semibold text-blue-800 text-sm flex items-center gap-2">
          Tipo de Servicio Público
        </h3>

        <!-- Input con Autocompletado -->
        <div class="relative">
          <input
            type="text"
            [(ngModel)]="serviceTypeSearch"
            (input)="onServiceTypeInput()"
            (focus)="showServiceTypeSuggestions = true; 
            onServiceTypeInput()"
            name="service_type_search"
            placeholder="Buscar o escribir tipo de servicio (ej: Agua, Luz, Gas)"
            class="form-input w-full text-sm rounded-md"
            autocomplete="off"
          />

          <!-- Lista de sugerencias -->
          <ul
            *ngIf="showServiceTypeSuggestions && serviceTypeSuggestions.length > 0"
            class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-40 overflow-y-auto mt-1"
          >
            <li
              *ngFor="let type of serviceTypeSuggestions"
              class="p-2 cursor-pointer hover:bg-blue-100 text-sm"
              (click)="selectServiceType(type)"
            >
              {{ type }}
            </li>
          </ul>
        </div>

        <!-- Botón para crear nuevo tipo -->
        <button
          type="button"
          class="btn-primary text-sm px-3 py-1 w-full"
          (click)="confirmNewServiceType()"
          *ngIf="serviceTypeSearch && !isExistingServiceType(serviceTypeSearch) && !serviceTypeJustCreated"
        >
          Crear nuevo tipo: "{{ serviceTypeSearch }}"
        </button>

        <!-- Confirmación visual -->
        <div
          *ngIf="serviceTypeJustCreated"
          class="flex items-center justify-center gap-2 rounded-md bg-green-100 border border-green-300 p-2 text-green-800 text-sm"
        >
          Tipo de servicio creado y seleccionado
        </div>

        <p class="text-xs text-blue-600 mt-1">
          Escribe para buscar entre servicios existentes o crear uno nuevo
        </p>

        <!-- Campo "Pagado a" (Tercero) -->
        <div class="mt-3 pt-3 border-t border-purple-300">
          <h4 class="font-semibold text-purple-700 text-sm mb-2">Pagado a (Tercero):</h4>

          <div class="relative">
            <input
              type="text"
              [(ngModel)]="selectedExpense.provider_name"
              name="provider_name"
              placeholder="Nombre de la persona o entidad"
              class="form-input w-full rounded-md text-sm"
              (input)="onThirdPartyInput()"
              (focus)="onThirdPartyInput()"
              autocomplete="off"
            />
            <ul
              *ngIf="thirdPartySuggestions.length > 0"
              class="absolute z-[9999] w-full bg-white border rounded shadow max-h-40 overflow-y-auto mt-1"
            >
              <li
                *ngFor="let name of thirdPartySuggestions"
                class="p-2 cursor-pointer hover:bg-gray-100"
                (click)="selectThirdParty(name)"
              >
                {{ name }}
              </li>
            </ul>
          </div>

          <small *ngIf="thirdPartySuggestions.length === 0 && selectedExpense.provider_name" class="text-xs text-purple-500">
            Se guardará como nuevo tercero
          </small>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- OPCIÓN 2: PROVEEDORES / INSUMOS (SUPPLIES) -->
      <!-- ============================================ -->
      <div
        *ngIf="categoryMode === 'SUPPLIES'"
        class="bg-green-50 p-4 rounded-md border border-green-200 space-y-3 mt-2"
      >
        <h3 class="font-semibold text-green-800 text-sm flex items-center gap-2">
          Seleccionar Proveedor
        </h3>

        <!-- Input con Autocompletado -->
        <div class="relative">
          <input
            type="text"
            [(ngModel)]="providerSearch"
            (input)="onProviderSearchInput()"
            (focus)="showProviderSuggestions = true; onProviderSearchInput()"
            name="provider_search"
            placeholder="Buscar por nombre, empresa o documento..."
            class="form-input w-full text-sm rounded-md"
            autocomplete="off"
            [disabled]="isNewProviderMode"
          />

          <!-- Lista de sugerencias -->
          <ul
            *ngIf="showProviderSuggestions && providerSuggestions.length > 0 && !isNewProviderMode"
            class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-48 overflow-y-auto mt-1"
          >
            <li
              *ngFor="let prov of providerSuggestions"
              class="p-2 cursor-pointer hover:bg-green-100 text-sm border-b"
              (click)="selectProvider(prov)"
            >
              <div class="font-semibold">{{ prov.company_name || prov.name }}</div>
              <div class="text-xs text-gray-600">{{ prov.document_number }}</div>
            </li>
          </ul>
        </div>

        <!-- Botón para nuevo proveedor -->
        <button
          type="button"
          class="btn-primary text-sm px-3 py-1 w-full"
          (click)="openNewProviderMode()"
          *ngIf="!isNewProviderMode"
        >
          Crear Nuevo Proveedor
        </button>

        <!-- Formulario de Nuevo Proveedor -->
        <div
          *ngIf="isNewProviderMode"
          class="pl-2 border-l-2 border-green-400 space-y-2"
        >
          <p class="text-xs font-semibold text-green-700">Datos del Nuevo Proveedor:</p>

          <input
            type="text"
            [(ngModel)]="newProviderData.company_name"
            name="new_company"
            placeholder="Nombre Empresa / Razón Social"
            class="form-input w-full text-sm rounded-md"
          />

          <div class="flex gap-2">
            <input
              type="text"
              [(ngModel)]="newProviderData.name"
              name="new_name"
              placeholder="Nombre Contacto"
              class="form-input w-1/2 text-sm rounded-md"
            />
            <input
              type="text"
              [(ngModel)]="newProviderData.document_number"
              name="new_doc"
              placeholder="NIT / Cédula"
              class="form-input w-1/2 text-sm rounded-md"
            />
          </div>

          <input
            type="text"
            [(ngModel)]="newProviderData.phone_number"
            name="new_phone"
            placeholder="Teléfono"
            class="form-input w-full text-sm rounded-md"
          />

          <button
            type="button"
            class="btn-danger text-sm px-3 py-1"
            (click)="isNewProviderMode = false; providerSearch = ''"
          >
            Cancelar Nuevo Proveedor
          </button>
        </div>

        <p class="text-xs text-green-600 mt-1">
          Escribe para buscar entre proveedores existentes
        </p>
      </div>

      <!-- ============================================ -->
      <!-- OPCIÓN 3: OTRA CATEGORÍA (OTHER) -->
      <!-- ============================================ -->
      <div
        *ngIf="categoryMode === 'OTHER'"
        class="bg-purple-50 p-4 rounded-md border border-purple-200 space-y-3 mt-2"
      >
        <h3 class="font-semibold text-purple-800 text-sm flex items-center gap-2">
          Categoría del Egreso
        </h3>

        <!-- Input con Autocompletado -->
        <div class="relative">
          <input
            type="text"
            [(ngModel)]="categorySearch"
            (input)="onCategoryInput(); showCategorySuggestions = true"
            (focus)="showCategorySuggestions = true; onCategoryInput()"
            (blur)="onCategoryBlur()"
            name="category_search"
            placeholder="Ej: Arriendo, Nómina, Honorarios, Seguros..."
            class="form-input w-full text-sm rounded-md"
            autocomplete="off"
          />

          <!-- Lista de sugerencias -->
          <ul
            *ngIf="showCategorySuggestions && categorySuggestions.length > 0"
            class="absolute z-[9999] w-full bg-white border rounded shadow-lg max-h-40 overflow-y-auto mt-1"
          >
            <li
              *ngFor="let cat of categorySuggestions"
              class="p-2 cursor-pointer hover:bg-purple-100 text-sm"
              (mousedown)="selectCategory(cat)"
            >
              {{ getCategoryLabel(cat) }}
            </li>
          </ul>
        </div>

        <p class="text-xs text-purple-600 mt-1">
          Escribe el nombre de la categoría. Si no existe, se creará automáticamente
        </p>

        <!-- Campo "Pagado a" (Tercero) -->
        <div class="mt-3 pt-3 border-t border-purple-300">
          <h4 class="font-semibold text-purple-700 text-sm mb-2">Pagado a (Tercero):</h4>

          <div class="relative">
            <input
              type="text"
              [(ngModel)]="selectedExpense.provider_name"
              name="provider_name"
              placeholder="Nombre de la persona o entidad"
              class="form-input w-full rounded-md text-sm"
              (input)="onThirdPartyInput()"
              (focus)="onThirdPartyInput()"
              autocomplete="off"
            />
            <ul
              *ngIf="thirdPartySuggestions.length > 0"
              class="absolute z-[9999] w-full bg-white border rounded shadow max-h-40 overflow-y-auto mt-1"
            >
              <li
                *ngFor="let name of thirdPartySuggestions"
                class="p-2 cursor-pointer hover:bg-gray-100"
                (click)="selectThirdParty(name)"
              >
                {{ name }}
              </li>
            </ul>
          </div>

          <small *ngIf="thirdPartySuggestions.length === 0 && selectedExpense.provider_name" class="text-xs text-purple-500">
            Se guardará como nuevo tercero
          </small>
        </div>
      </div>

      <!-- Anotación -->
      <div class="modal-input-item">
        <label for="description">Anotación</label>
        <textarea
          [(ngModel)]="selectedExpense.description"
          name="description"
          rows="2"
          class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm"
        ></textarea>
      </div>

      <!-- Costo -->
      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700">
          Costo <span class="text-red-500">*</span>
        </label>
        <input
          type="number"
          [(ngModel)]="selectedExpense.cost"
          name="cost"
          step="0.01"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>

      <!-- Adjuntos -->
      <div class="bg-gray-50 p-4 rounded-md border border-gray-200 mt-4 space-y-4">
        <h3 class="font-semibold text-gray-800 text-sm">Adjuntos</h3>

        <!-- Factura / Recibo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Factura / Recibo
          </label>
          <div class="flex items-center gap-2">
            <input
              type="file"
              (change)="onInvoiceFileSelected($event)"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            <button
              *ngIf="selectedExpense.invoice_file_path"
              type="button"
              (click)="downloadFile(selectedExpense.invoice_file_path)"
              class="text-blue-600 hover:text-blue-800 text-sm font-bold flex items-center gap-1"
              title="Descargar Factura Actual"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                />
              </svg>
              Ver
            </button>
          </div>
        </div>

        <!-- Comprobante de Pago -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Comprobante de Pago
          </label>
          <div class="flex items-center gap-2">
            <input
              type="file"
              (change)="onProofFileSelected($event)"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
            />
            <button
              *ngIf="selectedExpense.proof_of_payment_path"
              type="button"
              (click)="downloadFile(selectedExpense.proof_of_payment_path)"
              class="text-green-600 hover:text-green-800 text-sm font-bold flex items-center gap-1"
              title="Descargar Comprobante Actual"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                />
              </svg>
              Ver
            </button>
          </div>
        </div>
      </div>

      <!-- Estado de Pago -->
      <div class="bg-gray-50 p-3 rounded border border-gray-200 mt-4">
        <div class="flex gap-4 items-center">
          <span class="text-sm font-bold text-gray-700">Estado de Pago:</span>

          <label class="inline-flex items-center cursor-pointer">
            <input
              type="radio"
              class="form-radio text-green-600"
              name="payment_status"
              value="PAID"
              [(ngModel)]="selectedExpense.payment_status"
              (change)="onStatusChange($event)"
            />
            <span class="ml-2 text-sm">Pagado</span>
          </label>

          <label class="inline-flex items-center cursor-pointer">
            <input
              type="radio"
              class="form-radio text-red-600"
              name="payment_status"
              value="PENDING"
              [(ngModel)]="selectedExpense.payment_status"
              (change)="onStatusChange($event)"
            />
            <span class="ml-2 text-sm">Pendiente</span>
          </label>
        </div>

        <!-- Fecha Límite si está Pendiente -->
        <div
          *ngIf="selectedExpense.payment_status === 'PENDING'"
          class="mt-3 animate-fadeIn"
        >
          <label class="block text-sm font-medium text-red-700">
            Fecha Límite de Pago <span class="text-red-500">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="selectedExpense.payment_due_date"
            name="payment_due_date"
            class="form-input mt-1 block w-full rounded-md border-red-300 focus:ring-red-500"
            [required]="selectedExpense.payment_status === 'PENDING'"
          />
          <p class="text-xs text-red-500 mt-1 font-semibold">
            Se generará alerta 1 día antes y el mismo día.
          </p>
        </div>

        <!-- Método de Pago -->
        <div 
          *ngIf="selectedExpense.payment_status === 'PAID' || selectedExpense.payment_status === 'PARTIAL'"
          class="mt-3 animate-fadeIn"
        >
          <label class="block text-sm font-medium text-green-700">
            Método de Pago <span class="text-red-500">*</span>
          </label>
          <select
            [(ngModel)]="selectedExpense.type"
            name="type"
            class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"
            [required]="selectedExpense.payment_status === 'PAID' || selectedExpense.payment_status === 'PARTIAL'"
          >
            <option value="">Seleccione un método</option>
            <option value="cash">Efectivo</option>
            <option value="nequi">Nequi</option>
            <option value="bancolombia">Bancolombia</option>
            <option value="davivienda">Davivienda</option>
            <option value="transfer">Transferencia</option>
          </select>
        </div>
      </div>

      <!-- Botones de Acción -->
      <div class="flex justify-end gap-3 pt-4 border-t mt-4">
        <button
          type="button"
          class="btn-danger px-4 py-2"
          (click)="closeModal()"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="btn-success px-4 py-2"
          [disabled]="isSaving || !categoryMode"
        >
          {{ submitButtonText }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Detalles -->
<div *ngIf="showDetailsModal" class="modal-overlay">
  <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl modal-h550 overflow-y-auto">

    <div class="flex justify-between items-start mb-4 border-b pb-2">
      <h2 class="text-xl font-bold text-gray-800">
        Detalle de Egreso
      </h2>
      <button (click)="closeDetailsModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Fecha</label>
          <p class="text-gray-900">{{ formatDateEs(selectedExpense.payment_date) }}</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Costo</label>
          <p class="text-xl font-mono font-bold text-gray-900">{{ selectedExpense.cost | currency }}</p>
        </div>
        <div class="space-y-1">
          <label class="block text-xs font-bold text-gray-500 uppercase">
            Categoría
          </label>

          <div class="flex flex-wrap gap-2 items-center">
            <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">
              {{ selectedExpense.mainCategory }}
            </span>

            <span class="text-gray-400 font-bold">→</span>

            <span class="inline-block bg-gray-100 px-2 py-1 rounded text-sm font-semibold text-gray-700">
              {{ getCategoryLabel(selectedExpense.category) }}
            </span>

            <span
              *ngIf="selectedExpense.service_type"
              class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-semibold"
            >
              {{ selectedExpense.service_type }}
            </span>
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Método de Pago</label>
          <p class="text-gray-900">
            {{
              selectedExpense.type === 'cash' ? 'Efectivo' :
              selectedExpense.type === 'nequi' ? 'Nequi' :
              selectedExpense.type === 'bancolombia' ? 'Bancolombia' :
              selectedExpense.type === 'davivienda' ? 'Davivienda' :
              selectedExpense.type === 'transfer' ? 'Transferencia'
              : 'Ninguno'
            }}
          </p>
        </div>
      </div>

      <div *ngIf="selectedExpense.provider_name" class="bg-blue-50 p-3 rounded border border-blue-100">
        <label class="block text-xs font-bold text-blue-500 uppercase">Tercero</label>
        <p class="text-blue-900 font-medium">{{ selectedExpense.provider_name }}</p>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase">Anotación / Descripción</label>
        <div class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800 whitespace-pre-wrap">
          {{ selectedExpense.description }}
        </div>
      </div>

      <div class="flex items-center gap-2 mt-2">
        <label class="block text-xs font-bold text-gray-500 uppercase">Estado:</label>
        <span class="px-2 py-1 text-xs font-bold rounded"
          [ngClass]="{'bg-green-100 text-green-700': selectedExpense.payment_status === 'PAID', 'bg-red-100 text-red-700': selectedExpense.payment_status === 'PENDING'}">
          {{ selectedExpense.payment_status === 'PAID' ? 'PAGADO' : 'PENDIENTE' }}
        </span>
        <span *ngIf="selectedExpense.payment_status === 'PENDING'" class="text-xs text-red-500 font-semibold">
          (Vence: {{ selectedExpense.payment_due_date | date: 'dd/MM/yyyy' }})
        </span>
        <span *ngIf="selectedExpense.payment_status === 'PAID'" class="px-2 py-1 text-xs font-bold rounded"
          [ngClass]="{'bg-green-100 text-green-700': selectedExpense.payment_status === 'PAID'}">
          {{ selectedExpense.paid_at | date : 'dd/MM/yyyy' }}
        </span>
      </div>

      <div class="border-t pt-4 mt-4">
        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
             <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
           </svg>
           Adjuntos
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div class="border rounded p-3 flex items-center justify-between bg-gray-50">
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold text-gray-600">Factura / Recibo</span>
            </div>
            <button
              *ngIf="selectedExpense.invoice_file_path"
              (click)="downloadFile(selectedExpense.invoice_file_path)"
              class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
            >
              Descargar
            </button>
            <span *ngIf="!selectedExpense.invoice_file_path" class="text-xs text-gray-400 italic">No adjuntado</span>
          </div>

          <div class="border rounded p-3 flex items-center justify-between bg-gray-50">
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold text-gray-600">Comprobante Pago</span>
            </div>
            <button
              *ngIf="selectedExpense.proof_of_payment_path"
              (click)="downloadFile(selectedExpense.proof_of_payment_path)"
              class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
            >
              Descargar
            </button>
            <span *ngIf="!selectedExpense.proof_of_payment_path" class="text-xs text-gray-400 italic">No adjuntado</span>
          </div>

        </div>
      </div>

    </div>

    <div class="flex justify-end mt-6">
      <button class="btn-primary px-6" (click)="closeDetailsModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Gestión de Abonos -->
<div *ngIf="showPaymentModal && selectedExpenseForPayment" class="modal-overlay">
  <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl modal-h550 overflow-y-auto">
    <div class="flex justify-between items-start mb-4 border-b pb-2">
      <h2 class="text-xl font-bold text-gray-800">
        Gestión de Abonos - {{ getCategoryLabel(selectedExpenseForPayment.category) }}
      </h2>
      <button (click)="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Resumen del Egreso -->
    <div class="bg-gray-50 p-4 rounded-md mb-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-xs font-bold text-gray-500 uppercase">Total del Egreso</p>
          <p class="text-2xl font-mono font-bold text-gray-900">{{ selectedExpenseForPayment.cost | currency }}</p>
        </div>
        <div>
          <p class="text-xs font-bold text-gray-500 uppercase">Total Pagado</p>
          <p class="text-2xl font-mono font-bold text-green-600">{{ getTotalPayments(selectedExpenseForPayment) | currency }}</p>
        </div>
        <div class="col-span-2">
          <p class="text-xs font-bold text-gray-500 uppercase">Saldo Pendiente</p>
          <p class="text-2xl font-mono font-bold text-red-600">{{ getRemainingBalance(selectedExpenseForPayment) | currency }}</p>
        </div>
      </div>
    </div>

    <!-- Formulario para Agregar Abono -->
    <div
      class="bg-blue-50 p-4 rounded-md mb-4"
      *ngIf="getRemainingBalance(selectedExpenseForPayment) > 0 &&
            (selectedExpenseForPayment.payment_status !== 'PAID' ||
            (selectedExpenseForPayment.payments && selectedExpenseForPayment.payments.length > 0))"
    >
      <h3 class="font-bold text-blue-800 mb-3">Agregar Nuevo Abono</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">Monto del Abono</label>
          <input
            type="number"
            [(ngModel)]="newPaymentAmount"
            [max]="getRemainingBalance(selectedExpenseForPayment)"
            min="0"
            step="100"
            class="form-input mt-1 block w-full rounded-md"
            placeholder="Ingrese el monto"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Método de Pago</label>
          <select
            [(ngModel)]="newPaymentMethod"
            class="form-select mt-1 block w-full rounded-md"
          >
            <option value="" disabled>Seleccione un método</option>
            <option value="cash">Efectivo</option>
            <option value="nequi">Nequi</option>
            <option value="bancolombia">Bancolombia</option>
            <option value="davivienda">Davivienda</option>
            <option value="transfer">Transferencia</option>
          </select>
        </div>
        <button
          type="button"
          class="btn-success w-full"
          (click)="addPayment(selectedExpenseForPayment, newPaymentAmount)"
          [disabled]="!newPaymentAmount || newPaymentAmount <= 0 || !newPaymentMethod"
        >
          Registrar Abono
        </button>
      </div>
    </div>

    <!-- Mensaje cuando está pagado SIN abonos previos -->
    <div
      *ngIf="selectedExpenseForPayment.payment_status === 'PAID' && (!selectedExpenseForPayment.payments || selectedExpenseForPayment.payments.length === 0)"
      class="bg-green-50 p-4 rounded-md mb-4 border border-green-200"
    >
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-green-600">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        <div>
          <h3 class="font-bold text-green-800">Egreso Pagado Completo</h3>
          <p class="text-sm text-green-700">Este egreso fue marcado como pagado sin necesidad de abonos parciales.</p>
        </div>
      </div>
    </div>


    <!-- Lista de Abonos Registrados -->
    <div class="border-t pt-4">
      <h3 class="font-bold text-gray-800 mb-3">Historial de Abonos</h3>
      <div *ngIf="!selectedExpenseForPayment.payments || selectedExpenseForPayment.payments.length === 0" class="text-center text-gray-500 py-4">
        No hay abonos registrados
      </div>
      <div *ngIf="selectedExpenseForPayment.payments && selectedExpenseForPayment.payments.length > 0" class="space-y-2">
        <div
          *ngFor="let payment of selectedExpenseForPayment.payments"
          class="flex items-center justify-between p-3 bg-gray-50 rounded-md border"
        >
          <div class="flex-1">
            <p class="font-mono font-bold text-gray-900">{{ payment.amount | currency }}</p>
            <p class="text-xs text-gray-600">
              {{ payment.payment_date | date : 'dd/MM/yyyy HH:mm' }}
              <span *ngIf="payment.payment_method"> - {{
                payment.payment_method === 'cash' ? 'Efectivo' :
                payment.payment_method === 'nequi' ? 'Nequi' :
                payment.payment_method === 'bancolombia' ? 'Bancolombia' :
                payment.payment_method === 'davivienda' ? 'Davivienda' :
                payment.payment_method === 'transfer' ? 'Transferencia' :
                payment.payment_method
              }}</span>
            </p>
          </div>
          <div class="flex gap-2">
            <button
              class="btn-edit text-xs px-2 py-1"
              (click)="openEditPaymentModal(payment)"
            >
              Editar
            </button>
            <button
              class="btn-delete text-xs px-2 py-1"
              (click)="deletePayment(payment.id_expense_payment!, selectedExpenseForPayment.id_expenses)"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="flex justify-end mt-6">
      <button class="btn-primary px-6" (click)="closePaymentModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Edición de Abono -->
<div *ngIf="showEditPaymentModal && selectedPayment" class="modal-overlay">
  <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Editar Abono</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Monto</label>
        <input
          type="number"
          [(ngModel)]="selectedPayment.amount"
          min="0"
          step="100"
          class="form-input mt-1 block w-full rounded-md"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Método de Pago</label>
        <select
          [(ngModel)]="selectedPayment.payment_method"
          class="form-select mt-1 block w-full rounded-md"
        >
          <option value="" disabled>Seleccione un método</option>
          <option value="cash">Efectivo</option>
          <option value="nequi">Nequi</option>
          <option value="bancolombia">Bancolombia</option>
          <option value="davivienda">Davivienda</option>
          <option value="transfer">Transferencia</option>
        </select>
      </div>
      <div class="flex justify-end gap-3">
        <button class="btn-danger" (click)="closeEditPaymentModal()">Cancelar</button>
        <button class="btn-success" (click)="updatePayment()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal-overlay"
  *ngIf="showBudgetModal">

  <div class="modal-container bg-white rounded-lg shadow-xl p-6 max-w-5xl">

    <!-- HEADER -->
    <div class="modal-header">
      <h2 class="text-xl font-bold">
        Presupuesto vs Real
      </h2>
    </div>

    <!-- INPUT TOTAL RECIBIDO -->
    <div class="mb-4">
      <label class="block font-semibold mb-1">
        Total Recibido
      </label>

      <input
        type="number"
        min="0"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-black focus:outline-none focus:ring-2 focus:ring-primary"
        [(ngModel)]="totalRecibido"
        (ngModelChange)="onTotalRecibidoChange()"
        placeholder="Ingrese el total recibido"
      />
    </div>

    <!-- TABLA -->
    <div class="mt-4 border border-gray-200 rounded-lg overflow-hidden">
      <table class="table-std w-full">

        <thead class="bg-gray-100">
          <tr>
            <th>Categoría</th>
            <th>% Presupuestado</th>
            <th>$ Presupuestado</th>
            <th>% Real</th>
            <th>$ Real</th>
            <th>$ Diferencia</th>
          </tr>
        </thead>

        <tbody>

          <tr *ngFor="let row of budgetSummary">
            <td class="font-semibold">
              {{ row.category }}
            </td>

            <td>
              <input
                type="number"
                min="0"
                step="0.01"
                class="w-24 px-2 py-1 border border-gray-300 rounded bg-white text-black text-right"
                [(ngModel)]="row.editedPercentBudgeted"
              />
              <span class="ml-1">%</span>
            </td>

            <td>
              {{ (totalRecibido * row.editedPercentBudgeted) | number:'1.2-2' }}
            </td>

            <td>
              {{ row.percentReal * 100 | number:'1.0-2' }}%
            </td>

            <td>
              {{ row.amountReal | number:'1.2-2' }}
            </td>

            <td
              class="text-right font-mono"
              [ngClass]="{
                'text-red-600 font-bold': row.differenceAmount < 0,
                'text-green-600 font-bold': row.differenceAmount > 0,
                'text-gray-600': row.differenceAmount === 0
              }"
            >
              {{ row.differenceAmount | number:'1.2-2' }}
            </td>

          </tr>

          <!-- EMPTY STATE -->
          <tr *ngIf="budgetSummary.length === 0">
            <td colspan="5" class="text-center text-gray-500 py-4">
              Ingrese un total recibido para ver el resumen.
            </td>
          </tr>

        </tbody>

      </table>
    </div>

    <!-- FOOTER -->
    <div class="modal-footer mt-4 flex justify-end gap-2">
      <small class="text-gray-500">
        Los cambios en porcentajes no se guardan automáticamente.
      </small>

      <button
        class="btn-details"
        (click)="saveBudgetPercentages()">
        Guardar %
      </button>

      <button class="btn-success"
        (click)="exportBudgetSummaryToExcel()">
        Descargar
      </button>

      <button
        class="btn-danger"
        (click)="closeBudgetSummary()">
        Cerrar
      </button>
    </div>

  </div>
</div>

<!-- Notificación Toast -->
<div
  *ngIf="notificationMessage"
  class="fixed top-6 left-1/2 z-[9999] -translate-x-1/2 rounded-lg bg-red-600 px-6 py-3 text-white shadow-xl"
  [ngClass]="{
    'bg-green-600': notificationType === 'success',
    'bg-red-600': notificationType === 'error',
    'bg-blue-600': notificationType === 'info'
  }"
>
  {{ notificationMessage }}
</div>

