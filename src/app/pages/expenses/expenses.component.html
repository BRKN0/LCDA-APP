<router-outlet></router-outlet>


<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando egresos...</p>
</div>
<div class="flex justify-between items-center mb-4 mt-4 ml-2">
  <div class="flex flex-wrap gap-4 items-end mt-4 mb-4">
    <!-- Categoría -->
    <div>
      <label class="block text-sm font-semibold">Categoría</label>
      <select
        [(ngModel)]="filterCategory"
        (change)="onFilterCategoryChange()"
        class="form-select w-48"
      >
        <option value="">Todas</option>
        <option *ngFor="let c of getFilterCategories()" [value]="c">
          {{ getCategoryLabel(c) }}
        </option>
      </select>
    </div>

    <!-- Tipo de servicio -->
    <div *ngIf="filterCategory === 'UTILITIES'">
      <label class="block text-sm font-semibold">Tipo de servicio</label>
      <select
        [(ngModel)]="filterServiceType"
        (change)="applyFilters()"
        class="form-select w-48"
      >
        <option value="">Todos</option>
        <option *ngFor="let s of getFilterServiceTypes()" [value]="s">
          {{ s }}
        </option>
      </select>
    </div>

    <!-- Proveedor -->
    <div>
      <label class="block text-sm font-semibold">Tercero</label>
      <select
        [(ngModel)]="filterProviderName"
        (change)="applyFilters()"
        class="form-select w-56"
      >
        <option value="">Todos</option>
        <option *ngFor="let name of getThirdParties()" [value]="name">
          {{ name }}
        </option>
      </select>
    </div>

    <!-- Solo pendientes -->
    <div class="flex items-center gap-2 mt-6">
      <input
        type="checkbox"
        [(ngModel)]="onlyPending"
        (change)="applyFilters()"
        class="form-checkbox h-4 w-4 text-red-600"
      />
      <span class="text-sm font-semibold">Solo pendientes</span>
    </div>
  </div>
  <div class="flex space-x-2">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="addNewExpense()"
    >
      <svg
        class="w-5 h-5 inline-block"
        viewBox="0 0 24 24"
        fill="none"
        stroke="white"
        stroke-width="2"
      >
        <path d="M12 5v14M5 12h14" />
      </svg>
      <span>Añadir</span>
    </button>
    <button class="btn-details" (click)="generateExpensesKardex()">
      Generar Kardex
    </button>
    <button class="btn-clear" (click)="clearFilters()">Limpiar</button>
  </div>
</div>
<div class="flex items-center space-x-4">
  <div>
    <label for="startDate" class="mr-2 font-semibold">Desde:</label>
    <input
      type="date"
      id="startDate"
      [(ngModel)]="startDate"
      (ngModelChange)="applyFilters()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
    <input
      type="date"
      id="endDate"
      [(ngModel)]="endDate"
      (ngModelChange)="applyFilters()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
</div>

<!-- Resumen de Egresos -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3 mb-3">

  <!-- Total Pagado -->
  <div class="bg-green-50 border border-green-200 rounded-lg p-1">
    <p class="text-xs font-semibold text-green-700">
      Total Salida
    </p>
    <p class="text-lg font-mono font-bold text-green-900 mt-1">
      {{ totalPaid | currency }}
    </p>
    <p class="text-[11px] text-green-700 mt-1">
      Dinero que ya salió de la empresa
    </p>
  </div>

  <!-- Total Pendiente -->
  <div class="bg-red-50 border border-red-200 rounded-lg p-1">
    <p class="text-xs font-semibold text-red-700">
      Total Pendiente
    </p>
    <p class="text-lg font-mono font-bold text-red-900 mt-1">
      {{ totalPending | currency }}
    </p>
    <p class="text-[11px] text-red-700 mt-1">
      Compromisos de pago por cubrir
    </p>
  </div>

  <!-- Total General -->
  <div class="bg-gray-100 border border-gray-300 rounded-lg p-1">
    <p class="text-xs font-semibold text-gray-700">
      Total Egresos
    </p>
    <p class="text-lg font-mono font-bold text-gray-900 mt-1">
      {{ totalExpenses | currency }}
    </p>
    <p class="text-[11px] text-gray-600 mt-1">
      Pagado + Pendiente según filtros
    </p>
  </div>

</div>

<!-- Tabla -->
<div class="mt-4 overflow-x-auto">
  <table class="table-std w-full">
    <thead>
      <tr>
        <th class="table-column-std">Fecha</th>
        <th class="table-column-std">Categoría</th>
        <th class="table-column-std">Tercero</th>
        <th class="table-column-std">Anotación</th>
        <th class="table-column-std">Costo</th>
        <th class="table-column-std">Tipo Pago</th>
        <th class="table-column-std">Estado</th>
        <th class="table-column-std">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let expense of paginatedExpenses" class="hover:bg-gray-50">
        <td class="px-4 py-2 border-b">
          {{ expense.payment_date | date : "dd-MM-yyyy" }}
        </td>

        <td class="px-4 py-2 border-b">
          {{
            expense.category === "UTILITIES" && expense.service_type
              ? getCategoryLabel(expense.category) +
                " - " +
                expense.service_type
              : getCategoryLabel(expense.category)
          }}
        </td>
        <td class="px-4 py-2 border-b text-sm text-gray-600">
          {{ expense.provider_name || "NO APLICA" }}
        </td>
        <td class="px-4 py-2 border-b">{{ expense.description }}</td>
        <td class="px-4 py-2 border-b text-right font-mono">
          {{ expense.cost | currency }}
        </td>
        <td class="px-4 py-2 border-b">
          {{
            expense.type === 'cash' ? 'Efectivo' :
            expense.type === 'nequi' ? 'Nequi' :
            expense.type === 'bancolombia' ? 'Bancolombia' :
            expense.type === 'davivienda' ? 'Davivienda' :
            expense.type === 'transfer' ? 'Transferencia'
            : 'Abono'
          }}
        </td>
        <td class="px-4 py-2 border-b text-center">
        <!-- Si tiene pagos Y está PAGADO completamente -->
        <div *ngIf="expense.payments && expense.payments.length > 0 && expense.payment_status === 'PAID'" class="text-left">
          <div class="flex items-center justify-start gap-2">
            <span class="text-xs font-bold text-green-600">
              Pagado
            </span>
          </div>
        </div>

        <!-- Si tiene pagos PERO aún está PENDIENTE o PARTIAL -->
        <div *ngIf="expense.payments && expense.payments.length > 0 && expense.payment_status !== 'PAID'" class="text-left">
          <div class="flex items-center justify-start gap-2 mb-1">
            <span
              class="text-xs font-bold"
              [ngClass]="{
                'text-orange-500': expense.payment_status === 'PARTIAL',
                'text-red-500': expense.payment_status === 'PENDING'
              }"
            >
              {{ expense.payment_status === 'PARTIAL' ? 'Abono' : 'Pendiente' }}
            </span>
          </div>
          <div class="text-xs text-gray-600">
            Pagado: {{ getTotalPayments(expense) | currency }}
          </div>
          <div class="text-xs text-red-500 font-semibold">
            Falta: {{ getRemainingBalance(expense) | currency }}
          </div>
        </div>

        <!-- Si NO tiene pagos, usar checkbox tradicional -->
        <div *ngIf="!expense.payments || expense.payments.length === 0" class="flex items-center justify-start gap-2">
          <input
            type="checkbox"
            [checked]="expense.payment_status === 'PAID'"
            (change)="toggleExpenseStatus(expense)"
            class="w-4 h-4 text-green-600 rounded border-gray-300 cursor-pointer focus:ring-green-500"
          />
          <span
            class="text-xs font-bold"
            [ngClass]="{
              'text-green-600': expense.payment_status === 'PAID',
              'text-red-500': expense.payment_status === 'PENDING'
            }"
          >
            {{ expense.payment_status === 'PAID' ? 'Pagado' : 'Pendiente' }}
          </span>
        </div>

        <div
          *ngIf="expense.payment_status === 'PENDING' && expense.payment_due_date"
          class="text-xs text-red-400 mt-1 text-left"
        >
          Vence: {{ expense.payment_due_date | date : 'dd-MM-yyyy' }}
        </div>
      </td>
        <td class="px-4 py-2 border-b">
          <div class="flex gap-2 flex-wrap">
            <button
              class="btn-success inline-flex items-center space-x-1 px-2 py-1 text-xs"
              (click)="openPaymentModal(expense)"
              title="Gestionar Abonos"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span>Abonos</span>
            </button>
            <button
              class="btn-details inline-flex items-center space-x-2 px-2 py-1 text-xs"
              (click)="viewExpenseDetails(expense)"
              title="Ver Detalles y Adjuntos"
            >
              <span>Detalles</span>
            </button>
            <button
              class="btn-edit text-xs px-2 py-1"
              (click)="editExpense(expense)"
            >
              Editar
            </button>
            <button
              class="btn-delete text-xs px-2 py-1"
              [disabled]="deletingExpenseId === expense.id_expenses"
              (click)="deleteExpense(expense); $event.stopPropagation()"
            >
              {{ deletingExpenseId === expense.id_expenses ? 'Eliminando...' : 'Eliminar' }}
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8656;
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700"
      >Página {{ currentPage }} de {{ totalPages }}</span
    >
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8658;
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedExpenses()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Modal para añadir/editar egresos -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content modal-h600">
    <h2 class="text-lg font-bold mb-4">
      {{ isEditing ? "Editar Egreso" : "Añadir Nuevo Egreso" }}
    </h2>

    <!-- Formulario -->
    <form (ngSubmit)="saveExpense()" class="space-y-4">
      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700"
          >Fecha de Egreso <span class="text-red-500">*</span></label
        >
        <input
          type="date"
          [(ngModel)]="selectedExpense.payment_date"
          name="payment_date"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>

      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700"
          >Categoría <span class="text-red-500">*</span></label
        >
        <select
          [(ngModel)]="selectedExpense.category"
          (change)="onCategoryChange($event)"
          name="category"
          class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        >
          <option value="" disabled selected>Seleccione...</option>
          <option
            *ngFor="let cat of getAllCategories()"
            [value]="cat"
          >
            {{ getCategoryLabel(cat) }}
          </option>
          <option value="NEW_CATEGORY_OPTION" class="font-bold text-blue-600">
            + Nueva categoría
          </option>
        </select>
      </div>
      <div
        *ngIf="categoryJustAdded"
        class="mt-2 text-sm font-semibold text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2 animate-fadeIn"
      >
        Categoría <span class="font-bold">{{ selectedExpense.category }}</span> seleccionada
      </div>
      <div
        *ngIf="isNewCategoryMode"
        class="bg-blue-50 p-4 rounded-md border border-blue-200 space-y-2 mt-2"
      >
        <label class="block text-sm font-medium text-blue-800">
          Nueva Categoría
        </label>

        <div class="flex gap-2">
          <input
            type="text"
            [(ngModel)]="newCategory"
            name="new_category"
            placeholder="Ej: Seguros, Honorarios, Fletes"
            class="form-input w-full text-sm rounded-md"
          />
          <button
            type="button"
            class="btn-primary text-sm px-3"
            (click)="confirmNewCategory()"
          >
            Usar
          </button>
        </div>
      </div>
      <!-- Tipo de Servicio (solo para SERVICES) -->
      <div
        *ngIf="isServiceCategory"
        class="bg-yellow-50 p-4 rounded-md border border-yellow-200 space-y-3 mt-2"
      >
        <h3 class="font-semibold text-yellow-800 text-sm">Tipo de Servicio</h3>

        <!-- Selector -->
        <select
          [(ngModel)]="selectedExpense.service_type"
          name="service_type"
          class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"
        >
          <option value="" disabled>Seleccione tipo de servicio</option>
          <option *ngFor="let s of getServiceTypes()" [value]="s">
            {{ s }}
          </option>
        </select>

        <!-- Crear nuevo -->
        <div class="flex gap-2 mt-2">
          <input
            type="text"
            [(ngModel)]="newServiceType"
            name="new_service_type"
            placeholder="Nuevo tipo de servicio (Ej: Gas)"
            class="form-input w-full text-sm rounded-md"
          />
          <button
            type="button"
            class="btn-primary text-sm px-3"
            (click)="confirmNewServiceType()"
          >
            Usar
          </button>
        </div>
      </div>

      <!-- SOLO PARA SUPPLIES -->
      <div
        *ngIf="isSupplierCategory"
        class="bg-blue-50 p-4 rounded-md border border-blue-200 space-y-3 mt-2"
      >
        <h3 class="font-semibold text-blue-800 text-sm">
          Proveedor
        </h3>

        <div>
          <label class="block text-sm font-medium text-gray-700">
            Seleccionar proveedor
          </label>
          <select
            [(ngModel)]="selectedExpense.id_provider"
            (change)="onProviderChange($event)"
            name="id_provider"
            class="form-select mt-1 block w-full rounded-md border-gray-300"
          >
            <option value="" disabled>Seleccione un proveedor</option>
            <option value="NEW_PROVIDER_OPTION" class="font-bold text-blue-600">
              + Nuevo Proveedor
            </option>
            <option disabled>----------------</option>
            <option
              *ngFor="let prov of providersList"
              [value]="prov.id_provider"
            >
              {{ prov.company_name || prov.name }} ({{ prov.document_number }})
            </option>
          </select>
        </div>

        <div
          *ngIf="isNewProviderMode"
          class="pl-2 border-l-2 border-blue-400 space-y-2"
        >
          <input
            type="text"
            [(ngModel)]="newProviderData.company_name"
            name="new_company"
            placeholder="Nombre Empresa / Razón Social"
            class="form-input w-full text-sm rounded-md"
          />
          <div class="flex gap-2">
            <input
              type="text"
              [(ngModel)]="newProviderData.name"
              name="new_name"
              placeholder="Nombre Contacto"
              class="form-input w-1/2 text-sm rounded-md"
            />
            <input
              type="text"
              [(ngModel)]="newProviderData.document_number"
              name="new_doc"
              placeholder="NIT / Cédula"
              class="form-input w-1/2 text-sm rounded-md"
            />
          </div>

          <input
            type="text"
            [(ngModel)]="newProviderData.phone_number"
            name="new_phone"
            placeholder="Teléfono"
            class="form-input w-full text-sm rounded-md"
          />
        </div>
      </div>

      <!-- PARA CUALQUIER CATEGORÍA QUE NO SEA SUPPLIES -->
      <div
        *ngIf="selectedExpense.category && !isSupplierCategory"
        class="bg-gray-50 p-4 rounded-md border border-gray-200 space-y-2 mt-2"
      >
        <h3 class="font-semibold text-gray-700 text-sm">
          Pagado a
        </h3>
        <small *ngIf="thirdPartySuggestions.length === 0 && selectedExpense.provider_name">
          Se guardará como nuevo tercero
        </small>

        <input
          type="text"
          [(ngModel)]="selectedExpense.provider_name"
          name="provider_name"
          placeholder="Nombre de la persona o entidad"
          class="form-input w-full rounded-md text-sm"
          (input)="onThirdPartyInput()"
          autocomplete="off"
        />

        <ul
          *ngIf="thirdPartySuggestions.length > 0"
          class="absolute z-[9999] w-full bg-white border rounded shadow max-h-40 overflow-y-auto mt-1"
        >
          <li
            *ngFor="let name of thirdPartySuggestions"
            class="p-2 cursor-pointer hover:bg-gray-100"
            (click)="selectThirdParty(name)"
          >
            {{ name }}
          </li>
        </ul>
      </div>

      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700">
          Método de Pago
        </label>
        <select
          [(ngModel)]="selectedExpense.type"
          name="type"
          class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        >
          <option value="" disabled>Seleccione un método</option>
          <option value="cash">Efectivo</option>
          <option value="nequi">Nequi</option>
          <option value="bancolombia">Bancolombia</option>
          <option value="davivienda">Davivienda</option>
          <option value="transfer">Transferencia</option>
        </select>
      </div>

      <div class="modal-input-item">
        <label for="description">Anotación</label>
        <textarea
          [(ngModel)]="selectedExpense.description"
          name="description"
          rows="2"
          class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        ></textarea>
      </div>

      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700">Costo</label>
        <input
          type="number"
          [(ngModel)]="selectedExpense.cost"
          name="cost"
          step="0.01"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>
      <div
        class="bg-gray-50 p-4 rounded-md border border-gray-200 mt-4 space-y-4"
      >
        <h3 class="font-semibold text-gray-800 text-sm">Adjuntos</h3>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Factura / Recibo</label
          >
          <div class="flex items-center gap-2">
            <input
              type="file"
              (change)="onInvoiceFileSelected($event)"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            <button
              *ngIf="selectedExpense.invoice_file_path"
              type="button"
              (click)="downloadFile(selectedExpense.invoice_file_path)"
              class="text-blue-600 hover:text-blue-800 text-sm font-bold flex items-center gap-1"
              title="Descargar Factura Actual"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                />
              </svg>
              Ver
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Comprobante de Pago</label
          >
          <div class="flex items-center gap-2">
            <input
              type="file"
              (change)="onProofFileSelected($event)"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
            />
            <button
              *ngIf="selectedExpense.proof_of_payment_path"
              type="button"
              (click)="downloadFile(selectedExpense.proof_of_payment_path)"
              class="text-green-600 hover:text-green-800 text-sm font-bold flex items-center gap-1"
              title="Descargar Comprobante Actual"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 9.75v10.5m0 0 4.5-4.5M12 20.25l-4.5-4.5M12 3v9"
                />
              </svg>
              Ver
            </button>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 p-3 rounded border border-gray-200 mt-4">
        <div class="flex gap-4 items-center">
          <span class="text-sm font-bold text-gray-700">Estado de Pago:</span>

          <label class="inline-flex items-center cursor-pointer">
            <input
              type="radio"
              class="form-radio text-green-600"
              name="payment_status"
              value="PAID"
              [(ngModel)]="selectedExpense.payment_status"
              (change)="onStatusChange($event)"
            />
            <span class="ml-2 text-sm">Pagado</span>
          </label>

          <label class="inline-flex items-center cursor-pointer">
            <input
              type="radio"
              class="form-radio text-red-600"
              name="payment_status"
              value="PENDING"
              [(ngModel)]="selectedExpense.payment_status"
              (change)="onStatusChange($event)"
            />
            <span class="ml-2 text-sm">Pendiente</span>
          </label>
        </div>
        <div
          *ngIf="selectedExpense.payment_status === 'PENDING'"
          class="mt-3 animate-fadeIn"
        >
          <label class="block text-sm font-medium text-red-700"
            >Fecha Límite de Pago <span class="text-red-500">*</span></label
          >
          <input
            type="date"
            [(ngModel)]="selectedExpense.payment_due_date"
            name="payment_due_date"
            class="form-input mt-1 block w-full rounded-md border-red-300 focus:ring-red-500"
            required
          />
          <p class="text-xs text-red-500 mt-1 font-semibold">
            Se generará alerta 1 día antes y el mismo día.
          </p>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t mt-4">
        <button
          type="button"
          class="btn-danger px-4 py-2"
          (click)="closeModal()"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="btn-success px-4 py-2"
          [disabled]="isSaving"
        >
           {{ submitButtonText }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Detalles -->
<div *ngIf="showDetailsModal" class="modal-overlay">
  <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl modal-h550 overflow-y-auto">

    <div class="flex justify-between items-start mb-4 border-b pb-2">
      <h2 class="text-xl font-bold text-gray-800">
        Detalle de Egreso
      </h2>
      <button (click)="closeDetailsModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Fecha</label>
          <p class="text-gray-900">{{ selectedExpense.payment_date | date : "fullDate" }}</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Costo</label>
          <p class="text-xl font-mono font-bold text-gray-900">{{ selectedExpense.cost | currency }}</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Categoría</label>
          <span class="inline-block bg-gray-100 rounded px-2 py-1 text-sm font-semibold text-gray-700">
            {{ getCategoryLabel(selectedExpense.category) }}
            <span *ngIf="selectedExpense.service_type"> - {{selectedExpense.service_type}}</span>
          </span>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase">Método de Pago</label>
          <p class="text-gray-900">
            {{
              selectedExpense.type === 'cash' ? 'Efectivo' :
              selectedExpense.type === 'nequi' ? 'Nequi' :
              selectedExpense.type === 'bancolombia' ? 'Bancolombia' :
              selectedExpense.type === 'davivienda' ? 'Davivienda' :
              selectedExpense.type === 'transfer' ? 'Transferencia'
              : 'Ninguno'
            }}
          </p>
        </div>
      </div>

      <div *ngIf="selectedExpense.provider_name" class="bg-blue-50 p-3 rounded border border-blue-100">
        <label class="block text-xs font-bold text-blue-500 uppercase">Tercero</label>
        <p class="text-blue-900 font-medium">{{ selectedExpense.provider_name }}</p>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase">Anotación / Descripción</label>
        <div class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800 whitespace-pre-wrap">
          {{ selectedExpense.description }}
        </div>
      </div>

      <div class="flex items-center gap-2 mt-2">
        <label class="block text-xs font-bold text-gray-500 uppercase">Estado:</label>
        <span class="px-2 py-1 text-xs font-bold rounded"
          [ngClass]="{'bg-green-100 text-green-700': selectedExpense.payment_status === 'PAID', 'bg-red-100 text-red-700': selectedExpense.payment_status === 'PENDING'}">
          {{ selectedExpense.payment_status === 'PAID' ? 'PAGADO' : 'PENDIENTE' }}
        </span>
        <span *ngIf="selectedExpense.payment_status === 'PENDING'" class="text-xs text-red-500 font-semibold">
          (Vence: {{ selectedExpense.payment_due_date | date: 'dd/MM/yyyy' }})
        </span>
      </div>

      <div class="border-t pt-4 mt-4">
        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
             <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
           </svg>
           Adjuntos
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div class="border rounded p-3 flex items-center justify-between bg-gray-50">
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold text-gray-600">Factura / Recibo</span>
            </div>
            <button
              *ngIf="selectedExpense.invoice_file_path"
              (click)="downloadFile(selectedExpense.invoice_file_path)"
              class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
            >
              Descargar
            </button>
            <span *ngIf="!selectedExpense.invoice_file_path" class="text-xs text-gray-400 italic">No adjuntado</span>
          </div>

          <div class="border rounded p-3 flex items-center justify-between bg-gray-50">
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold text-gray-600">Comprobante Pago</span>
            </div>
            <button
              *ngIf="selectedExpense.proof_of_payment_path"
              (click)="downloadFile(selectedExpense.proof_of_payment_path)"
              class="btn-primary text-xs px-3 py-1 flex items-center gap-1"
            >
              Descargar
            </button>
            <span *ngIf="!selectedExpense.proof_of_payment_path" class="text-xs text-gray-400 italic">No adjuntado</span>
          </div>

        </div>
      </div>

    </div>

    <div class="flex justify-end mt-6">
      <button class="btn-primary px-6" (click)="closeDetailsModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Gestión de Abonos -->
<div *ngIf="showPaymentModal && selectedExpenseForPayment" class="modal-overlay">
  <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl modal-h550 overflow-y-auto">
    <div class="flex justify-between items-start mb-4 border-b pb-2">
      <h2 class="text-xl font-bold text-gray-800">
        Gestión de Abonos - {{ getCategoryLabel(selectedExpenseForPayment.category) }}
      </h2>
      <button (click)="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Resumen del Egreso -->
    <div class="bg-gray-50 p-4 rounded-md mb-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-xs font-bold text-gray-500 uppercase">Total del Egreso</p>
          <p class="text-2xl font-mono font-bold text-gray-900">{{ selectedExpenseForPayment.cost | currency }}</p>
        </div>
        <div>
          <p class="text-xs font-bold text-gray-500 uppercase">Total Pagado</p>
          <p class="text-2xl font-mono font-bold text-green-600">{{ getTotalPayments(selectedExpenseForPayment) | currency }}</p>
        </div>
        <div class="col-span-2">
          <p class="text-xs font-bold text-gray-500 uppercase">Saldo Pendiente</p>
          <p class="text-2xl font-mono font-bold text-red-600">{{ getRemainingBalance(selectedExpenseForPayment) | currency }}</p>
        </div>
      </div>
    </div>

    <!-- Formulario para Agregar Abono -->
    <div
      class="bg-blue-50 p-4 rounded-md mb-4"
      *ngIf="getRemainingBalance(selectedExpenseForPayment) > 0 &&
            (selectedExpenseForPayment.payment_status !== 'PAID' ||
            (selectedExpenseForPayment.payments && selectedExpenseForPayment.payments.length > 0))"
    >
      <h3 class="font-bold text-blue-800 mb-3">Agregar Nuevo Abono</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">Monto del Abono</label>
          <input
            type="number"
            [(ngModel)]="newPaymentAmount"
            [max]="getRemainingBalance(selectedExpenseForPayment)"
            min="0"
            step="100"
            class="form-input mt-1 block w-full rounded-md"
            placeholder="Ingrese el monto"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Método de Pago</label>
          <select
            [(ngModel)]="newPaymentMethod"
            class="form-select mt-1 block w-full rounded-md"
          >
            <option value="" disabled>Seleccione un método</option>
            <option value="cash">Efectivo</option>
            <option value="nequi">Nequi</option>
            <option value="bancolombia">Bancolombia</option>
            <option value="davivienda">Davivienda</option>
            <option value="transfer">Transferencia</option>
          </select>
        </div>
        <button
          type="button"
          class="btn-success w-full"
          (click)="addPayment(selectedExpenseForPayment, newPaymentAmount)"
          [disabled]="!newPaymentAmount || newPaymentAmount <= 0 || !newPaymentMethod"
        >
          Registrar Abono
        </button>
      </div>
    </div>

    <!-- Mensaje cuando está pagado SIN abonos previos -->
    <div
      *ngIf="selectedExpenseForPayment.payment_status === 'PAID' && (!selectedExpenseForPayment.payments || selectedExpenseForPayment.payments.length === 0)"
      class="bg-green-50 p-4 rounded-md mb-4 border border-green-200"
    >
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-green-600">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        <div>
          <h3 class="font-bold text-green-800">Egreso Pagado Completo</h3>
          <p class="text-sm text-green-700">Este egreso fue marcado como pagado sin necesidad de abonos parciales.</p>
        </div>
      </div>
    </div>


    <!-- Lista de Abonos Registrados -->
    <div class="border-t pt-4">
      <h3 class="font-bold text-gray-800 mb-3">Historial de Abonos</h3>
      <div *ngIf="!selectedExpenseForPayment.payments || selectedExpenseForPayment.payments.length === 0" class="text-center text-gray-500 py-4">
        No hay abonos registrados
      </div>
      <div *ngIf="selectedExpenseForPayment.payments && selectedExpenseForPayment.payments.length > 0" class="space-y-2">
        <div
          *ngFor="let payment of selectedExpenseForPayment.payments"
          class="flex items-center justify-between p-3 bg-gray-50 rounded-md border"
        >
          <div class="flex-1">
            <p class="font-mono font-bold text-gray-900">{{ payment.amount | currency }}</p>
            <p class="text-xs text-gray-600">
              {{ payment.payment_date | date : 'dd/MM/yyyy HH:mm' }}
              <span *ngIf="payment.payment_method"> - {{
                payment.payment_method === 'cash' ? 'Efectivo' :
                payment.payment_method === 'nequi' ? 'Nequi' :
                payment.payment_method === 'bancolombia' ? 'Bancolombia' :
                payment.payment_method === 'davivienda' ? 'Davivienda' :
                payment.payment_method === 'transfer' ? 'Transferencia' :
                payment.payment_method
              }}</span>
            </p>
          </div>
          <div class="flex gap-2">
            <button
              class="btn-edit text-xs px-2 py-1"
              (click)="openEditPaymentModal(payment)"
            >
              Editar
            </button>
            <button
              class="btn-delete text-xs px-2 py-1"
              (click)="deletePayment(payment.id_expense_payment!, selectedExpenseForPayment.id_expenses)"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="flex justify-end mt-6">
      <button class="btn-primary px-6" (click)="closePaymentModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Edición de Abono -->
<div *ngIf="showEditPaymentModal && selectedPayment" class="modal-overlay">
  <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Editar Abono</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Monto</label>
        <input
          type="number"
          [(ngModel)]="selectedPayment.amount"
          min="0"
          step="100"
          class="form-input mt-1 block w-full rounded-md"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Método de Pago</label>
        <select
          [(ngModel)]="selectedPayment.payment_method"
          class="form-select mt-1 block w-full rounded-md"
        >
          <option value="" disabled>Seleccione un método</option>
          <option value="cash">Efectivo</option>
          <option value="nequi">Nequi</option>
          <option value="bancolombia">Bancolombia</option>
          <option value="davivienda">Davivienda</option>
          <option value="transfer">Transferencia</option>
        </select>
      </div>
      <div class="flex justify-end gap-3">
        <button class="btn-danger" (click)="closeEditPaymentModal()">Cancelar</button>
        <button class="btn-success" (click)="updatePayment()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Notificación Toast -->
<div
  *ngIf="notificationMessage"
  class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fadeIn"
>
  {{ notificationMessage }}
</div>

