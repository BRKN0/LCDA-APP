<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando egresos...</p>
</div>
<div class="flex justify-between items-center mb-4 mt-4 ml-2">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 mt-4 ml-2 gap-4 pr-4"
  >
    <div class="flex flex-wrap gap-4">
      <label
        class="flex items-center cursor-pointer"
        *ngFor="let category of uniqueCategories"
      >
        <input
          type="checkbox"
          [(ngModel)]="categoryCheckboxes[category]"
          (change)="onCheckboxChange(category)"
          class="form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500"
        />
        <span class="ml-2 text-sm">{{ getCategoryLabel(category) }}</span>
      </label>
    </div>
  </div>
  <div class="flex space-x-2">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="addNewExpense()"
    >
      <svg
        class="w-5 h-5 inline-block"
        viewBox="0 0 24 24"
        fill="none"
        stroke="white"
        stroke-width="2"
      >
        <path d="M12 5v14M5 12h14" />
      </svg>
      <span>Añadir</span>
    </button>
    <button class="btn-details" (click)="generateExpensesKardex()">
      Generar Kardex
    </button>
    <button class="btn-clear" (click)="clearFilters()">Limpiar</button>
  </div>
</div>
<div class="flex items-center space-x-4">
  <div>
    <label for="startDate" class="mr-2 font-semibold">Desde:</label>
    <input
      type="date"
      id="startDate"
      [(ngModel)]="startDate"
      (ngModelChange)="applyFilters()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
    <input
      type="date"
      id="endDate"
      [(ngModel)]="endDate"
      (ngModelChange)="applyFilters()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
</div>

<!-- Tabla -->
<div class="mt-4 overflow-x-auto">
  <table class="table-std w-full">
    <thead>
      <tr>
        <th class="table-column-std">Fecha</th>
        <th class="table-column-std">Categoría</th>
        <th class="table-column-std">Proveedor</th>
        <th class="table-column-std">Anotación</th>
        <th class="table-column-std">Costo</th>
        <th class="table-column-std">Tipo Pago</th>
        <th class="table-column-std">Estado</th>
        <th class="table-column-std">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let expense of paginatedExpenses" class="hover:bg-gray-50">
        <td class="px-4 py-2 border-b">
          {{ expense.payment_date | date : "dd-MM-yyyy" }}
        </td>

        <td class="px-4 py-2 border-b">
          {{ getCategoryLabel(expense.category) }}
        </td>
        <td class="px-4 py-2 border-b text-sm text-gray-600">
          {{ expense.provider_name || "NO APLICA" }}
        </td>
        <td class="px-4 py-2 border-b">{{ expense.description }}</td>
        <td class="px-4 py-2 border-b text-right font-mono">
          {{ expense.cost | currency }}
        </td>
        <td class="px-4 py-2 border-b">{{ expense.type }}</td>

        <td class="px-4 py-2 border-b text-center">
          <div class="flex items-center justify-start gap-2">
            <input
              type="checkbox"
              [checked]="expense.payment_status === 'PAID'"
              (change)="toggleExpenseStatus(expense)"
              class="w-4 h-4 text-green-600 rounded border-gray-300 cursor-pointer focus:ring-green-500"
            />
            <span
              class="text-xs font-bold"
              [ngClass]="{
                'text-green-600': expense.payment_status === 'PAID',
                'text-red-500': expense.payment_status === 'PENDING'
              }"
            >
              {{ expense.payment_status === "PAID" ? "Pagado" : "Pendiente" }}
            </span>
          </div>
          <div
            *ngIf="
              expense.payment_status === 'PENDING' && expense.payment_due_date
            "
            class="text-xs text-red-400 mt-1 text-left"
          >
            Vence: {{ expense.payment_due_date | date : "dd-MM-yyyy" }}
          </div>
        </td>

        <td class="px-4 py-2 border-b">
          <div class="flex gap-2">
            <button
              class="btn-edit text-xs px-2 py-1"
              (click)="editExpense(expense)"
            >
              Editar
            </button>
            <button
              class="btn-delete text-xs px-2 py-1"
              (click)="deleteExpense(expense)"
            >
              Eliminar
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8656;
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700"
      >Página {{ currentPage }} de {{ totalPages }}</span
    >
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8658;
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedExpenses()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Modal para añadir/editar egresos -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content modal-h600">
    <h2 class="text-lg font-bold mb-4">
      {{ isEditing ? "Editar Egreso" : "Añadir Nuevo Egreso" }}
    </h2>

    <!-- Formulario -->
    <form (ngSubmit)="saveExpense()" class="space-y-4">
      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700"
          >Fecha de Egreso <span class="text-red-500">*</span></label
        >
        <input
          type="date"
          [(ngModel)]="selectedExpense.payment_date"
          name="payment_date"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>

      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700"
          >Categoría <span class="text-red-500">*</span></label
        >
        <select
          [(ngModel)]="selectedExpense.category"
          (change)="onCategoryChange($event)"
          name="category"
          class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        >
          <option value="" disabled selected>Seleccione...</option>
          <option *ngFor="let cat of standardCategories" [value]="cat.value">
            {{ cat.label }}
          </option>
        </select>
      </div>

      <div
        *ngIf="selectedExpense.category === 'SUPPLIES'"
        class="bg-blue-50 p-4 rounded-md border border-blue-200 space-y-3 mt-2"
      >
        <h3 class="font-semibold text-blue-800 text-sm">
          Detalles del Proveedor
        </h3>

        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Proveedor</label
          >
          <select
            [ngModel]="
              isNewProviderMode
                ? 'NEW_PROVIDER_OPTION'
                : selectedExpense.id_provider
            "
            (change)="onProviderChange($event)"
            name="id_provider"
            class="form-select mt-1 block w-full rounded-md border-gray-300"
            [disabled]="isEditing && !isNewProviderMode"
          >
            <option value="" disabled>Seleccione un proveedor</option>
            <option value="NEW_PROVIDER_OPTION" class="font-bold text-blue-600">
              + Nuevo Proveedor
            </option>
            <option disabled>----------------</option>
            <option
              *ngFor="let prov of providersList"
              [value]="prov.id_provider"
            >
              {{ prov.company_name || prov.name }} ({{ prov.document_number }})
            </option>
          </select>
        </div>

        <div
          *ngIf="isNewProviderMode"
          class="pl-2 border-l-2 border-blue-400 space-y-2"
        >
          <div>
            <input
              type="text"
              [(ngModel)]="newProviderData.company_name"
              name="new_company"
              placeholder="Nombre Empresa / Razón Social"
              class="form-input w-full text-sm rounded-md"
            />
          </div>
          <div class="flex gap-2">
            <input
              type="text"
              [(ngModel)]="newProviderData.name"
              name="new_name"
              placeholder="Nombre Contacto"
              class="form-input w-1/2 text-sm rounded-md"
            />
            <input
              type="text"
              [(ngModel)]="newProviderData.document_number"
              name="new_doc"
              placeholder="NIT / Cédula"
              class="form-input w-1/2 text-sm rounded-md"
            />
          </div>
          <div>
            <input
              type="text"
              [(ngModel)]="newProviderData.phone_number"
              name="new_phone"
              placeholder="Teléfono"
              class="form-input w-full text-sm rounded-md"
            />
          </div>
        </div>
      </div>

      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700"
          >Tipo de Pago</label
        >
        <input
          type="text"
          [(ngModel)]="selectedExpense.type"
          name="type"
          placeholder="Ej: Efectivo, Transferencia"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>

      <div class="modal-input-item">
        <label for="description">Anotación</label>
        <textarea
          [(ngModel)]="selectedExpense.description"
          name="description"
          rows="2"
          class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        ></textarea>
      </div>

      <div class="modal-input-item">
        <label class="block text-sm font-medium text-gray-700">Costo</label>
        <input
          type="number"
          [(ngModel)]="selectedExpense.cost"
          name="cost"
          step="0.01"
          class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          required
        />
      </div>

      <div class="bg-gray-50 p-3 rounded border border-gray-200 mt-4">
        <div class="flex gap-4 items-center">
          <span class="text-sm font-bold text-gray-700">Estado de Pago:</span>

          <label class="inline-flex items-center cursor-pointer">
            <input
              type="radio"
              class="form-radio text-green-600"
              name="payment_status"
              value="PAID"
              [(ngModel)]="selectedExpense.payment_status"
              (change)="onStatusChange($event)"
            />
            <span class="ml-2 text-sm">Pagado</span>
          </label>

          <label class="inline-flex items-center cursor-pointer">
            <input
              type="radio"
              class="form-radio text-red-600"
              name="payment_status"
              value="PENDING"
              [(ngModel)]="selectedExpense.payment_status"
              (change)="onStatusChange($event)"
            />
            <span class="ml-2 text-sm">Pendiente</span>
          </label>
        </div>

        <div
          *ngIf="selectedExpense.payment_status === 'PENDING'"
          class="mt-3 animate-fadeIn"
        >
          <label class="block text-sm font-medium text-red-700"
            >Fecha Límite de Pago <span class="text-red-500">*</span></label
          >
          <input
            type="date"
            [(ngModel)]="selectedExpense.payment_due_date"
            name="payment_due_date"
            class="form-input mt-1 block w-full rounded-md border-red-300 focus:ring-red-500"
            required
          />
          <p class="text-xs text-red-500 mt-1 font-semibold">
            Se generará alerta 1 día antes y el mismo día.
          </p>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t mt-4">
        <button
          type="button"
          class="btn-danger px-4 py-2"
          (click)="closeModal()"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="btn-success px-4 py-2"
          [disabled]="isSaving"
        >
          {{ isSaving ? "Guardando..." : isEditing ? "Actualizar" : "Guardar" }}
        </button>
      </div>
    </form>
  </div>
</div>
