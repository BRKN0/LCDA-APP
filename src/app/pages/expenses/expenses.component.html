<router-outlet></router-outlet>
<app-main-banner></app-main-banner>

<div *ngIf="loading" class="p-4 text-center text-gray-600">
  <p>Cargando egresos...</p>
</div>
<div class="flex justify-between items-center mb-4 mt-4 ml-2">
  <div class="flex flex-wrap gap-4">
    <label class="flex items-center" *ngFor="let category of uniqueCategories">
      <input
        type="checkbox"
        [(ngModel)]="categoryCheckboxes[category]"
        (click)="onCheckboxChange(category)"
        class="form-checkbox"
      />
      <span class="ml-2">{{ category }}</span>
    </label>
  </div>
  <div class="flex space-x-2 mr-4">
    <button
      class="btn-add inline-flex items-center space-x-2"
      (click)="addNewExpense()"
    >
      <svg
        class="w-5 h-5 inline-block align-middle mt-[3px]"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12.75 9C12.75 8.58579 12.4142 8.25 12 8.25C11.5858 8.25 11.25 8.58579 11.25 9L11.25 11.25H9C8.58579 11.25 8.25 11.5858 8.25 12C8.25 12.4142 8.58579 12.75 9 12.75H11.25V15C11.25 15.4142 11.5858 15.75 12 15.75C12.4142 15.75 12.75 15.4142 12.75 15L12.75 12.75H15C15.4142 12.75 15.75 12.4142 15.75 12C15.75 11.5858 15.4142 11.25 15 11.25H12.75V9Z"
          fill="#ffffff"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
          fill="#ffffff"
        />
      </svg>
      <span>Añadir</span>
    </button>
    <button class="btn-details" (click)="generateExpensesKardex()">
      Generar Kardex
    </button>
  </div>
</div>
<div class="flex items-center space-x-4">
  <div>
    <label for="startDate" class="mr-2 font-semibold">Desde:</label>
    <input
      type="date"
      id="startDate"
      [(ngModel)]="startDate"
      (ngModelChange)="applyFilters()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
  <div>
    <label for="endDate" class="mr-2 font-semibold">Hasta:</label>
    <input
      type="date"
      id="endDate"
      [(ngModel)]="endDate"
      (ngModelChange)="applyFilters()"
      class="border border-gray-300 rounded-md p-1"
    />
  </div>
</div>

<!-- Tabla -->
<div class="mt-4">
  <table class="table-std">
    <thead>
      <tr>
        <th class="table-column-std">Código</th>
        <th class="table-column-std">Fecha</th>
        <th class="table-column-std">Categoría</th>
        <th class="table-column-std">Tipo</th>
        <th class="table-column-std">Descripción</th>
        <th class="table-column-std">Costo</th>
        <th class="table-column-std">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let expense of paginatedExpenses">
        <td>{{ expense.code }}</td>
        <td>{{ expense.payment_date | date : "dd-MM-yyyy" }}</td>
        <td>{{ expense.category }}</td>
        <td>{{ expense.type }}</td>
        <td>{{ expense.description }}</td>
        <td>{{ expense.cost | currency }}</td>
        <td>
          <button class="btn-edit" (click)="editExpense(expense)">
            Editar
          </button>
          <button class="btn-delete" (click)="deleteExpense(expense)">
            Eliminar
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="flex justify-between items-center mb-4">
  <!-- Controles de paginación -->
  <div class="pagination flex items-center">
    <button
      (click)="currentPage = 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8656;
    </button>
    <button
      (click)="currentPage = currentPage - 1; updatePaginatedExpenses()"
      [disabled]="currentPage === 1"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      ←
    </button>
    <span class="mx-4 text-gray-700"
      >Página {{ currentPage }} de {{ totalPages }}</span
    >
    <button
      (click)="currentPage = currentPage + 1; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 text-gray-700 border rounded-full disabled:opacity-50 flex items-center justify-center w-7 h-7"
    >
      →
    </button>
    <button
      (click)="currentPage = totalPages; updatePaginatedExpenses()"
      [disabled]="currentPage === totalPages"
      class="px-2 py-1 border rounded-full disabled:opacity-50 flex items-center justify-center w-8 h-8"
    >
      &#8658;
    </button>
  </div>

  <!-- Selector de elementos por página -->
  <div class="items-per-page flex items-center">
    <label for="itemsPerPage" class="mr-2">Elementos por página:</label>
    <select
      id="itemsPerPage"
      [(ngModel)]="itemsPerPage"
      (change)="currentPage = 1; updatePaginatedExpenses()"
      class="border border-gray-300 rounded-md p-1"
    >
      <option *ngFor="let size of [2, 10, 15, 20]" [value]="size">
        {{ size }}
      </option>
    </select>
  </div>
</div>

<!-- Modal para añadir/editar egresos -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content modal-h600">
    <h2 class="text-lg font-bold mb-4">
      {{ isEditing ? "Editar Egreso" : "Añadir Nuevo Egreso" }}
    </h2>

    <!-- Formulario -->
    <form (ngSubmit)="saveExpense()">
      <div class="modal-input-item">
        <label for="payment_date"
          >Fecha<span class="text-red-500">*</span></label
        >
        <input
          type="date"
          id="payment_date"
          [(ngModel)]="selectedExpense.payment_date"
          name="payment_date"
          class="form-input"
          required
        />
      </div>

      <div class="modal-input-item">
        <label for="category"
          >Categoría<span class="text-red-500">*</span></label
        >
        <select
          id="category"
          [(ngModel)]="selectedExpense.category"
          name="category"
          class="form-select"
          (change)="onCategoryChange($event)"
          required
        >
          <option *ngFor="let category of uniqueCategories" [value]="category">
            {{ category }}
          </option>
          <option value="Otros">Otros</option>
        </select>
        <input
          *ngIf="showOtherCategoryInput"
          type="text"
          [(ngModel)]="otherCategory"
          placeholder="Especificar categoría"
          class="form-input mt-2"
          required
        />
      </div>

      <div class="modal-input-item">
        <label for="type">Tipo</label>
        <input
          type="text"
          id="type"
          [(ngModel)]="selectedExpense.type"
          name="type"
          class="form-input"
          required
        />
      </div>

      <div class="modal-input-item">
        <label for="description">Descripción</label>
        <textarea
          id="description"
          [(ngModel)]="selectedExpense.description"
          name="description"
          class="form-textarea"
          rows="3"
          required
        ></textarea>
      </div>

      <div class="modal-input-item">
        <label for="cost">Costo</label>
        <input
          type="number"
          id="cost"
          [(ngModel)]="selectedExpense.cost"
          name="cost"
          class="form-input"
          step="0.01"
          required
        />
      </div>

      <div class="modal-input-item">
        <label for="code">Código</label>
        <input
          type="number"
          id="code"
          [(ngModel)]="selectedExpense.code"
          name="code"
          class="form-input"
          required
        />
      </div>

      <!-- Botones -->
      <div class="flex justify-end items-center mt-5">
        <button type="button" class="btn-danger" (click)="closeModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-success">
          {{ isEditing ? "Actualizar Egreso" : "Añadir Egreso" }}
        </button>
      </div>
    </form>
  </div>
</div>
